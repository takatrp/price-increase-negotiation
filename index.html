<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>値上げ交渉ナビゲーター</title>

<link rel="icon" type="image/png" sizes="192x192" href="favicon192192.png">
<link rel="apple-touch-icon" sizes="192x192" href="favicon192192.png">
<link rel="shortcut icon" href="favicon192192.png">

<style>
:root{
  --brand:#578899;--ink:#1f2937;--muted:#6b7280;--bg:#f7fafc;--ok:#10b981;--warn:#ef4444;
  --card:#fff;--grid:#e5e7eb;--soft:rgba(87,136,153,.10);
}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
.header{display:flex;align-items:center;gap:12px;margin:6px 0 8px}
.logo{height:56px;width:auto;object-fit:contain;border-radius:8px}
.title{font-weight:900;font-size:1.22rem;color:#0f172a;display:flex;align-items:center;gap:8px}
.headRight{margin-left:auto;display:flex;gap:6px;align-items:center}
.sub{font-size:.86rem;color:var(--muted);margin:0 0 12px}

.card{background:var(--card);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px;margin-bottom:12px}
.pill{display:inline-block;background:var(--soft);color:var(--brand);font-weight:900;border-radius:999px;padding:5px 9px;font-size:.82rem;margin-bottom:10px}
label{display:block;font-size:.86rem;color:#374151;margin:12px 0 6px;font-weight:800}
input[type="text"],input[type="month"],textarea,select{
  width:100%;box-sizing:border-box;border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:1rem;background:#fff;outline:none;
  transition: background-color .2s,border-color .2s,color .2s;
}
input:focus,textarea:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(87,136,153,.15)}
input::placeholder,textarea::placeholder{color:#c7ccd3}
.hint{font-size:.78rem;color:var(--muted);margin-top:4px}
.danger{color:var(--warn);font-weight:900;margin-top:8px}

.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 12px;font-weight:900;font-size:.92rem;cursor:pointer;transition: opacity .2s;}
.btn:hover{opacity:.9}
.btn.alt{background:#e5e7eb;color:#111827}
.btn.ghost{background:transparent;color:#374151;border:1px solid #d1d5db}
.btn.sm{padding:6px 8px;font-size:.82rem;border-radius:8px}
.miniActions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}

.inputGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:520px){.inputGrid{grid-template-columns:1fr}}

.dashboard{display:block}
.colL,.colR{display:flex;flex-direction:column;gap:10px}
@media (min-width:1024px){.dashboard{display:grid;grid-template-columns:420px 1fr;gap:12px;align-items:start}}

.tabs{display:flex;border-bottom:2px solid #e5e7eb;margin-bottom:12px}
.tab{padding:8px 16px;font-size:.9rem;font-weight:900;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px}
.tab.active{color:var(--brand);border-bottom-color:var(--brand)}
.docArea{min-height:420px;line-height:1.65;font-family:inherit;resize:vertical;background:#f8fafc}
.statusMsg{font-size:0.85rem;color:var(--ok);font-weight:900;margin-left:auto;opacity:0;transition:opacity .25s;}
.statusMsg.show{opacity:1;}

.mk-mini{margin:16px auto 10px;max-width:1100px;color:#374151;font-size:.84rem;text-align:center}
.mk-mini a{color:inherit;text-decoration:underline}
.note{font-size:.8rem;color:#6b7280;text-align:center;margin-bottom:24px}

/* チップ */
.chipGroup{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;margin-bottom:4px}
.chip{border:1px solid #d1d5db;background:#fff;border-radius:999px;padding:8px 12px;font-size:.85rem;font-weight:900;color:#374151;cursor:pointer;transition:all .2s;line-height:1.1}
.chip:hover{background:#f3f4f6}
.chip.active{border-color:var(--brand);background:#eef6fa;color:#0f172a}

/* 参考データパネル */
.dataPanel{border:1px solid #e5e7eb;border-radius:12px;background:#fafafa;padding:10px 12px;margin-top:10px}
.dataRow{display:flex;gap:10px;flex-wrap:wrap;font-size:.88rem;color:#111827;align-items:center}
.dataKey{color:#475569;font-weight:900}
.badge{display:inline-block;border:1px solid #d1d5db;border-radius:999px;padding:2px 8px;font-size:.72rem;color:#334155;background:#fff}
.badge.ok{border-color:#94a3b8;color:#0f172a}
.badge.warn{border-color:#f59e0b;color:#92400e;background:#fff7ed}
.badge.err{border-color:#ef4444;color:#991b1b;background:#fff5f5}
.small{font-size:.78rem;color:#64748b}
.divider{height:1px;background:#e5e7eb;margin:12px 0}

/* インポートハイライト */
input.imported-value, select.imported-value, textarea.imported-value{
  background-color:#fff9e6 !important;border-color:#f2c94c !important;color:var(--warn);font-weight:900;
}
.importStatus{margin:8px 0 0;font-size:.82rem;color:#0f172a;background:#eef6fa;border:1px solid #d6eaf3;border-radius:10px;padding:8px 10px;display:none}
.importStatus.show{display:block}

/* details */
details{border:1px solid #e5e7eb;border-radius:12px;background:#ffffff;padding:10px 12px;margin-top:10px}
summary{cursor:pointer;font-weight:900;color:#0f172a}
details[open]{background:#fcfeff}
.mutedBox{margin-top:8px;border:1px dashed #cbd5e1;background:#f8fafc;border-radius:12px;padding:10px}
pre.sample{white-space:pre-wrap;margin:0;font-size:.78rem;color:#334155}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  font-size:.78rem;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:8px;padding:2px 6px}

/* 管理モード：adminOnly を表示 */
.adminOnly{display:none !important;}
.isAdmin .adminOnly{display:block !important;}

/* STEP1：累積物価上昇（概算）リンク */
.sourceLink{display:inline-flex;gap:6px;align-items:center;font-size:.78rem;margin-top:6px}
.sourceLink a{color:#0f172a;text-decoration:underline}
.sourceLink .badge{padding:2px 6px}

/* =========================
   印刷：本文と根拠メモを完全分離
   ========================= */
#printPack{display:none}
.printSection{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:14px;margin:0 0 12px}
.printH1{font-weight:900;font-size:1.05rem;margin:0 0 8px;color:#0f172a}
.printSub{font-size:.82rem;color:#475569;margin:0 0 10px}
.printText{white-space:pre-wrap;line-height:1.65;font-size:.92rem}

@media print{
  body{background:#fff}
  .wrap, footer, .note{display:none !important;}
  #printPack{display:block !important; padding:0; margin:0;}
  .printSection{border:none;border-radius:0;padding:0;margin:0}
  .printDivider{page-break-before:always;}
  .printH1{font-size:1.1rem}
  a{color:#000;text-decoration:underline}
}
</style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <a href="https://takatrp.github.io/tool-portal/" target="_blank" rel="noopener noreferrer">
      <img src="ロゴ.jpg" alt="ロゴ" class="logo" width="112" height="56">
    </a>
    <div class="title">値上げ交渉ナビゲーター <span class="badge ok">r09</span></div>
    <div class="headRight">
      <button class="btn ghost sm" id="resetBtn" type="button">リセット</button>
    </div>
  </div>
  <div class="sub">背景要因（外部データ＋事情）を整理し、本文（顧客向け）と根拠メモ（社内用）を生成します。</div>

  <div id="importStatus" class="importStatus" role="status" aria-live="polite"></div>

  <div class="dashboard">
    <div class="colL">

      <div class="card">
        <div class="pill">STEP 1：改定内容</div>

        <label for="productName">対象商品・サービス名</label>
        <input type="text" id="productName" placeholder="例）保守費用、〇〇部品" />

        <div class="inputGrid">
          <div>
            <label for="currentPrice">現在の単価（税抜）</label>
            <input type="text" id="currentPrice" inputmode="decimal" placeholder="例）1,200" />
          </div>
          <div>
            <label for="newPrice">改定後単価（税抜）</label>
            <input type="text" id="newPrice" inputmode="decimal" placeholder="例）1,320" />
          </div>
        </div>

        <div class="hint" id="rateHint">改定率：— ／ 差額：—</div>

        <div class="inputGrid" style="margin-top:8px;">
          <div>
            <label for="currentPriceAsOf">現行価格の決定時期（年月）</label>
            <input type="month" id="currentPriceAsOf" />
            <div class="hint">本文に自然に織り込めます（例：2024-04）。</div>
          </div>
          <div>
            <label for="effectiveDate">適用開始時期</label>
            <input type="text" id="effectiveDate" placeholder="例）2026年4月1日 ご注文分より" />
          </div>
        </div>

        <div class="dataPanel" style="margin-top:10px;">
          <div class="dataRow">
            <span class="dataKey">現行価格決定時→現在の物価上昇（概算）</span>
            <span id="cpiSinceView">—</span>
            <span class="badge warn" id="cpiSinceBadge">任意</span>
          </div>
          <div class="small">※実際の消費者物価指数（2020年基準）の推移データを用いた概算です。</div>
          <div class="sourceLink">
            <span class="badge">根拠</span>
            <a id="cpiSourceAnchor" href="#" target="_blank" rel="noopener">物価統計（出典リンク）</a>
            <span class="small" id="cpiSourceLabel"></span>
          </div>
        </div>

        <div id="validateMsg" class="danger" style="display:none;"></div>
      </div>

      <div class="card">
        <div class="pill">STEP 2：背景（外部要因＋根拠データ）</div>

        <label for="prefSelect">主な提供エリア（都道府県）</label>
        <select id="prefSelect" aria-label="都道府県選択"></select>

        <div class="dataPanel" aria-label="参考データ（最低賃金など）">
          <div class="dataRow">
            <span class="dataKey">最低賃金（参考）</span>
            <span id="minWageView">—</span>
            <span class="badge" id="minWageBadge">未取得</span>
          </div>
          <div class="small" id="minWageNote">※最低賃金はJSON優先（未読込時は内蔵値）。</div>
        </div>

        <div class="divider"></div>

        <div class="inputGrid">
          <div>
            <label for="cpiRate">物価上昇率（%） <span class="badge" id="cpiScopeBadge">—</span></label>
            <input type="text" id="cpiRate" inputmode="decimal" placeholder="例）2.0" />
            <div class="hint" id="cpiHint">—</div>
          </div>
          <div>
            <label for="wageRate">人件費上昇率（%） <span class="badge" id="wageScopeBadge">—</span></label>
            <input type="text" id="wageRate" inputmode="decimal" placeholder="例）4.6" />
            <div class="hint" id="wageHint">—</div>
          </div>
        </div>

        <div class="inputGrid">
          <div>
            <label for="cpiAsOf">物価データの対象</label>
            <input type="text" id="cpiAsOf" placeholder="例）2026年1月（前年同月比）" />
          </div>
          <div>
            <label for="wageAsOf">人件費データの対象</label>
            <input type="text" id="wageAsOf" placeholder="例）2025年春闘（中小）" />
          </div>
        </div>

        <details>
          <summary>詳細設定（連動/説明/JSON読込）</summary>

          <div class="mutedBox">
            <div class="dataRow">
              <span class="dataKey">都道府県変更に連動</span>
              <label style="display:flex;gap:10px;align-items:center;margin:0;font-weight:900;">
                <input type="checkbox" id="linkRates" checked style="width:auto;"> 連動する（推奨）
              </label>
              <span class="badge warn" id="linkNoteBadge">全国値が多い</span>
            </div>
            <div class="small" id="linkNoteText" style="margin-top:6px;">
              ※都道府県別の物価/賃金がJSONに無い場合は「全国値」を表示します（バッジで明記）。
              都道府県別で運用したい場合は pref_cost_data.json の prefs.[都道府県キー].cpi_yoy / wage_yoy を設定してください。
            </div>

            <div class="divider"></div>

            <label style="display:flex;gap:10px;align-items:center;margin:0;font-weight:900;">
              <input type="checkbox" id="embedNumbersInLetter" checked style="width:auto;"> 本文に根拠数値（%・最低賃金等）を自然に織り込み、末尾に参考データを付与する
            </label>
            <label style="display:flex;gap:10px;align-items:center;margin-top:8px;font-weight:900;">
              <input type="checkbox" id="includeCpiSinceInLetter" style="width:auto;"> 末尾の参考データに「累積の物価上昇（概算）」も入れる
            </label>

            <div class="divider"></div>

            <div class="small" style="font-weight:900;color:#0f172a;">説明（社内向け）</div>
            <div class="chipGroup" style="margin-top:6px;">
              <button class="chip" type="button" id="helpCpi">物価上昇率とは？</button>
              <button class="chip" type="button" id="helpWage">人件費上昇率とは？</button>
              <button class="chip" type="button" id="helpScope">都道府県別でない理由</button>
            </div>
            <div class="small" id="helpBox" style="margin-top:8px;line-height:1.6;color:#334155;"></div>
          </div>

          <details id="dataLoader" class="adminOnly">
            <summary>都道府県データを読み込み（JSON）</summary>
            <div class="hint">同階層の <span class="kbd">pref_cost_data.json</span> またはURLから読み込みます（物価/賃金/最低賃金など）。</div>

            <label for="dataUrl">JSONのURL（空欄なら ./pref_cost_data.json を試行）</label>
            <input type="text" id="dataUrl" placeholder="例）https://.../pref_cost_data.json" />

            <div class="miniActions">
              <button class="btn" id="loadDataBtn" type="button">読み込み</button>
              <button class="btn alt" id="clearDataBtn" type="button">読込解除</button>
              <span id="dataLoadStatus" class="small" aria-live="polite"></span>
            </div>

            <div class="mutedBox">
              <div class="small" style="margin-bottom:6px;"><b>JSONキー例（最小）</b></div>
              <pre class="sample" id="jsonSample"></pre>
            </div>
            <div class="small">※キーは「兵庫 / 鳥取 / 和歌山」等、都道府県名（都・道・府・県を除いた形）で入れてください。</div>
          </details>
        </details>

        <div class="divider"></div>

        <div class="hint">外部要因：該当するものを選択（複数可）</div>
        <div class="chipGroup" id="factorGroup">
          <button class="chip active" type="button" data-val="原材料・仕入コストの上昇">原材料・仕入</button>
          <button class="chip" type="button" data-val="物流費・運賃の上昇">物流</button>
          <button class="chip" type="button" data-val="エネルギー（電気・ガス・燃料）価格の上昇">エネルギー</button>
          <button class="chip active" type="button" data-val="人件費（賃上げ・採用難）による負担増">人件費</button>
          <button class="chip" type="button" data-val="最低賃金の改定（都道府県別）">最低賃金</button>
          <button class="chip" type="button" data-val="IT/サブスク費用の増加">IT/サブスク</button>
          <button class="chip" type="button" data-val="金利上昇・資金調達コスト増">金利</button>
        </div>

        <label for="extraFactors">補足（任意）</label>
        <textarea id="extraFactors" rows="2" placeholder="例）主要仕入先からの値上げ通知（+8%）、採用単価の上昇、燃料サーチャージ継続 等"></textarea>
        <div class="hint">※「自社に固有の事実」を一文入れると説得力が上がります。</div>
      </div>

      <div class="card">
        <div class="pill">STEP 3：文面のトーン</div>
        <div class="hint">相手に合わせて調整（1つ選択）</div>
        <div class="chipGroup" id="relationGroup">
          <button class="chip" type="button" data-val="A">信頼あり（共感・誠実）</button>
          <button class="chip active" type="button" data-val="B">標準（論理）</button>
          <button class="chip" type="button" data-val="C">価格に厳しい（データ・代替案）</button>
        </div>

        <details style="margin-top:10px;">
          <summary>自助努力（任意）</summary>
          <div class="hint">これまでの努力（複数可）</div>
          <div class="chipGroup" id="effortGroup">
            <button class="chip active" type="button" data-val="徹底した経費削減">経費削減</button>
            <button class="chip" type="button" data-val="業務のDX化・効率化">DX・効率化</button>
            <button class="chip" type="button" data-val="仕入先の見直し・統合">仕入先見直し</button>
            <button class="chip active" type="button" data-val="数年間にわたる価格据え置き">価格据え置き</button>
          </div>
        </details>
      </div>

    </div>

    <div class="colR">
      <div class="card">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:0;">
          <div class="pill">生成出力</div>
          <span id="copyStatus" class="statusMsg">コピーしました</span>
        </div>

        <div class="tabs" id="outputTabs" role="tablist" aria-label="出力切替">
          <div class="tab active" role="tab" aria-selected="true" tabindex="0" data-target="letter">案内文（顧客に渡す）</div>
          <div class="tab" role="tab" aria-selected="false" tabindex="-1" data-target="talk">面談トーク</div>
          <div class="tab" role="tab" aria-selected="false" tabindex="-1" data-target="memo">根拠メモ（社内用）</div>
        </div>

        <textarea id="outputArea" class="docArea" readonly></textarea>

        <div class="miniActions">
          <button class="btn" id="copyBtn" type="button">現在の表示をコピー</button>
          <button class="btn alt" id="printBtn" type="button">印刷（本文＋根拠メモ）</button>
        </div>
        <div class="hint" style="margin-top:8px;">※印刷は「本文」と「根拠メモ（社内用）」を明確に分けて出力します。</div>
      </div>
    </div>
  </div>
</div>

<div id="printPack">
  <div class="printSection">
    <div class="printH1">【お客さまにお渡しする本文】</div>
    <div class="printSub">※このページは顧客向け（根拠メモは次ページ）</div>
    <div class="printText" id="printLetter"></div>
  </div>

  <div class="printDivider"></div>

  <div class="printSection">
    <div class="printH1">【社内用：根拠メモ（カンニングペーパー）】</div>
    <div class="printSub">※お客さまには渡さない想定。根拠を問われた際の説明用。</div>
    <div class="printText" id="printMemo"></div>
  </div>
</div>

<footer class="mk-mini">
  © <span id="cpy-year">2026</span>
  <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener license">税理士法人松本会計事務所</a> ｜ 
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="license noopener">CC BY-NC-SA 4.0</a> ｜ 
  <a href="/tool-portal/terms.html" target="_blank" rel="noopener">利用条件</a> ｜ 
  <span id="build-rev">r09</span>（<span id="last-updated-date"></span>）
</footer>
<div class="note">本ツールは文面生成の補助です。最終判断は、取引実態・競合・需給・契約条項等も踏まえて行ってください。</div>

<script>
(function(){
  /* =========================
     0) 管理モード判定
     ========================= */
  const qs = new URLSearchParams(window.location.search);
  const IS_ADMIN = (qs.get('admin') === '1');
  try{ document.documentElement.classList.toggle('isAdmin', !!IS_ADMIN); }catch(e){}

  /* =========================
     1) 対象都道府県（JISコード順）
     ========================= */
  const PREFS = [
    {k:'北海道', l:'北海道'}, {k:'青森', l:'青森県'}, {k:'岩手', l:'岩手県'},
    {k:'宮城', l:'宮城県'}, {k:'秋田', l:'秋田県'}, {k:'山形', l:'山形県'},
    {k:'福島', l:'福島県'}, {k:'茨城', l:'茨城県'}, {k:'栃木', l:'栃木県'},
    {k:'群馬', l:'群馬県'}, {k:'埼玉', l:'埼玉県'}, {k:'千葉', l:'千葉県'},
    {k:'東京', l:'東京都'}, {k:'神奈川', l:'神奈川県'}, {k:'新潟', l:'新潟県'},
    {k:'富山', l:'富山県'}, {k:'石川', l:'石川県'}, {k:'福井', l:'福井県'},
    {k:'山梨', l:'山梨県'}, {k:'長野', l:'長野県'}, {k:'岐阜', l:'岐阜県'},
    {k:'静岡', l:'静岡県'}, {k:'愛知', l:'愛知県'}, {k:'三重', l:'三重県'},
    {k:'滋賀', l:'滋賀県'}, {k:'京都', l:'京都府'}, {k:'大阪', l:'大阪府'},
    {k:'兵庫', l:'兵庫県'}, {k:'奈良', l:'奈良県'}, {k:'和歌山', l:'和歌山県'},
    {k:'鳥取', l:'鳥取県'}, {k:'島根', l:'島根県'}, {k:'岡山', l:'岡山県'},
    {k:'広島', l:'広島県'}, {k:'山口', l:'山口県'}, {k:'徳島', l:'徳島県'},
    {k:'香川', l:'香川県'}, {k:'愛媛', l:'愛媛県'}, {k:'高知', l:'高知県'},
    {k:'福岡', l:'福岡県'}, {k:'佐賀', l:'佐賀県'}, {k:'長崎', l:'長崎県'},
    {k:'熊本', l:'熊本県'}, {k:'大分', l:'大分県'}, {k:'宮崎', l:'宮崎県'},
    {k:'鹿児島', l:'鹿児島県'}, {k:'沖縄', l:'沖縄県'}
  ];
  const PREF_LABEL = Object.fromEntries(PREFS.map(x=>[x.k,x.l]));

  // 既存内蔵データ
  const MIN_WAGE = {
    "兵庫": {n:1116,o:1052,inc:64,eff:"2025-10-04"},
    "鳥取": {n:1030,o:957,inc:73,eff:"2025-10-04"},
    "島根": {n:1033,o:962,inc:71,eff:"2025-11-17"},
    "滋賀": {n:1080,o:1017,inc:63,eff:"2025-10-05"},
    "京都": {n:1122,o:1058,inc:64,eff:"2025-11-21"},
    "大阪": {n:1177,o:1114,inc:63,eff:"2025-10-16"},
    "奈良": {n:1051,o:986,inc:65,eff:"2025-11-16"},
    "岡山": {n:1047,o:982,inc:65,eff:"2025-12-01"},
    "広島": {n:1085,o:1020,inc:65,eff:"2025-11-01"},
    "山口": {n:1043,o:979,inc:64,eff:"2025-10-16"}
  };

  const DEFAULT_CPI_SOURCE_URL = 'https://www.stat.go.jp/data/cpi/sokuhou/tsuki/pdf/doukou.pdf';
  const DEFAULT_CPI_SOURCE_LABEL = '（総務省統計局：物価統計）';

  /* --- ユーティリティ --- */
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const toNum = v => { const s = String(v||'').replace(/,/g,'').replace(/[^\d.-]/g,''); const n = parseFloat(s); return isFinite(n) ? n : NaN; };
  const yen = n => isFinite(n) ? new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY', maximumFractionDigits: 0 }).format(n) : '—';
  const pct1 = n => isFinite(n) ? (Math.round(n*10)/10).toFixed(1) : '';
  const z2 = n => String(n).padStart(2,'0');
  const fmtYMD = s => {
    if(!s) return '';
    const d = new Date(s);
    if(isNaN(d.getTime())) return String(s);
    return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;
  };
  const fmtYM = s => {
    if(!s) return '';
    const m = String(s).trim().match(/^(\d{4})-(\d{2})$/);
    if(!m) return String(s);
    return `${m[1]}年${parseInt(m[2],10)}月`;
  };
  const joinJa = (arr) => {
    const a = (arr||[]).filter(Boolean);
    if(a.length===0) return '';
    if(a.length===1) return a[0];
    if(a.length===2) return a[0] + "および" + a[1];
    return a.slice(0,-1).join("、") + "等";
  };

  /* --- DOM --- */
  const productName = $('#productName');
  const currentPrice = $('#currentPrice');
  const newPrice = $('#newPrice');
  const currentPriceAsOf = $('#currentPriceAsOf');
  const effectiveDate = $('#effectiveDate');
  const outputArea = $('#outputArea');
  const copyBtn = $('#copyBtn');
  const printBtn = $('#printBtn');
  const copyStatus = $('#copyStatus');
  const resetBtn = $('#resetBtn');
  const rateHint = $('#rateHint');
  const validateMsg = $('#validateMsg');
  const importStatusEl = $('#importStatus');

  const prefSelect = $('#prefSelect');
  const minWageView = $('#minWageView');
  const minWageBadge = $('#minWageBadge');
  const minWageNote = $('#minWageNote');

  const cpiRate = $('#cpiRate');
  const wageRate = $('#wageRate');
  const cpiAsOf = $('#cpiAsOf');
  const wageAsOf = $('#wageAsOf');

  const linkRates = $('#linkRates');
  const cpiScopeBadge = $('#cpiScopeBadge');
  const wageScopeBadge = $('#wageScopeBadge');
  const cpiHint = $('#cpiHint');
  const wageHint = $('#wageHint');

  const embedNumbersInLetter = $('#embedNumbersInLetter');
  const includeCpiSinceInLetter = $('#includeCpiSinceInLetter');

  const cpiSinceView = $('#cpiSinceView');
  const cpiSinceBadge = $('#cpiSinceBadge');

  const cpiSourceAnchor = $('#cpiSourceAnchor');
  const cpiSourceLabel = $('#cpiSourceLabel');

  // ヘルプ
  const helpCpi = $('#helpCpi');
  const helpWage = $('#helpWage');
  const helpScope = $('#helpScope');
  const helpBox = $('#helpBox');

  // 管理パネル
  const dataUrl = $('#dataUrl');
  const loadDataBtn = $('#loadDataBtn');
  const clearDataBtn = $('#clearDataBtn');
  const dataLoadStatus = $('#dataLoadStatus');
  const jsonSample = $('#jsonSample');

  const extraFactors = $('#extraFactors');

  const printLetter = $('#printLetter');
  const printMemo = $('#printMemo');

  let currentOutputMode = 'letter';

  document.addEventListener('input', (e) => {
    if(e.target && e.target.classList && e.target.classList.contains('imported-value')){
      e.target.classList.remove('imported-value');
    }
  });

  function showImportStatus(msg){
    if(!importStatusEl) return;
    importStatusEl.textContent = msg;
    importStatusEl.classList.add('show');
    clearTimeout(showImportStatus._t);
    showImportStatus._t = setTimeout(()=>importStatusEl.classList.remove('show'), 4200);
  }
  function markImported(el){ if(el) el.classList.add('imported-value'); }

  /* リアルタイムカンマ整形関数 */
  const formatYenRealtime = (e) => {
    const el = e.target;
    let raw = el.value.replace(/[^\d.-]/g, '');
    if(!raw) { el.value = ''; return; }
    
    // 現在のカーソル位置を取得
    let pos = el.selectionStart;
    let oldLen = el.value.length;

    let parts = raw.split('.');
    let intPart = parts[0];
    let decPart = parts.length > 1 ? '.' + parts[1] : '';

    if (intPart === '' || intPart === '-') {
      el.value = raw;
      return;
    }

    let num = parseInt(intPart, 10);
    if(isNaN(num)) return;
    
    let formatted = num.toLocaleString('ja-JP') + decPart;
    el.value = formatted;

    // フォーマット後のカーソル位置を調整
    let newLen = el.value.length;
    let diff = newLen - oldLen;
    try { el.setSelectionRange(pos + diff, pos + diff); } catch(err){}
  };

  currentPrice.addEventListener('input', formatYenRealtime);
  newPrice.addEventListener('input', formatYenRealtime);

  const formatPctInput = (el) => {
    const v = toNum(el.value);
    if(isFinite(v)) el.value = pct1(v);
  };
  cpiRate.addEventListener('blur', () => formatPctInput(cpiRate));
  wageRate.addEventListener('blur', () => formatPctInput(wageRate));

  function setupChips(groupId, multiple) {
    const group = $(groupId);
    group.addEventListener('click', (e) => {
      if(e.target.classList.contains('chip')) {
        if(!multiple) {
          group.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          e.target.classList.add('active');
        } else {
          e.target.classList.toggle('active');
        }
        generate();
      }
    });
  }
  setupChips('#factorGroup', true);
  setupChips('#effortGroup', true);
  setupChips('#relationGroup', false);

  $('#outputTabs').addEventListener('click', (e) => {
    if(e.target.classList.contains('tab')) {
      $$('#outputTabs .tab').forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected','false'); t.tabIndex = -1; });
      e.target.classList.add('active');
      e.target.setAttribute('aria-selected','true');
      e.target.tabIndex = 0;
      currentOutputMode = e.target.getAttribute('data-target');
      renderOutput();
    }
  });

  function getSelectedValues(groupId) {
    return Array.from($(groupId).querySelectorAll('.chip.active')).map(c => c.getAttribute('data-val'));
  }

  function buildPrefOptions(){
    prefSelect.innerHTML = '';
    for(const p of PREFS){
      const opt = document.createElement('option');
      opt.value = p.k;
      opt.textContent = p.l;
      prefSelect.appendChild(opt);
    }
  }

  let COST_DATA = null; 
  const SAMPLE_JSON = {
    schema_version: 1,
    meta: {
      updated: "2026-02-22",
      note: "例：全国値（national）＋都道府県（prefs）。都道府県別が無ければnationalを使用。",
      sources: {
        min_wage: { publisher: "厚生労働省", title: "地域別最低賃金", url: "https://www.mhlw.go.jp/" },
        cpi: { publisher: "総務省統計局", title: "消費者物価指数", url: "https://www.stat.go.jp/" }
      }
    },
    national: { cpi_yoy: 2.0, cpi_asof: "2026年1月", wage_yoy: 4.65, wage_asof: "2025年春闘" },
    prefs: { "和歌山": { cpi_yoy: null, wage_yoy: null, min_wage: { new: 0, old: 0, inc: 0, eff: "2025-10-xx" } } }
  };

  function setStatus(msg, ok){
    if(!dataLoadStatus) return;
    dataLoadStatus.textContent = msg || '';
    dataLoadStatus.style.color = ok ? '#0f172a' : '#b91c1c';
  }

  async function fetchJson(url){
    const bust = (url.includes('?') ? '&' : '?') + 't=' + Date.now();
    const res = await fetch(url + bust, { cache: 'no-store' });
    if(!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  }

  function normalizePrefKey(k){
    if(!k) return '';
    let s = String(k).trim();
    s = s.replace(/[都道府県]$/,'');
    if(s==="東京都") s="東京";
    if(s==="大阪府") s="大阪";
    if(s==="京都府") s="京都";
    if(s==="北海道") s="北海道";
    return s;
  }

  function getPrefData(prefKey){
    if(!COST_DATA || !COST_DATA.prefs) return null;
    const direct = COST_DATA.prefs[prefKey];
    if(direct) return direct;
    for(const key in COST_DATA.prefs){
      if(normalizePrefKey(key) === prefKey) return COST_DATA.prefs[key];
    }
    return null;
  }

  function setLocal(key, val){ try{ localStorage.setItem(key, val); }catch(e){} }
  function getLocal(key){ try{ return localStorage.getItem(key) || ''; }catch(e){ return ''; } }

  async function loadCostData(url, silent){
    const u = (url && url.trim()) ? url.trim() : './pref_cost_data.json';
    if(!silent) setStatus('読み込み中…', true);
    try{
      const json = await fetchJson(u);
      COST_DATA = json;
      setStatus('読み込みOK（' + u + '）', true);
      setLocal('mk_cost_data_url', u);
      renderAllByPref(true);
      generate();
    }catch(e){
      COST_DATA = null;
      if(silent){
        setStatus('（外部データ未読込）', true);
      }else{
        setStatus('読み込み失敗：' + e.message, false);
      }
      renderAllByPref(true);
      generate();
    }
  }

  function clearCostData(){
    COST_DATA = null;
    setStatus('読込解除しました', true);
    renderAllByPref(true);
    generate();
  }

  function getCpiSource(){
    const s = COST_DATA && COST_DATA.meta && COST_DATA.meta.sources && COST_DATA.meta.sources.cpi ? COST_DATA.meta.sources.cpi : null;
    const url = (s && s.url) ? String(s.url) : DEFAULT_CPI_SOURCE_URL;
    const label = (s && (s.publisher || s.title)) ? `（${[s.publisher,s.title].filter(Boolean).join('：')}）` : DEFAULT_CPI_SOURCE_LABEL;
    return { url, label };
  }

  function renderCpiSourceLink(){
    const src = getCpiSource();
    if(cpiSourceAnchor){
      cpiSourceAnchor.href = src.url;
      cpiSourceAnchor.textContent = '物価統計（出典リンク）';
    }
    if(cpiSourceLabel){
      cpiSourceLabel.textContent = src.label;
    }
  }

  function getMinWageFromJson(prefKey){
    const pd = getPrefData(prefKey);
    if(!pd || !pd.min_wage) return null;
    const w = pd.min_wage;
    const n = toNum(w.new ?? w.n ?? w.N);
    const o = toNum(w.old ?? w.o ?? w.O);
    const inc = toNum(w.inc ?? w.diff ?? w.delta);
    let inc2 = isFinite(inc) ? inc : (isFinite(n) && isFinite(o) ? (n - o) : NaN);
    const eff = w.eff ?? w.effective ?? w.effective_date ?? null;
    if(!isFinite(n) || !isFinite(o) || n<=0 || o<=0) return null;
    const pct = (o > 0) ? (inc2 / o * 100) : NaN;
    return { n, o, inc: isFinite(inc2) ? inc2 : null, eff: eff ? String(eff) : null, pct, source: 'json' };
  }

  function getMinWageFromBuiltin(prefKey){
    const w = MIN_WAGE[prefKey];
    if(!w || !isFinite(w.n) || !isFinite(w.o) || w.n<=0 || w.o<=0) return null;
    const pct = (w.o>0) ? (w.inc / w.o * 100) : NaN;
    return { n:w.n, o:w.o, inc:w.inc, eff:w.eff, pct, source:'builtin' };
  }

  function minWageInfo(prefKey){
    const fromJson = getMinWageFromJson(prefKey);
    const w = fromJson || getMinWageFromBuiltin(prefKey);
    if(!w) return null;
    return { ...w, label: PREF_LABEL[prefKey] || prefKey };
  }

  function renderMinWagePanel(){
    const key = prefSelect.value || '鳥取';
    const w = minWageInfo(key);

    if(w){
      const incStr = (w.inc!==null && w.inc!==undefined) ? `+${Math.round(w.inc)}円` : '—';
      minWageView.textContent =
        `${Math.round(w.o).toLocaleString('ja-JP')}円 → ${Math.round(w.n).toLocaleString('ja-JP')}円（${incStr}、前年度比 +${pct1(w.pct)}%）／発効予定：${fmtYMD(w.eff)}`;

      if(w.source === 'json'){
        minWageBadge.textContent = 'JSON';
        minWageBadge.className = 'badge ok';
      }else{
        minWageBadge.textContent = '内蔵';
        minWageBadge.className = 'badge';
      }
    }else{
      minWageView.textContent = '—';
      minWageBadge.textContent = '未取得';
      minWageBadge.className = 'badge err';
    }
  }

  function resolveRate(prefKey, kind){
    const pd = getPrefData(prefKey);
    const nat = COST_DATA && COST_DATA.national ? COST_DATA.national : null;

    const keyYoy = (kind==='cpi') ? 'cpi_yoy' : 'wage_yoy';
    const keyAsof = (kind==='cpi') ? 'cpi_asof' : 'wage_asof';

    if(pd && isFinite(toNum(pd[keyYoy]))){
      return { v: toNum(pd[keyYoy]), asof: pd[keyAsof] || '', scope:'pref' };
    }
    if(nat && isFinite(toNum(nat[keyYoy]))){
      return { v: toNum(nat[keyYoy]), asof: nat[keyAsof] || '', scope:'national' };
    }
    return { v: NaN, asof:'', scope:'none' };
  }

  function setScopeBadge(el, scope){
    if(scope==='pref'){
      el.textContent = '都道府県別';
      el.className = 'badge ok';
    }else if(scope==='national'){
      el.textContent = '全国値';
      el.className = 'badge warn';
    }else if(scope==='manual'){
      el.textContent = '手入力';
      el.className = 'badge';
    }else{
      el.textContent = '未設定';
      el.className = 'badge err';
    }
  }

  function applyLinkedRates(){
    const key = prefSelect.value || '鳥取';
    const cpi = resolveRate(key,'cpi');
    const wage = resolveRate(key,'wage');

    if(linkRates.checked){
      if(isFinite(cpi.v)){
        cpiRate.value = pct1(cpi.v);
        cpiAsOf.value = cpi.asof || '';
        cpiRate.readOnly = true; cpiAsOf.readOnly = true;
        cpiRate.dataset.origin = cpi.scope; cpiAsOf.dataset.origin = cpi.scope;
        setScopeBadge(cpiScopeBadge, cpi.scope);
      }else{
        cpiRate.readOnly = false; cpiAsOf.readOnly = false;
        cpiRate.dataset.origin = 'manual'; cpiAsOf.dataset.origin = 'manual';
        setScopeBadge(cpiScopeBadge, 'none');
      }

      if(isFinite(wage.v)){
        wageRate.value = pct1(wage.v);
        wageAsOf.value = wage.asof || '';
        wageRate.readOnly = true; wageAsOf.readOnly = true;
        wageRate.dataset.origin = wage.scope; wageAsOf.dataset.origin = wage.scope;
        setScopeBadge(wageScopeBadge, wage.scope);
      }else{
        wageRate.readOnly = false; wageAsOf.readOnly = false;
        wageRate.dataset.origin = 'manual'; wageAsOf.dataset.origin = 'manual';
        setScopeBadge(wageScopeBadge, 'none');
      }
    }else{
      cpiRate.readOnly = false; cpiAsOf.readOnly = false;
      wageRate.readOnly = false; wageAsOf.readOnly = false;
      setScopeBadge(cpiScopeBadge, 'manual');
      setScopeBadge(wageScopeBadge, 'manual');
    }
    updateCpiSinceView();
  }

  [cpiRate, wageRate, cpiAsOf, wageAsOf].forEach(el=>{
    el.addEventListener('input', ()=>{
      if(!linkRates.checked) el.dataset.origin = 'manual';
      updateCpiSinceView();
      generate();
    });
  });

  /* =========================
     6) 実際のCPI推移に基づく累積概算（2000年〜）
     ========================= */
  function getHistoricalCpi(year) {
    const CPI = {
      2000: 99.5, 2001: 98.7, 2002: 97.8, 2003: 97.5, 2004: 97.4,
      2005: 97.3, 2006: 97.4, 2007: 97.4, 2008: 98.9, 2009: 97.6,
      2010: 96.6, 2011: 96.3, 2012: 96.2, 2013: 96.6, 2014: 99.1,
      2015: 99.6, 2016: 99.3, 2017: 99.5, 2018: 100.4, 2019: 101.0,
      2020: 100.0, 2021: 99.8, 2022: 102.1, 2023: 105.3, 2024: 108.2,
      2025: 110.6
    };
    if (year < 2000) return CPI[2000];
    if (CPI[year]) return CPI[year];
    
    const maxYear = 2025;
    const baseCpi = CPI[maxYear];
    const diffYears = year - maxYear;
    const rate = toNum(cpiRate.value);
    const r = isFinite(rate) ? rate : 2.0; 
    return baseCpi * Math.pow(1 + r / 100, diffYears);
  }

  function calcCpiSince(){
    const base = (currentPriceAsOf.value||'').trim(); 
    if(!base) return null;

    const m = base.match(/^(\d{4})-(\d{2})$/);
    if(!m) return null;

    const by = parseInt(m[1],10);
    const bm = parseInt(m[2],10) - 1; 
    const now = new Date();
    const ny = now.getFullYear();
    const nm = now.getMonth();

    const months = (ny - by)*12 + (nm - bm);
    if(months <= 0) return { months: 0, cum: 0 };

    const getCpiMonthly = (y, mo) => {
      const cpi_y = getHistoricalCpi(y);
      const cpi_next_y = getHistoricalCpi(y + 1);
      return cpi_y + (cpi_next_y - cpi_y) * (mo / 12);
    };

    const baseCpi = getCpiMonthly(by, bm);
    const nowCpi = getCpiMonthly(ny, nm);

    const cum = (nowCpi / baseCpi - 1) * 100;
    return { months, cum };
  }

  function updateCpiSinceView(){
    const x = calcCpiSince();
    if(!x){
      cpiSinceView.textContent = '—';
      cpiSinceBadge.textContent = '任意';
      cpiSinceBadge.className = 'badge warn';
      return;
    }
    cpiSinceView.textContent = `約${pct1(x.cum)}%（${x.months}ヶ月）`;
    cpiSinceBadge.textContent = '概算';
    cpiSinceBadge.className = 'badge warn';
  }

  function renderAllByPref(){
    renderMinWagePanel();
    applyLinkedRates();
    renderCpiSourceLink();
  }

  /* =========================
     8) 本文に自然に織り込む短文（比較対象の明記）
     ========================= */
  function buildNaturalEvidencePhrase(){
    if(!embedNumbersInLetter.checked) return '';
    const key = prefSelect.value || '鳥取';

    const w = minWageInfo(key);
    const mw = w ? `最低賃金（前年度比 +${pct1(w.pct)}%）` : '';

    const p = toNum(cpiRate.value);
    const price = isFinite(p) ? `物価（前年同月比 +${pct1(p)}%）` : '';

    const h = toNum(wageRate.value);
    const labor = isFinite(h) ? `人件費（前年比 +${pct1(h)}%）` : '';

    const bits = [mw, price, labor].filter(Boolean);
    if(bits.length===0) return '';
    return `背景として、${bits.join('、')}の上昇といった外部環境の変化が重なっております。`;
  }

  function buildReferenceBlock(decidedYM){
    if(!embedNumbersInLetter.checked) return '';
    const key = prefSelect.value || '鳥取';
    const prefLabel = PREF_LABEL[key] || key;
    
    const w = minWageInfo(key);
    const mwLine = w ? `・最低賃金（${prefLabel}）：${Math.round(w.o)}円 → ${Math.round(w.n)}円（前年度比 +${pct1(w.pct)}%、発効：${fmtYMD(w.eff)}）` : '';

    const p = toNum(cpiRate.value);
    const pAsOf = (cpiAsOf.value||'').trim();
    const src = getCpiSource();
    const cpiLine = isFinite(p) ? `・消費者物価指数：前年同月比 +${pct1(p)}%（対象：${pAsOf || '未入力'}、出典：${src.url}）` : '';

    const h = toNum(wageRate.value);
    const hAsOf = (wageAsOf.value||'').trim();
    const wageLine = isFinite(h) ? `・人件費上昇率（参考）：前年比 +${pct1(h)}%（対象：${hAsOf || '未入力'}）` : '';

    const x = calcCpiSince();
    const cpiSinceLine = (includeCpiSinceInLetter.checked && decidedYM && x)
      ? `・累積の物価上昇（概算）：約${pct1(x.cum)}%（現行価格決定の${decidedYM}から現在まで）` : '';

    const lines = [mwLine, cpiLine, wageLine, cpiSinceLine].filter(Boolean);
    if(lines.length === 0) return '';
    return `\n\n--------------------------------------------------\n※参考データ\n${lines.join('\n')}`;
  }

  /* =========================
     9) 根拠メモ（社内用）生成
     ========================= */
  function buildMemoText(){
    const key = prefSelect.value || '鳥取';
    const prefLabel = PREF_LABEL[key] || key;

    const prod = productName.value.trim() || '＿＿＿＿（対象商品・サービス）';
    const cp = toNum(currentPrice.value);
    const np = toNum(newPrice.value);
    const cpStr = isFinite(cp) ? yen(cp) : '＿＿＿円';
    const npStr = isFinite(np) ? yen(np) : '＿＿＿円';
    const dateStr = effectiveDate.value.trim() || '＿＿年＿＿月＿＿日';

    let rateStr = `${cpStr} → ${npStr}`;
    if(isFinite(cp) && isFinite(np) && cp>0){
      const r = ((np/cp)-1)*100;
      const sign = r >= 0 ? '増' : '減';
      rateStr = `${cpStr} → ${npStr}（約${pct1(Math.abs(r))}%${sign}）`;
    }

    const decidedYM = fmtYM(currentPriceAsOf.value);

    const w = minWageInfo(key);
    const mwLine = w
      ? `最低賃金（${prefLabel}）：${Math.round(w.o)}円 → ${Math.round(w.n)}円（+${Math.round(w.inc)}円、前年度比 +${pct1(w.pct)}%）／発効予定：${fmtYMD(w.eff)}（${w.source==='json'?'JSON':'内蔵'}）`
      : `最低賃金（${prefLabel}）：未設定（JSON更新後に反映）`;

    const p = toNum(cpiRate.value);
    const pAsOf = (cpiAsOf.value||'').trim();
    const pScope = (cpiRate.dataset.origin==='pref') ? '都道府県別' : (cpiRate.dataset.origin==='national') ? '全国値' : (cpiRate.dataset.origin==='manual') ? '手入力' : '未設定';
    const cpiLine = isFinite(p)
      ? `CPI（消費者物価指数）参考：前年同月比 +${pct1(p)}%（${pAsOf||'対象未入力'}）／スコープ：${pScope}`
      : `CPI（消費者物価指数）参考：未設定`;

    const h = toNum(wageRate.value);
    const hAsOf = (wageAsOf.value||'').trim();
    const hScope = (wageRate.dataset.origin==='pref') ? '都道府県別' : (wageRate.dataset.origin==='national') ? '全国値' : (wageRate.dataset.origin==='manual') ? '手入力' : '未設定';
    const wageLine = isFinite(h)
      ? `人件費上昇率（参考）：前年比 +${pct1(h)}%（${hAsOf||'対象未入力'}）／スコープ：${hScope}`
      : `人件費上昇率（参考）：未設定`;

    const x = calcCpiSince();
    const cpiSinceLine = (decidedYM && x)
      ? `累積CPI（概算）：現行価格=${decidedYM}決定 → 現在まで 約${pct1(x.cum)}%（${x.months}ヶ月）`
      : `累積CPI（概算）：算出不可（現行価格の決定時期が未入力）`;

    const cpiSinceHow = (decidedYM && x)
      ? `算出式（概算）：実際の消費者物価指数（コアCPI）の過去の年次推移データに基づく変動率`
      : `算出式：—`;

    const src = getCpiSource();
    const srcLine = `出典リンク（物価統計）：${src.url} ${src.label || ''}`;

    const factors = getSelectedValues('#factorGroup');
    const extra = (extraFactors.value||'').trim();
    const factorText = factors.length>0 ? joinJa(factors) : '（未選択）';
    const extraText = extra ? `補足：${extra}` : '補足：—';

    const efforts = getSelectedValues('#effortGroup');
    const effortText = efforts.length>0 ? joinJa(efforts) : '（未選択）';

    return [
      `【対象】${prod}`,
      `【改定】${rateStr} ／ 適用：${dateStr}`,
      decidedYM ? `【現行価格の決定時期】${decidedYM}` : `【現行価格の決定時期】未入力`,
      ``,
      `■ 根拠（説明用メモ）`,
      `- ${mwLine}`,
      `- ${cpiLine}`,
      `- ${wageLine}`,
      `- ${cpiSinceLine}`,
      `  ${cpiSinceHow}`,
      `- ${srcLine}`,
      ``,
      `■ 外部要因（選択）`,
      `- ${factorText}`,
      `- ${extraText}`,
      ``,
      `■ 自助努力（選択）`,
      `- ${effortText}`,
      ``,
      `■ 想定質問→回答（短文テンプレ）`,
      `Q. なぜ今、値上げが必要？`,
      `A. 「外部環境として最低賃金改定・物価上昇・人件費上昇が継続しており、社内努力だけでは吸収が難しくなっています。品質維持のため、適正価格化が必要です。」`,
      ``,
      `Q. “CPIって何？”（専門用語を避けて）`,
      `A. 「公的統計で示される、モノやサービスの価格の上がり下がりの指標です。ここでは前年同月比の上昇率を参考にしています。」`,
      ``,
      `Q. 累積ってどう計算した？`,
      `A. 「過去の実際の消費者物価指数（2020年基準）の推移データに基づき、現行価格決定時から現在までの変動率を概算しています。」`
    ].join('\n');
  }

  /* =========================
     10) 本文・トーク生成
     ========================= */
  function updateRateHint(){
    const cp = toNum(currentPrice.value);
    const np = toNum(newPrice.value);
    if(isFinite(cp) && cp>0 && isFinite(np) && np>=0){
      const rate = ((np/cp)-1)*100;
      const diff = np - cp;
      rateHint.textContent = `改定率：約${pct1(rate)}% ／ 差額：${diff>=0?'+':''}${yen(diff)}`;
    }else{
      rateHint.textContent = '改定率：— ／ 差額：—';
    }
  }

  function validateBasic(){
    const prod = productName.value.trim();
    const cp = toNum(currentPrice.value);
    const np = toNum(newPrice.value);

    let msg = '';
    if(!prod) msg = '「対象商品・サービス名」が未入力です（送付前に必ず埋めてください）。';
    if(isFinite(cp) && isFinite(np) && cp>0 && np<0) msg = '「改定後単価」に負の値が入っています。';
    if(isFinite(cp) && isFinite(np) && cp>0 && np===0) msg = '「改定後単価」が0円です。意図した入力か確認してください。';

    if(msg){
      validateMsg.style.display = 'block';
      validateMsg.textContent = msg;
    }else{
      validateMsg.style.display = 'none';
      validateMsg.textContent = '';
    }
  }

  function buildLetterAndTalk(){
    const prod = productName.value.trim() || '＿＿＿＿（対象商品・サービス）';
    const cp = toNum(currentPrice.value);
    const np = toNum(newPrice.value);
    const dateStr = effectiveDate.value.trim() || '＿＿年＿＿月＿＿日';
    const decidedYM = fmtYM(currentPriceAsOf.value);

    const cpStr = isFinite(cp) ? yen(cp) : '＿＿＿円';
    const npStr = isFinite(np) ? yen(np) : '＿＿＿円';

    let rateStr = `${cpStr} → ${npStr}`;
    if(isFinite(cp) && isFinite(np) && cp > 0) {
      const rate = ((np / cp) - 1) * 100;
      const sign = rate >= 0 ? '増' : '減';
      rateStr = `${cpStr} → ${npStr}（約${pct1(Math.abs(rate))}%${sign}）`;
    }

    const factors = getSelectedValues('#factorGroup');
    const extra = (extraFactors.value||'').trim();
    const factorText = factors.length > 0 ? joinJa(factors) : '原材料費・物流費・人件費等の上昇';
    const factorTail = extra ? `（補足：${extra}）` : '';

    const efforts = getSelectedValues('#effortGroup');
    const effortText = efforts.length > 0 ? joinJa(efforts) : '徹底したコスト削減';

    const relation = getSelectedValues('#relationGroup')[0] || 'B';

    const naturalEvidence = buildNaturalEvidencePhrase();      
    const referenceBlock = buildReferenceBlock(decidedYM);

    const decidedLine = decidedYM ? `現行価格は${decidedYM}に決定以来、可能な限り据え置いてまいりました。` : '';

    let letter = '';
    if(relation === 'A') {
      letter =
`件名：【重要】価格改定のお願い（${prod}）

〇〇株式会社
〇〇様

いつも大変お世話になっております。
[自社名]の[氏名]でございます。

平素より格別のご高配を賜り、心より御礼申し上げます。

本日は、誠に心苦しいお願いがありご連絡いたしました。
昨今の${factorText}${factorTail}により、当社を取り巻くコスト環境が継続的に厳しくなっております。
${naturalEvidence ? naturalEvidence : ''}

${decidedLine}
当社としても、${effortText}を重ね、品質・提供体制を維持する努力を続けてまいりましたが、現行価格のままでは安定的な提供の継続が困難な局面となりました。

つきましては、誠に恐縮ではございますが、以下のとおり価格改定をお願い申し上げます。

【改定内容】
・対象：${prod}
・改定価格：${rateStr}
・適用時期：${dateStr}

ご負担をおかけし大変申し訳ございません。
頂戴するご負担に見合う品質・サービスを維持し、今後も継続的に貢献できるよう尽力いたします。

ご不明点やご相談がございましたら、遠慮なくお申し付けください。
何卒、諸事情をご賢察いただき、ご理解を賜りますようお願い申し上げます。${referenceBlock}`;
    } else if(relation === 'B') {
      letter =
`件名：【重要】${prod} 価格改定のお願い

〇〇株式会社
〇〇様

いつも大変お世話になっております。
[自社名]の[氏名]でございます。

平素は弊社サービスをご利用いただき誠にありがとうございます。
さて、昨今の${factorText}${factorTail}により、各種コストが上昇しております。
${naturalEvidence ? naturalEvidence : ''}

${decidedLine}
弊社としても、${effortText}など可能な対策を講じてまいりましたが、現行価格のままでは従来の品質および安定供給の維持が困難となりました。

つきましては、誠に不本意ではございますが、下記の通り価格改定を実施させていただきたく存じます。

【改定内容】
・対象：${prod}
・改定価格：${rateStr}
・適用時期：${dateStr}

お客様にはご負担をおかけいたします分、より一層のサービス向上に努めてまいります。
何卒ご理解賜りますようお願い申し上げます。${referenceBlock}`;
    } else {
      letter =
`件名：【ご相談】${prod}の適正価格化（価格改定）について

〇〇株式会社
〇〇様

いつも大変お世話になっております。
[自社名]の[氏名]でございます。

本日は、今後の継続提供の前提となる「適正価格化」について、ご相談申し上げます。
昨今の${factorText}${factorTail}が常態化しており、当社のコスト構造にも継続的な影響が出ております。
${naturalEvidence ? naturalEvidence : ''}

${decidedLine}
当社としても、${effortText}を継続してまいりましたが、企業努力のみでコスト増を吸収し続けることが困難となりました。
このままでは『${prod}』の品質・提供体制に支障が出るリスクがあるため、避けるべきと判断しております。

つきましては、以下の目安で価格改定の協議をお願いしたく存じます。

【お願いしたい改定内容（目安）】
・対象：${prod}
・改定価格（目安）：${rateStr}
・適用時期：${dateStr}

もし上記での全面的なご承認が難しい場合でも、
段階的改定／条件調整（ロット・契約期間・一部仕様等）を含め、双方が納得できる着地点を模索したく存じます。

近日中にお打ち合わせの機会を頂戴できますと幸いです。
何卒よろしくお願い申し上げます。${referenceBlock}`;
    }

    const ttl = (relation==='A') ? '信頼関係がある顧客向け' : (relation==='B') ? '標準の取引先向け' : '価格に厳しい顧客向け';
    const talk =
`【${ttl} 面談トーク】

■ 1. 冒頭（状況共有）
「本日はお時間をいただきありがとうございます。実は本日、少し心苦しいご相談がございます。
昨今の${factorText}${factorTail}の影響が弊社にも及び、コスト環境が厳しい状況です。」

■ 2. 根拠の提示（短く・自然に）
${naturalEvidence ? `「${naturalEvidence}」` : '「外部環境の変化が続いています。」'}
${decidedYM ? `「また、現行価格は${decidedYM}に決定以来、可能な限り据え置いてきました。」` : ''}

■ 3. 自助努力の提示と限界
「もちろん御社にご迷惑をおかけできないと、${effortText}を続けてきましたが、
社内努力だけでは吸収できない水準になりました。」

■ 4. 結論（改定の打診）
「このままですと『${prod}』の品質維持や提供体制に支障が出る恐れがあります。
つきましては、${dateStr}より、【 ${rateStr} 】への見直しをご相談できないでしょうか。」

■ 5. 反論への切り返し（例）
顧客：「予算が厳しい。難しい」
回答：「ご事情は承知しております。もし単価の一括改定が難しければ、
段階改定／条件調整（ロット・契約期間・一部仕様）など、別の形での負担調整をご一緒に検討できませんか。」

■ 6. クロージング（次アクション）
「本日いただいたご意見を踏まえ、着地点案（段階改定／条件調整等）を整理して改めてご提案します。」`;

    return { letter, talk };
  }

  let CACHE = { letter:'', talk:'', memo:'' };

  function renderOutput(){
    if(currentOutputMode === 'letter') outputArea.value = CACHE.letter || '';
    else if(currentOutputMode === 'talk') outputArea.value = CACHE.talk || '';
    else outputArea.value = CACHE.memo || '';
  }

  function generate(){
    updateRateHint();
    validateBasic();
    updateCpiSinceView();
    renderCpiSourceLink();

    const lt = buildLetterAndTalk();
    const memo = buildMemoText();

    CACHE.letter = lt.letter;
    CACHE.talk = lt.talk;
    CACHE.memo = memo;

    renderOutput();

    if(printLetter) printLetter.textContent = CACHE.letter || '';
    if(printMemo) printMemo.textContent = CACHE.memo || '';
  }

  function showCopied(){
    copyStatus.classList.add('show');
    clearTimeout(showCopied._t);
    showCopied._t = setTimeout(() => copyStatus.classList.remove('show'), 2000);
  }

  async function copyText(text){
    if(navigator.clipboard && window.isSecureContext){
      try{ await navigator.clipboard.writeText(text); return true; }catch(e){}
    }
    try{
      outputArea.removeAttribute('readonly');
      outputArea.select();
      outputArea.setSelectionRange(0, outputArea.value.length);
      const ok = document.execCommand('copy');
      outputArea.setAttribute('readonly','');
      window.getSelection().removeAllRanges();
      return !!ok;
    }catch(e){
      try{ outputArea.setAttribute('readonly',''); }catch(_){}
      return false;
    }
  }

  copyBtn.addEventListener('click', async () => {
    const ok = await copyText(outputArea.value || '');
    if(ok) showCopied();
  });

  printBtn.addEventListener('click', () => { try{ window.print(); }catch(e){} });

  [productName, currentPriceAsOf, effectiveDate, extraFactors,
   embedNumbersInLetter, includeCpiSinceInLetter, linkRates, cpiRate, wageRate, cpiAsOf, wageAsOf]
    .forEach(el => el.addEventListener('input', generate));
  
  // 金額系はblurでも再計算するよう念のためバインド
  currentPrice.addEventListener('blur', generate);
  newPrice.addEventListener('blur', generate);

  linkRates.addEventListener('change', ()=>{
    renderAllByPref(true);
    generate();
  });

  prefSelect.addEventListener('change', () => {
    setLocal('mk_pref_key', prefSelect.value);
    renderAllByPref(true);
    generate();
  });

  if(loadDataBtn) loadDataBtn.addEventListener('click', () => loadCostData(dataUrl.value, false));
  if(clearDataBtn) clearDataBtn.addEventListener('click', () => clearCostData());

  function getUrlParams(){
    const params = new URLSearchParams(window.location.search);
    let hasParam = false;

    const p = params.get('price') || params.get('P');
    if(p && isFinite(toNum(p))){
      currentPrice.value = Math.round(toNum(p)).toLocaleString('ja-JP');
      markImported(currentPrice);
      hasParam = true;
    }
    const p2 = params.get('P2') || params.get('chgAbs');
    if(p2 && isFinite(toNum(p2))){
      newPrice.value = Math.round(toNum(p2)).toLocaleString('ja-JP');
      markImported(newPrice);
      hasParam = true;
    }

    const prod = params.get('product') || params.get('prod');
    if(prod){
      productName.value = String(prod);
      markImported(productName);
      hasParam = true;
    }
    const dt = params.get('date') || params.get('effectiveDate');
    if(dt){
      effectiveDate.value = String(dt);
      markImported(effectiveDate);
      hasParam = true;
    }

    const pref = params.get('pref');
    if(pref){
      const k = normalizePrefKey(pref);
      if(PREF_LABEL[k]){
        prefSelect.value = k;
        markImported(prefSelect);
        hasParam = true;
      }
    }

    if(hasParam){
      showImportStatus('✅ 転記：URLパラメータから値を取り込みました。');
    }
    return hasParam;
  }

  function resetChips(groupId){
    const g = $(groupId);
    const chips = Array.from(g.querySelectorAll('.chip'));
    chips.forEach(c=>c.classList.remove('active'));
    if(groupId==='#relationGroup'){
      const b = chips.find(x=>x.getAttribute('data-val')==='B');
      if(b) b.classList.add('active');
      return;
    }
    if(groupId==='#effortGroup'){
      chips.filter(x=>['徹底した経費削減','数年間にわたる価格据え置き'].includes(x.getAttribute('data-val'))).forEach(x=>x.classList.add('active'));
      return;
    }
    if(groupId==='#factorGroup'){
      chips.filter(x=>['原材料・仕入コストの上昇','人件費（賃上げ・採用難）による負担増'].includes(x.getAttribute('data-val'))).forEach(x=>x.classList.add('active'));
      return;
    }
  }

  resetBtn.addEventListener('click', () => {
    [productName,currentPrice,newPrice,currentPriceAsOf,effectiveDate,extraFactors].forEach(el=>{
      el.value='';
      el.classList.remove('imported-value');
    });

    embedNumbersInLetter.checked = true;
    includeCpiSinceInLetter.checked = false;
    linkRates.checked = true;

    resetChips('#factorGroup');
    resetChips('#effortGroup');
    resetChips('#relationGroup');

    prefSelect.value = '鳥取';
    setLocal('mk_pref_key','鳥取');

    renderAllByPref(true);
    generate();
  });

  try{
    $('#cpy-year').textContent = String(new Date().getFullYear());
    const ld = new Date(document.lastModified);
    const ymd = isNaN(ld.getTime()) ? '' : `${ld.getFullYear()}-${z2(ld.getMonth()+1)}-${z2(ld.getDate())}`;
    $('#last-updated-date').textContent = ymd;
  }catch(e){}

  try{
    if(jsonSample) jsonSample.textContent = JSON.stringify(SAMPLE_JSON, null, 2);
  }catch(e){}

  function setHelp(txt){ helpBox.textContent = txt || ''; }
  if(helpCpi) helpCpi.addEventListener('click', ()=>{
    setHelp('物価上昇率は、公的統計（CPI=消費者物価指数など）を参考に「物価がどの程度上がっているか」を示す目的で置いています。本文では専門用語を避け、「公的統計では物価が…」の表現に置換しています。');
  });
  if(helpWage) helpWage.addEventListener('click', ()=>{
    setHelp('人件費上昇率は、賃上げ率だけでなく採用難（求人条件の上振れ）・外注単価上昇なども含む「実務の負担増」を説明するための参考値です。可能なら自社の採用単価や求人条件の変化を補足欄に一文入れると強いです。');
  });
  if(helpScope) helpScope.addEventListener('click', ()=>{
    setHelp('物価/賃金の都道府県別データが常に揃うとは限りません。本ツールは「都道府県別がJSONにあればそれを使用、無ければ全国値（参考）」の設計です。画面のバッジでスコープを明示します。');
  });

  buildPrefOptions();

  const savedPref = getLocal('mk_pref_key');
  if(savedPref && PREF_LABEL[savedPref]) prefSelect.value = savedPref;
  else prefSelect.value = '鳥取';

  const savedUrl = getLocal('mk_cost_data_url');
  if(dataUrl && savedUrl) dataUrl.value = savedUrl;

  loadCostData(savedUrl || './pref_cost_data.json', true);

  renderAllByPref(true);
  getUrlParams();

  generate();

})();
</script>

<script src="https://takatrp.github.io/tool-portal/mk-nav.js" defer></script>
</body>
</html>
