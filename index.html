<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>å€¤ä¸Šã’äº¤æ¸‰ãƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼ï¼ˆè¿‘ç•¿ãƒ»ä¸­å›½ç‰ˆï¼‰</title>

<link rel="icon" type="image/png" sizes="192x192" href="favicon192192.png">
<link rel="apple-touch-icon" sizes="192x192" href="favicon192192.png">
<link rel="shortcut icon" href="favicon192192.png">

<style>
:root{
  --brand:#578899;--ink:#1f2937;--muted:#6b7280;--bg:#f7fafc;--ok:#10b981;--warn:#ef4444;
  --card:#fff;--grid:#e5e7eb;--soft:rgba(87,136,153,.10);
}
html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
.header{display:flex;align-items:center;gap:12px;margin:6px 0 8px}
.logo{height:56px;width:auto;object-fit:contain;border-radius:8px}
.title{font-weight:900;font-size:1.22rem;color:#0f172a;display:flex;align-items:center;gap:8px}
.headRight{margin-left:auto;display:flex;gap:6px;align-items:center}
.sub{font-size:.86rem;color:var(--muted);margin:0 0 12px}

.card{background:var(--card);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px;margin-bottom:12px}
.pill{display:inline-block;background:var(--soft);color:var(--brand);font-weight:900;border-radius:999px;padding:5px 9px;font-size:.82rem;margin-bottom:10px}
label{display:block;font-size:.86rem;color:#374151;margin:12px 0 6px;font-weight:800}
input[type="text"],input[type="month"],textarea,select{
  width:100%;box-sizing:border-box;border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:1rem;background:#fff;outline:none;
  transition: background-color .2s,border-color .2s,color .2s;
}
input:focus,textarea:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(87,136,153,.15)}
input::placeholder,textarea::placeholder{color:#c7ccd3}
.hint{font-size:.78rem;color:var(--muted);margin-top:4px}
.danger{color:var(--warn);font-weight:900;margin-top:8px}
.warningBox{background:#fffbeb;border:1px solid #fde68a;color:#92400e;padding:10px;border-radius:8px;font-size:.82rem;margin-top:8px;white-space:pre-wrap;}

.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 12px;font-weight:900;font-size:.92rem;cursor:pointer;transition: opacity .2s;}
.btn:hover{opacity:.9}
.btn.alt{background:#e5e7eb;color:#111827}
.btn.ghost{background:transparent;color:#374151;border:1px solid #d1d5db}
.btn.sm{padding:6px 8px;font-size:.82rem;border-radius:8px}
.miniActions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}

.inputGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:520px){.inputGrid{grid-template-columns:1fr}}

.dashboard{display:block}
.colL,.colR{display:flex;flex-direction:column;gap:10px}
@media (min-width:1024px){.dashboard{display:grid;grid-template-columns:420px 1fr;gap:12px;align-items:start}}

.tabs{display:flex;border-bottom:2px solid #e5e7eb;margin-bottom:12px}
.tab{padding:8px 16px;font-size:.9rem;font-weight:900;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px}
.tab.active{color:var(--brand);border-bottom-color:var(--brand)}
.docArea{min-height:550px;line-height:1.65;font-family:inherit;resize:vertical;background:#f8fafc}
.statusMsg{font-size:0.85rem;color:var(--ok);font-weight:900;margin-left:auto;opacity:0;transition:opacity .25s;}
.statusMsg.show{opacity:1;}

.mk-mini{margin:16px auto 10px;max-width:1100px;color:#374151;font-size:.84rem;text-align:center}
.mk-mini a{color:inherit;text-decoration:underline}
.note{font-size:.8rem;color:#6b7280;text-align:center;margin-bottom:24px}

/* ãƒãƒƒãƒ— */
.chipGroup{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;margin-bottom:4px}
.chip{border:1px solid #d1d5db;background:#fff;border-radius:999px;padding:8px 12px;font-size:.85rem;font-weight:900;color:#374151;cursor:pointer;transition:all .2s;line-height:1.1}
.chip:hover{background:#f3f4f6}
.chip.active{border-color:var(--brand);background:#eef6fa;color:#0f172a}

/* å‚è€ƒãƒ‡ãƒ¼ã‚¿ãƒ‘ãƒãƒ« */
.dataPanel{border:1px solid #e5e7eb;border-radius:12px;background:#fafafa;padding:10px 12px;margin-top:10px}
.dataRow{display:flex;gap:10px;flex-wrap:wrap;font-size:.88rem;color:#111827;align-items:center}
.dataKey{color:#475569;font-weight:900}
.badge{display:inline-block;border:1px solid #d1d5db;border-radius:999px;padding:2px 8px;font-size:.72rem;color:#334155;background:#fff}
.badge.ok{border-color:#94a3b8;color:#0f172a}
.badge.warn{border-color:#f59e0b;color:#92400e;background:#fff7ed}
.badge.err{border-color:#ef4444;color:#991b1b;background:#fff5f5}
.small{font-size:.78rem;color:#64748b}
.divider{height:1px;background:#e5e7eb;margin:12px 0}

/* ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒã‚¤ãƒ©ã‚¤ãƒˆ */
input.imported-value, select.imported-value, textarea.imported-value{
  background-color:#fff9e6 !important;border-color:#f2c94c !important;color:var(--warn);font-weight:900;
}
.importStatus{margin:8px 0 0;font-size:.82rem;color:#0f172a;background:#eef6fa;border:1px solid #d6eaf3;border-radius:10px;padding:8px 10px;display:none}
.importStatus.show{display:block}

/* details */
details{border:1px solid #e5e7eb;border-radius:12px;background:#ffffff;padding:10px 12px;margin-top:10px}
summary{cursor:pointer;font-weight:900;color:#0f172a}
details[open]{background:#fcfeff}
.mutedBox{margin-top:8px;border:1px dashed #cbd5e1;background:#f8fafc;border-radius:12px;padding:10px}
pre.sample{white-space:pre-wrap;margin:0;font-size:.78rem;color:#334155}
.kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  font-size:.78rem;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:8px;padding:2px 6px}

/* ç®¡ç†ãƒ¢ãƒ¼ãƒ‰ï¼šadminOnly ã‚’è¡¨ç¤º */
.adminOnly{display:none !important;}
.isAdmin .adminOnly{display:block !important;}

/* STEP1ï¼šç´¯ç©ç‰©ä¾¡ä¸Šæ˜‡ï¼ˆæ¦‚ç®—ï¼‰ãƒªãƒ³ã‚¯ */
.sourceLink{display:inline-flex;gap:6px;align-items:center;font-size:.78rem;margin-top:6px;flex-wrap:wrap;}
.sourceLink a{color:#0f172a;text-decoration:underline}
.sourceLink .badge{padding:2px 6px}

/* =========================
   å°åˆ·ï¼šæœ¬æ–‡ã¨æ ¹æ‹ ãƒ¡ãƒ¢ã‚’å®Œå…¨åˆ†é›¢
   ========================= */
#printPack{display:none}
.printSection{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:14px;margin:0 0 12px}
.printH1{font-weight:900;font-size:1.05rem;margin:0 0 8px;color:#0f172a}
.printSub{font-size:.82rem;color:#475569;margin:0 0 10px}
.printText{white-space:pre-wrap;line-height:1.65;font-size:.92rem}

@media print{
  body{background:#fff}
  .wrap, footer, .note{display:none !important;}
  #printPack{display:block !important; padding:0; margin:0;}
  .printSection{border:none;border-radius:0;padding:0;margin:0}
  .printDivider{page-break-before:always;}
  .printH1{font-size:1.1rem}
  a{color:#000;text-decoration:underline}
}
</style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <a href="https://takatrp.github.io/tool-portal/" target="_blank" rel="noopener noreferrer">
      <img src="ãƒ­ã‚´.jpg" alt="ãƒ­ã‚´" class="logo" width="112" height="56">
    </a>
    <div class="title">å€¤ä¸Šã’äº¤æ¸‰ãƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼ï¼ˆè¿‘ç•¿ãƒ»ä¸­å›½ç‰ˆï¼‰ <span class="badge ok">r21</span></div>
    <div class="headRight">
      <button class="btn ghost sm" id="resetBtn" type="button">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </div>
  <div class="sub">èƒŒæ™¯è¦å› ï¼ˆå¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ï¼‹äº‹æƒ…ï¼‰ã‚’æ•´ç†ã—ã€æœ¬æ–‡ï¼ˆé¡§å®¢å‘ã‘ï¼‰ã¨æ ¹æ‹ ãƒ¡ãƒ¢ï¼ˆç¤¾å†…ç”¨ï¼‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</div>

  <div id="importStatus" class="importStatus" role="status" aria-live="polite"></div>

  <div class="dashboard">
    <div class="colL">

      <div class="card">
        <div class="pill">STEP 0ï¼šå¥‘ç´„ç¢ºèªï¼ˆå¿…é ˆï¼‰</div>
        
        <label>æ—¢å­˜å¥‘ç´„ã«ãŠã‘ã‚‹ä¾¡æ ¼æ”¹å®šæ¡é …</label>
        <div class="chipGroup" id="clauseGroup">
          <button class="chip" type="button" data-val="clause_yes">æ”¹å®šæ¡é …ã‚ã‚Š</button>
          <button class="chip" type="button" data-val="clause_no">æ¡é …ãªã—ï¼ˆè¦å”è­°ï¼‰</button>
          <button class="chip active" type="button" data-val="clause_unknown">æœªç¢ºèª</button>
        </div>
        
        <div class="hint" style="color:#ef4444; font-weight:bold;">
          âš ï¸ ä¾¡æ ¼æ”¹å®šæ¡é …ãŒãªã„å ´åˆã€ä¸€æ–¹çš„ãªå€¤ä¸Šã’ã¯åŸå‰‡ä¸å¯ï¼ˆæ°‘æ³•ä¸Šã¯ç›¸æ‰‹ã®åŒæ„ãŒå¿…è¦ï¼‰ã€‚æœ¬ãƒ„ãƒ¼ãƒ«ã§ç”Ÿæˆã™ã‚‹æ–‡é¢ã¯ã€Œå”è­°ã®ç”³ã—å…¥ã‚Œã€ã¨ã—ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
        </div>
        
        <details>
          <summary>ç‹¬å ç¦æ­¢æ³•ã®æ³¨æ„ç‚¹ï¼ˆå„ªè¶Šçš„åœ°ä½ï¼‰</summary>
          <div class="mutedBox">
            <div class="small">
              è‡ªç¤¾ãŒå–å¼•ä¸Šå„ªä½ãªç«‹å ´ã«ã‚ã‚‹å ´åˆã€ä»¥ä¸‹ã®è¡Œç‚ºã¯ç‹¬ç¦æ³•é•åãƒªã‚¹ã‚¯ãŒã‚ã‚Šã¾ã™ï¼š
              <ul style="margin:4px 0 8px; padding-left:20px;">
                <li>çŸ­æœŸé–“ã§ã®ä¸€æ–¹çš„ãªä¾¡æ ¼å¤‰æ›´é€šçŸ¥</li>
                <li>å—ã‘å…¥ã‚Œãªã„å ´åˆã®å–å¼•åœæ­¢ç¤ºå”†</li>
                <li>å”è­°ã‚’çµŒãšã«æ—¢å­˜æ³¨æ–‡ã¸ã®é©ç”¨</li>
              </ul>
              <b>å¯¾ç­–:</b> ååˆ†ãªäºˆå‘ŠæœŸé–“ï¼ˆ60-90æ—¥ï¼‰ã€ä¸å¯§ãªå”è­°å§¿å‹¢ã€æ®µéšçš„æ”¹å®šã®æç¤ºãªã©
            </div>
          </div>
        </details>
      </div>

      <div class="card">
        <div class="pill">STEP 1ï¼šæ”¹å®šå†…å®¹</div>

        <label for="productName">å¯¾è±¡å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹å</label>
        <input type="text" id="productName" placeholder="ä¾‹ï¼‰ä¿å®ˆè²»ç”¨ã€ã€‡ã€‡éƒ¨å“" />

        <div class="inputGrid">
          <div>
            <label for="currentPrice">ç¾åœ¨ã®å˜ä¾¡ï¼ˆç¨æŠœï¼‰</label>
            <input type="text" id="currentPrice" inputmode="decimal" placeholder="ä¾‹ï¼‰1,200" />
          </div>
          <div>
            <label for="newPrice">æ”¹å®šå¾Œå˜ä¾¡ï¼ˆç¨æŠœï¼‰</label>
            <input type="text" id="newPrice" inputmode="decimal" placeholder="ä¾‹ï¼‰1,320" />
          </div>
        </div>

        <div class="hint" id="rateHint">æ”¹å®šç‡ï¼šâ€” ï¼ å·®é¡ï¼šâ€”</div>
        <div id="validationWarning" class="warningBox" style="display:none;"></div>

        <div class="inputGrid" style="margin-top:8px;">
          <div>
            <label for="currentPriceAsOf">ç¾è¡Œä¾¡æ ¼ã®æ±ºå®šæ™‚æœŸï¼ˆå¹´æœˆï¼‰</label>
            <input type="month" id="currentPriceAsOf" />
            <div class="hint">æœ¬æ–‡ã«è‡ªç„¶ã«ç¹”ã‚Šè¾¼ã‚ã¾ã™ï¼ˆä¾‹ï¼š2024-04ï¼‰ã€‚</div>
          </div>
          <div>
            <label for="effectiveDate">é©ç”¨é–‹å§‹æ™‚æœŸ</label>
            <input type="text" id="effectiveDate" placeholder="ä¾‹ï¼‰2026å¹´4æœˆ1æ—¥ ã”æ³¨æ–‡åˆ†ã‚ˆã‚Š" />
          </div>
        </div>

        <div class="dataPanel" style="margin-top:10px;">
          <div class="dataRow">
            <span class="dataKey">ç¾è¡Œä¾¡æ ¼æ±ºå®šæ™‚ã‹ã‚‰ã®ç´¯ç©ä¸Šæ˜‡ï¼ˆæ¦‚ç®—ï¼‰</span>
            <span id="cpiSinceView">ç‰©ä¾¡ï¼šâ€” ï¼ æœ€ä½è³ƒé‡‘ï¼šâ€”</span>
            <span class="badge warn" id="cpiSinceBadge">ä»»æ„</span>
          </div>
          <div class="small">â€»å®Ÿéš›ã®æ¶ˆè²»è€…ç‰©ä¾¡æŒ‡æ•°ãŠã‚ˆã³æœ€ä½è³ƒé‡‘ï¼ˆå¯¾è±¡éƒ½é“åºœçœŒï¼‰ã®éå»æ¨ç§»ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨ã„ãŸæ¦‚ç®—ã§ã™ã€‚</div>
          
          <details style="border:none; padding:0; background:transparent !important; margin-top:6px;">
            <summary style="font-size:0.8rem; font-weight:normal; color:#578899; cursor:pointer; text-decoration:underline;">è¨ˆç®—éç¨‹ã‚’ç¢ºèªã™ã‚‹</summary>
            <div id="calcDetailBox" class="mutedBox" style="font-size:0.75rem; margin-top:4px; line-height:1.5;">
              ï¼ˆå¹´æœˆã‚’å…¥åŠ›ã™ã‚‹ã¨è¨ˆç®—éç¨‹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰
            </div>
          </details>

          <div class="sourceLink">
            <span class="badge">æ ¹æ‹ </span>
            <a href="https://www.stat.go.jp/data/cpi/sokuhou/tsuki/pdf/doukou.pdf" target="_blank" rel="noopener">ç·å‹™çœçµ±è¨ˆå±€</a> /
            <a href="https://www.mhlw.go.jp/content/11200000/001571219.xlsx" target="_blank" rel="noopener">åšåŠ´çœ æœ€ä½è³ƒé‡‘æ¨ç§»</a>
          </div>
        </div>

        <div id="validateMsg" class="danger" style="display:none;"></div>
      </div>

      <div class="card">
        <div class="pill">STEP 2ï¼šèƒŒæ™¯ï¼ˆå¤–éƒ¨è¦å› ï¼‹æ ¹æ‹ ãƒ‡ãƒ¼ã‚¿ï¼‰</div>

        <label for="prefSelect">ä¸»ãªæä¾›ã‚¨ãƒªã‚¢ï¼ˆéƒ½é“åºœçœŒï¼‰</label>
        <select id="prefSelect" aria-label="éƒ½é“åºœçœŒé¸æŠ"></select>

        <div class="dataPanel" aria-label="å‚è€ƒãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€ä½è³ƒé‡‘ãªã©ï¼‰">
          <div class="dataRow">
            <span class="dataKey">æœ€ä½è³ƒé‡‘ï¼ˆå‚è€ƒï¼‰</span>
            <span id="minWageView">â€”</span>
            <span class="badge" id="minWageBadge">æœªå–å¾—</span>
          </div>
          <div class="small" id="minWageNote">â€»æœ€ä½è³ƒé‡‘ã¯JSONå„ªå…ˆï¼ˆæœªèª­è¾¼æ™‚ã¯å†…è”µå€¤ï¼‰ã€‚</div>
        </div>

        <div class="divider"></div>

        <div class="inputGrid">
          <div>
            <label for="cpiRate">ç‰©ä¾¡ä¸Šæ˜‡ç‡ï¼ˆ%ï¼‰ <span class="badge" id="cpiScopeBadge">â€”</span></label>
            <input type="text" id="cpiRate" inputmode="decimal" placeholder="ä¾‹ï¼‰2.0" />
          </div>
          <div>
            <label for="wageRate">äººä»¶è²»ä¸Šæ˜‡ç‡ï¼ˆ%ï¼‰ <span class="badge" id="wageScopeBadge">â€”</span></label>
            <input type="text" id="wageRate" inputmode="decimal" placeholder="ä¾‹ï¼‰4.6" />
          </div>
        </div>

        <div class="inputGrid" style="margin-top:12px;">
          <div>
            <label for="cpiAsOf" style="margin-top:0;">ç‰©ä¾¡ãƒ‡ãƒ¼ã‚¿ã®å¯¾è±¡</label>
            <input type="text" id="cpiAsOf" placeholder="ä¾‹ï¼‰2026å¹´1æœˆï¼ˆå‰å¹´åŒæœˆæ¯”ï¼‰" />
          </div>
          <div>
            <label for="wageAsOf" style="margin-top:0;">äººä»¶è²»ãƒ‡ãƒ¼ã‚¿ã®å¯¾è±¡</label>
            <input type="text" id="wageAsOf" placeholder="ä¾‹ï¼‰2025å¹´æ˜¥é—˜ï¼ˆä¸­å°ï¼‰" />
          </div>
        </div>

        <details>
          <summary>è©³ç´°è¨­å®šï¼ˆé€£å‹•/èª¬æ˜/JSONèª­è¾¼ï¼‰</summary>

          <div class="mutedBox">
            <div class="dataRow">
              <span class="dataKey">éƒ½é“åºœçœŒå¤‰æ›´ã«é€£å‹•</span>
              <label style="display:flex;gap:10px;align-items:center;margin:0;font-weight:900;">
                <input type="checkbox" id="linkRates" checked style="width:auto;"> é€£æ¨ã™ã‚‹ï¼ˆæ¨å¥¨ï¼‰
              </label>
              <span class="badge warn" id="linkNoteBadge">å…¨å›½å€¤ãŒå¤šã„</span>
            </div>
            <div class="small" id="linkNoteText" style="margin-top:6px;">
              â€»éƒ½é“åºœçœŒåˆ¥ã®ç‰©ä¾¡/è³ƒé‡‘ãŒJSONã«ç„¡ã„å ´åˆã¯ã€Œå…¨å›½å€¤ã€ã‚’è¡¨ç¤ºã—ã¾ã™ï¼ˆãƒãƒƒã‚¸ã§æ˜è¨˜ï¼‰ã€‚
              éƒ½é“åºœçœŒåˆ¥ã§é‹ç”¨ã—ãŸã„å ´åˆã¯ pref_cost_data.json ã® prefs.[éƒ½é“åºœçœŒã‚­ãƒ¼].cpi_yoy / wage_yoy ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
            </div>

            <div class="divider"></div>

            <label style="display:flex;gap:10px;align-items:center;margin:0;font-weight:900;">
              <input type="checkbox" id="embedNumbersInLetter" checked style="width:auto;"> æœ¬æ–‡ã«æ ¹æ‹ æ•°å€¤ï¼ˆ%ãƒ»æœ€ä½è³ƒé‡‘ç­‰ï¼‰ã‚’è‡ªç„¶ã«ç¹”ã‚Šè¾¼ã¿ã€æœ«å°¾ã«å‚è€ƒãƒ‡ãƒ¼ã‚¿ã‚’ä»˜ä¸ã™ã‚‹
            </label>

            <div class="divider"></div>

            <div class="small" style="font-weight:900;color:#0f172a;">èª¬æ˜ï¼ˆç¤¾å†…å‘ã‘ï¼‰</div>
            <div class="chipGroup" style="margin-top:6px;">
              <button class="chip" type="button" id="helpCpi">ç‰©ä¾¡ä¸Šæ˜‡ç‡ã¨ã¯ï¼Ÿ</button>
              <button class="chip" type="button" id="helpWage">äººä»¶è²»ä¸Šæ˜‡ç‡ã¨ã¯ï¼Ÿ</button>
              <button class="chip" type="button" id="helpScope">éƒ½é“åºœçœŒåˆ¥ã§ãªã„ç†ç”±</button>
            </div>
            <div class="small" id="helpBox" style="margin-top:8px;line-height:1.6;color:#334155;"></div>
          </div>

          <details id="dataLoader" class="adminOnly">
            <summary>éƒ½é“åºœçœŒãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆJSONï¼‰</summary>
            <div class="hint">åŒéšå±¤ã® <span class="kbd">pref_cost_data.json</span> ã¾ãŸã¯URLã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã™ï¼ˆç‰©ä¾¡/è³ƒé‡‘/æœ€ä½è³ƒé‡‘ãªã©ï¼‰ã€‚</div>

            <label for="dataUrl">JSONã®URLï¼ˆç©ºæ¬„ãªã‚‰ ./pref_cost_data.json ã‚’è©¦è¡Œï¼‰</label>
            <input type="text" id="dataUrl" placeholder="ä¾‹ï¼‰https://.../pref_cost_data.json" />

            <div class="miniActions">
              <button class="btn" id="loadDataBtn" type="button">èª­ã¿è¾¼ã¿</button>
              <button class="btn alt" id="clearDataBtn" type="button">èª­è¾¼è§£é™¤</button>
              <span id="dataLoadStatus" class="small" aria-live="polite"></span>
            </div>

            <div class="mutedBox">
              <div class="small" style="margin-bottom:6px;"><b>JSONã‚­ãƒ¼ä¾‹ï¼ˆæœ€å°ï¼‰</b></div>
              <pre class="sample" id="jsonSample"></pre>
            </div>
            <div class="small">â€»ã‚­ãƒ¼ã¯ã€Œå…µåº« / é³¥å– / å’Œæ­Œå±±ã€ç­‰ã€éƒ½é“åºœçœŒåï¼ˆéƒ½ãƒ»é“ãƒ»åºœãƒ»çœŒã‚’é™¤ã„ãŸå½¢ï¼‰ã§å…¥ã‚Œã¦ãã ã•ã„ã€‚</div>
          </details>
        </details>

        <div class="divider"></div>

        <div class="hint">å¤–éƒ¨è¦å› ï¼šè©²å½“ã™ã‚‹ã‚‚ã®ã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div>
        <div class="chipGroup" id="factorGroup">
          <button class="chip active" type="button" data-val="åŸææ–™ãƒ»ä»•å…¥ã‚³ã‚¹ãƒˆã®ä¸Šæ˜‡">åŸææ–™ãƒ»ä»•å…¥</button>
          <button class="chip" type="button" data-val="ç‰©æµè²»ãƒ»é‹è³ƒã®ä¸Šæ˜‡">ç‰©æµ</button>
          <button class="chip" type="button" data-val="ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼ˆé›»æ°—ãƒ»ã‚¬ã‚¹ãƒ»ç‡ƒæ–™ï¼‰ä¾¡æ ¼ã®ä¸Šæ˜‡">ã‚¨ãƒãƒ«ã‚®ãƒ¼</button>
          <button class="chip active" type="button" data-val="äººä»¶è²»ï¼ˆè³ƒä¸Šã’ãƒ»æ¡ç”¨é›£ï¼‰ã«ã‚ˆã‚‹è² æ‹…å¢—">äººä»¶è²»</button>
          <button class="chip" type="button" data-val="æœ€ä½è³ƒé‡‘ã®æ”¹å®š">æœ€ä½è³ƒé‡‘</button>
          <button class="chip" type="button" data-val="IT/ã‚µãƒ–ã‚¹ã‚¯è²»ç”¨ã®å¢—åŠ ">IT/ã‚µãƒ–ã‚¹ã‚¯</button>
          <button class="chip" type="button" data-val="é‡‘åˆ©ä¸Šæ˜‡ãƒ»è³‡é‡‘èª¿é”ã‚³ã‚¹ãƒˆå¢—">é‡‘åˆ©</button>
        </div>

        <label for="extraFactors">è£œè¶³ï¼ˆä»»æ„ï¼‰</label>
        <textarea id="extraFactors" rows="2" placeholder="ä¾‹ï¼‰ä¸»è¦ä»•å…¥å…ˆã‹ã‚‰ã®å€¤ä¸Šã’é€šçŸ¥ï¼ˆ+8%ï¼‰ã€æ¡ç”¨å˜ä¾¡ã®ä¸Šæ˜‡ ç­‰"></textarea>
        <div class="hint">â€»å…¥åŠ›ã™ã‚‹ã¨ã€Œã€œã«åŠ ãˆã€ã€‡ã€‡ã€ã¨è‡ªç„¶ã«æ–‡ç« ã¸çµ„ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚</div>
      </div>

      <div class="card">
        <div class="pill">STEP 3ï¼šæ–‡é¢ã®ãƒˆãƒ¼ãƒ³ãƒ»é¡§å®¢æˆ¦ç•¥</div>
        <div class="hint">ç›¸æ‰‹ã«åˆã‚ã›ã¦èª¿æ•´ï¼ˆ1ã¤é¸æŠï¼‰</div>
        <div class="chipGroup" id="relationGroup">
          <button class="chip" type="button" data-val="A">ä¿¡é ¼ã‚ã‚Šï¼ˆå…±æ„Ÿãƒ»èª å®Ÿï¼‰</button>
          <button class="chip active" type="button" data-val="B">æ¨™æº–ï¼ˆè«–ç†ï¼‰</button>
          <button class="chip" type="button" data-val="C">ä¾¡æ ¼ã«å³ã—ã„ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ»ä»£æ›¿æ¡ˆï¼‰</button>
        </div>

        <details style="margin-top:10px;">
          <summary>é«˜åº¦ãªæˆ¦ç•¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆé¡§å®¢ã‚¿ã‚¤ãƒ—ï¼‰</summary>
          <label>é¡§å®¢ã‚¿ã‚¤ãƒ—ï¼ˆä»»æ„ï¼‰</label>
          <div class="chipGroup" id="customerGroup">
            <button class="chip" type="button" data-val="strategic">æˆ¦ç•¥é¡§å®¢ï¼ˆæœ€é‡è¦ï¼‰</button>
            <button class="chip" type="button" data-val="profitable">å„ªè‰¯é¡§å®¢</button>
            <button class="chip" type="button" data-val="marginal">æ¡ç®—ã‚®ãƒªã‚®ãƒª</button>
            <button class="chip" type="button" data-val="loss">èµ¤å­—é¡§å®¢</button>
          </div>
          <div class="hint">
            <b>æˆ¦ç•¥é¡§å®¢:</b> æ®µéšæ”¹å®šãƒ»æ¡ä»¶èª¿æ•´ã‚’æœ€å„ªå…ˆæç¤º<br>
            <b>èµ¤å­—é¡§å®¢:</b> æ”¹å®šå—å…¥ã‚Œãªã‘ã‚Œã°å–å¼•è¦‹ç›´ã—ã‚’ç¤ºå”†ã™ã‚‹å”è­°ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
          </div>
        </details>

        <details style="margin-top:10px;">
          <summary>è‡ªåŠ©åŠªåŠ›ï¼ˆä»»æ„ï¼‰</summary>
          <div class="hint">ã“ã‚Œã¾ã§ã®åŠªåŠ›ï¼ˆè¤‡æ•°å¯ï¼‰</div>
          <div class="chipGroup" id="effortGroup">
            <button class="chip active" type="button" data-val="å¾¹åº•ã—ãŸçµŒè²»å‰Šæ¸›">çµŒè²»å‰Šæ¸›</button>
            <button class="chip" type="button" data-val="æ¥­å‹™ã®DXåŒ–ãƒ»åŠ¹ç‡åŒ–">DXãƒ»åŠ¹ç‡åŒ–</button>
            <button class="chip" type="button" data-val="ä»•å…¥å…ˆã®è¦‹ç›´ã—ãƒ»çµ±åˆ">ä»•å…¥å…ˆè¦‹ç›´ã—</button>
            <button class="chip active" type="button" data-val="æ•°å¹´é–“ã«ã‚ãŸã‚‹ä¾¡æ ¼æ®ãˆç½®ã">ä¾¡æ ¼æ®ãˆç½®ã</button>
          </div>
        </details>
      </div>

    </div>

    <div class="colR">
      <div class="card">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:0;">
          <div class="pill">ç”Ÿæˆå‡ºåŠ›</div>
          <span id="copyStatus" class="statusMsg">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</span>
        </div>

        <div class="tabs" id="outputTabs" role="tablist" aria-label="å‡ºåŠ›åˆ‡æ›¿">
          <div class="tab active" role="tab" aria-selected="true" tabindex="0" data-target="letter">æ¡ˆå†…æ–‡ï¼ˆé¡§å®¢ã«æ¸¡ã™ï¼‰</div>
          <div class="tab" role="tab" aria-selected="false" tabindex="-1" data-target="talk">é¢è«‡ãƒˆãƒ¼ã‚¯</div>
          <div class="tab" role="tab" aria-selected="false" tabindex="-1" data-target="memo">æ ¹æ‹ ãƒ¡ãƒ¢ï¼ˆç¤¾å†…ç”¨ï¼‰</div>
        </div>

        <textarea id="outputArea" class="docArea" readonly></textarea>

        <div class="miniActions">
          <button class="btn" id="copyBtn" type="button">ç¾åœ¨ã®è¡¨ç¤ºã‚’ã‚³ãƒ”ãƒ¼</button>
          <button class="btn alt" id="printBtn" type="button">å°åˆ·ï¼ˆæœ¬æ–‡ï¼‹æ ¹æ‹ ãƒ¡ãƒ¢ï¼‰</button>
        </div>
        <div class="hint" style="margin-top:8px;">â€»å°åˆ·ã¯ã€Œæœ¬æ–‡ã€ã¨ã€Œæ ¹æ‹ ãƒ¡ãƒ¢ï¼ˆç¤¾å†…ç”¨ï¼‰ã€ã‚’æ˜ç¢ºã«åˆ†ã‘ã¦å‡ºåŠ›ã—ã¾ã™ã€‚</div>
      </div>
    </div>
  </div>
</div>

<div id="printPack">
  <div class="printSection">
    <div class="printH1">ã€ãŠå®¢ã•ã¾ã«ãŠæ¸¡ã—ã™ã‚‹æœ¬æ–‡ã€‘</div>
    <div class="printSub">â€»ã“ã®ãƒšãƒ¼ã‚¸ã¯é¡§å®¢å‘ã‘ï¼ˆæ ¹æ‹ ãƒ¡ãƒ¢ã¯æ¬¡ãƒšãƒ¼ã‚¸ï¼‰</div>
    <div class="printText" id="printLetter"></div>
  </div>

  <div class="printDivider"></div>

  <div class="printSection">
    <div class="printH1">ã€ç¤¾å†…ç”¨ï¼šæ ¹æ‹ ãƒ¡ãƒ¢ï¼ˆã‚«ãƒ³ãƒ‹ãƒ³ã‚°ãƒšãƒ¼ãƒ‘ãƒ¼ï¼‰ã€‘</div>
    <div class="printSub">â€»ãŠå®¢ã•ã¾ã«ã¯æ¸¡ã•ãªã„æƒ³å®šã€‚æ ¹æ‹ ã‚’å•ã‚ã‚ŒãŸéš›ã®èª¬æ˜ç”¨ã€‚</div>
    <div class="printText" id="printMemo"></div>
  </div>
</div>

<footer class="mk-mini">
  Â© <span id="cpy-year">2026</span>
  <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener license">ç¨ç†å£«æ³•äººæ¾æœ¬ä¼šè¨ˆäº‹å‹™æ‰€</a> ï½œ 
  <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="license noopener">CC BY-NC-SA 4.0</a> ï½œ 
  <a href="/tool-portal/terms.html" target="_blank" rel="noopener">åˆ©ç”¨æ¡ä»¶</a> ï½œ 
  <span id="build-rev">r21</span>ï¼ˆ<span id="last-updated-date"></span>ï¼‰
</footer>
<div class="note">æœ¬ãƒ„ãƒ¼ãƒ«ã¯æ–‡é¢ç”Ÿæˆã®è£œåŠ©ã§ã™ã€‚æœ€çµ‚åˆ¤æ–­ã¯ã€å–å¼•å®Ÿæ…‹ãƒ»ç«¶åˆãƒ»éœ€çµ¦ãƒ»å¥‘ç´„æ¡é …ç­‰ã‚‚è¸ã¾ãˆã¦è¡Œã£ã¦ãã ã•ã„ã€‚</div>

<script>
(function(){
  /* =========================
     0) å®šæ•°ãƒ»è¨­å®š
     ========================= */
  const qs = new URLSearchParams(window.location.search);
  const IS_ADMIN = (qs.get('admin') === '1');
  try{ document.documentElement.classList.toggle('isAdmin', !!IS_ADMIN); }catch(e){}

  const DATA_FRESHNESS = {
    cpi_base: "2024å¹´12æœˆç¢ºå®šå€¤ï¼ˆ2025å¹´ä»¥é™ã¯æ¨è¨ˆï¼‰",
    min_wage: "2024å¹´åº¦æ”¹å®šå€¤ï¼ˆå„éƒ½é“åºœçœŒåŠ´åƒå±€å…¬ç¤ºï¼‰",
    last_verified: "2026-02-22"
  };

  /* =========================
     1) å¯¾è±¡éƒ½é“åºœçœŒï¼ˆè¿‘ç•¿ãƒ»ä¸­å›½ã‚¨ãƒªã‚¢ï¼‰
     ========================= */
  const PREFS = [
    {k:'æ»‹è³€', l:'æ»‹è³€çœŒ'}, {k:'äº¬éƒ½', l:'äº¬éƒ½åºœ'}, {k:'å¤§é˜ª', l:'å¤§é˜ªåºœ'},
    {k:'å…µåº«', l:'å…µåº«çœŒ'}, {k:'å¥ˆè‰¯', l:'å¥ˆè‰¯çœŒ'}, {k:'å’Œæ­Œå±±', l:'å’Œæ­Œå±±çœŒ'},
    {k:'é³¥å–', l:'é³¥å–çœŒ'}, {k:'å³¶æ ¹', l:'å³¶æ ¹çœŒ'}, {k:'å²¡å±±', l:'å²¡å±±çœŒ'},
    {k:'åºƒå³¶', l:'åºƒå³¶çœŒ'}, {k:'å±±å£', l:'å±±å£çœŒ'}
  ];
  const PREF_LABEL = Object.fromEntries(PREFS.map(x=>[x.k,x.l]));

  // æ—¢å­˜å†…è”µãƒ‡ãƒ¼ã‚¿ (ç›´è¿‘ã®æ”¹å®šæƒ…å ±)
  const MIN_WAGE = {
    "å…µåº«": {n:1116,o:1052,inc:64,eff:"2025-10-04"},
    "é³¥å–": {n:1030,o:957,inc:73,eff:"2025-10-04"},
    "å³¶æ ¹": {n:1033,o:962,inc:71,eff:"2025-11-17"},
    "æ»‹è³€": {n:1080,o:1017,inc:63,eff:"2025-10-05"},
    "äº¬éƒ½": {n:1122,o:1058,inc:64,eff:"2025-11-21"},
    "å¤§é˜ª": {n:1177,o:1114,inc:63,eff:"2025-10-16"},
    "å¥ˆè‰¯": {n:1051,o:986,inc:65,eff:"2025-11-16"},
    "å’Œæ­Œå±±": {n:1040,o:980,inc:60,eff:"2025-10-01"}, 
    "å²¡å±±": {n:1047,o:982,inc:65,eff:"2025-12-01"},
    "åºƒå³¶": {n:1085,o:1020,inc:65,eff:"2025-11-01"},
    "å±±å£": {n:1043,o:979,inc:64,eff:"2025-10-16"}
  };

  /* éƒ½é“åºœçœŒåˆ¥ æœ€ä½è³ƒé‡‘ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿ (2002ã€œ2025å¹´) */
  const MW_HISTORY = {
    "æ»‹è³€": {2002:651, 2003:651, 2004:651, 2005:657, 2006:662, 2007:677, 2008:691, 2009:693, 2010:697, 2011:701, 2012:714, 2013:727, 2014:746, 2015:764, 2016:788, 2017:813, 2018:839, 2019:866, 2020:868, 2021:896, 2022:927, 2023:967, 2024:1017, 2025:1080},
    "äº¬éƒ½": {2002:677, 2003:677, 2004:677, 2005:682, 2006:686, 2007:700, 2008:717, 2009:729, 2010:735, 2011:737, 2012:749, 2013:759, 2014:779, 2015:808, 2016:831, 2017:856, 2018:882, 2019:909, 2020:909, 2021:937, 2022:968, 2023:1008, 2024:1058, 2025:1122},
    "å¤§é˜ª": {2002:703, 2003:703, 2004:703, 2005:708, 2006:712, 2007:731, 2008:748, 2009:762, 2010:779, 2011:786, 2012:800, 2013:819, 2014:838, 2015:858, 2016:883, 2017:909, 2018:936, 2019:964, 2020:964, 2021:992, 2022:1023, 2023:1064, 2024:1114, 2025:1177},
    "å…µåº«": {2002:675, 2003:675, 2004:675, 2005:679, 2006:683, 2007:697, 2008:712, 2009:721, 2010:731, 2011:735, 2012:749, 2013:761, 2014:776, 2015:810, 2016:819, 2017:844, 2018:871, 2019:899, 2020:900, 2021:928, 2022:960, 2023:1001, 2024:1052, 2025:1116},
    "å¥ˆè‰¯": {2002:647, 2003:647, 2004:647, 2005:652, 2006:656, 2007:667, 2008:678, 2009:679, 2010:692, 2011:695, 2012:708, 2013:724, 2014:745, 2015:762, 2016:786, 2017:811, 2018:837, 2019:838, 2020:838, 2021:866, 2022:896, 2023:936, 2024:986, 2025:1051},
    "å’Œæ­Œå±±": {2002:645, 2003:645, 2004:645, 2005:649, 2006:652, 2007:662, 2008:673, 2009:674, 2010:693, 2011:695, 2012:708, 2013:719, 2014:731, 2015:753, 2016:777, 2017:803, 2018:830, 2019:831, 2020:831, 2021:859, 2022:889, 2023:929, 2024:980, 2025:1040},
    "é³¥å–": {2002:610, 2003:610, 2004:610, 2005:612, 2006:614, 2007:621, 2008:629, 2009:630, 2010:645, 2011:645, 2012:652, 2013:664, 2014:677, 2015:693, 2016:715, 2017:738, 2018:762, 2019:790, 2020:792, 2021:821, 2022:854, 2023:900, 2024:957, 2025:1030},
    "å³¶æ ¹": {2002:609, 2003:609, 2004:609, 2005:612, 2006:614, 2007:621, 2008:629, 2009:630, 2010:646, 2011:646, 2012:654, 2013:666, 2014:679, 2015:694, 2016:718, 2017:740, 2018:764, 2019:790, 2020:792, 2021:824, 2022:857, 2023:904, 2024:962, 2025:1033},
    "å²¡å±±": {2002:640, 2003:640, 2004:640, 2005:644, 2006:648, 2007:669, 2008:669, 2009:670, 2010:684, 2011:686, 2012:699, 2013:711, 2014:731, 2015:748, 2016:757, 2017:781, 2018:807, 2019:833, 2020:833, 2021:862, 2022:892, 2023:932, 2024:982, 2025:1047},
    "åºƒå³¶": {2002:644, 2003:644, 2004:644, 2005:649, 2006:654, 2007:669, 2008:683, 2009:692, 2010:696, 2011:703, 2012:718, 2013:731, 2014:750, 2015:769, 2016:793, 2017:818, 2018:844, 2019:871, 2020:871, 2021:899, 2022:930, 2023:970, 2024:1020, 2025:1085},
    "å±±å£": {2002:637, 2003:637, 2004:637, 2005:642, 2006:646, 2007:655, 2008:668, 2009:669, 2010:682, 2011:685, 2012:696, 2013:708, 2014:729, 2015:746, 2016:771, 2017:794, 2018:802, 2019:829, 2020:829, 2021:857, 2022:888, 2023:928, 2024:979, 2025:1043}
  };

  /* --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ --- */
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const toNum = v => { const s = String(v||'').replace(/,/g,'').replace(/[^\d.-]/g,''); const n = parseFloat(s); return isFinite(n) ? n : NaN; };
  const yen = n => isFinite(n) ? new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY', maximumFractionDigits: 0 }).format(n) : 'â€”';
  const pct1 = n => isFinite(n) ? (Math.round(n*10)/10).toFixed(1) : '';
  const z2 = n => String(n).padStart(2,'0');
  const fmtYMD = s => {
    if(!s) return '';
    const d = new Date(s);
    if(isNaN(d.getTime())) return String(s);
    return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;
  };
  const fmtYM = s => {
    if(!s) return '';
    const m = String(s).trim().match(/^(\d{4})-(\d{2})$/);
    if(!m) return String(s);
    return `${m[1]}å¹´${parseInt(m[2],10)}æœˆ`;
  };
  
  const joinJa = (arr) => {
    const a = (arr||[]).filter(Boolean);
    if(a.length===0) return '';
    return a.join("ã€");
  };

  /* --- DOM --- */
  const productName = $('#productName');
  const currentPrice = $('#currentPrice');
  const newPrice = $('#newPrice');
  const currentPriceAsOf = $('#currentPriceAsOf');
  const effectiveDate = $('#effectiveDate');
  const outputArea = $('#outputArea');
  const copyBtn = $('#copyBtn');
  const printBtn = $('#printBtn');
  const copyStatus = $('#copyStatus');
  const resetBtn = $('#resetBtn');
  const rateHint = $('#rateHint');
  const validateMsg = $('#validateMsg');
  const importStatusEl = $('#importStatus');
  const validationWarning = $('#validationWarning');

  const prefSelect = $('#prefSelect');
  const minWageView = $('#minWageView');
  const minWageBadge = $('#minWageBadge');
  const minWageNote = $('#minWageNote');

  const cpiRate = $('#cpiRate');
  const wageRate = $('#wageRate');
  const cpiAsOf = $('#cpiAsOf');
  const wageAsOf = $('#wageAsOf');

  const linkRates = $('#linkRates');
  const cpiScopeBadge = $('#cpiScopeBadge');
  const wageScopeBadge = $('#wageScopeBadge');

  const embedNumbersInLetter = $('#embedNumbersInLetter');

  const cpiSinceView = $('#cpiSinceView');
  const cpiSinceBadge = $('#cpiSinceBadge');

  const helpCpi = $('#helpCpi');
  const helpWage = $('#helpWage');
  const helpScope = $('#helpScope');
  const helpBox = $('#helpBox');

  const dataUrl = $('#dataUrl');
  const loadDataBtn = $('#loadDataBtn');
  const clearDataBtn = $('#clearDataBtn');
  const dataLoadStatus = $('#dataLoadStatus');
  const jsonSample = $('#jsonSample');

  const extraFactors = $('#extraFactors');

  const printLetter = $('#printLetter');
  const printMemo = $('#printMemo');

  let currentOutputMode = 'letter';

  document.addEventListener('input', (e) => {
    if(e.target && e.target.classList && e.target.classList.contains('imported-value')){
      e.target.classList.remove('imported-value');
    }
  });

  function showImportStatus(msg){
    if(!importStatusEl) return;
    importStatusEl.textContent = msg;
    importStatusEl.classList.add('show');
    clearTimeout(showImportStatus._t);
    showImportStatus._t = setTimeout(()=>importStatusEl.classList.remove('show'), 4200);
  }
  function markImported(el){ if(el) el.classList.add('imported-value'); }

  /* ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚«ãƒ³ãƒæ•´å½¢é–¢æ•° */
  const formatYenRealtime = (e) => {
    const el = e.target;
    let raw = el.value.replace(/[^\d.-]/g, '');
    if(!raw) { el.value = ''; return; }
    
    let pos = el.selectionStart;
    let oldLen = el.value.length;

    let parts = raw.split('.');
    let intPart = parts[0];
    let decPart = parts.length > 1 ? '.' + parts[1] : '';

    if (intPart === '' || intPart === '-') {
      el.value = raw;
      return;
    }

    let num = parseInt(intPart, 10);
    if(isNaN(num)) return;
    
    let formatted = num.toLocaleString('ja-JP') + decPart;
    el.value = formatted;

    let newLen = el.value.length;
    let diff = newLen - oldLen;
    try { el.setSelectionRange(pos + diff, pos + diff); } catch(err){}
  };

  /* é‡‘é¡å…¥åŠ›æ™‚ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ ç”¨ãƒã‚¤ãƒ³ãƒ‰ */
  currentPrice.addEventListener('input', (e) => {
    formatYenRealtime(e);
    generate(); 
  });
  newPrice.addEventListener('input', (e) => {
    formatYenRealtime(e);
    generate(); 
  });

  const formatPctInput = (el) => {
    const v = toNum(el.value);
    if(isFinite(v)) el.value = pct1(v);
  };
  cpiRate.addEventListener('blur', () => formatPctInput(cpiRate));
  wageRate.addEventListener('blur', () => formatPctInput(wageRate));

  function setupChips(groupId, multiple) {
    const group = $(groupId);
    if(!group) return;
    group.addEventListener('click', (e) => {
      if(e.target.classList.contains('chip')) {
        if(!multiple) {
          group.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
          e.target.classList.add('active');
        } else {
          e.target.classList.toggle('active');
        }
        generate();
      }
    });
  }
  setupChips('#clauseGroup', false);
  setupChips('#factorGroup', true);
  setupChips('#effortGroup', true);
  setupChips('#relationGroup', false);
  setupChips('#customerGroup', false);

  $('#outputTabs').addEventListener('click', (e) => {
    if(e.target.classList.contains('tab')) {
      $$('#outputTabs .tab').forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected','false'); t.tabIndex = -1; });
      e.target.classList.add('active');
      e.target.setAttribute('aria-selected','true');
      e.target.tabIndex = 0;
      currentOutputMode = e.target.getAttribute('data-target');
      renderOutput();
    }
  });

  function getSelectedValues(groupId) {
    const g = $(groupId);
    if(!g) return [];
    return Array.from(g.querySelectorAll('.chip.active')).map(c => c.getAttribute('data-val'));
  }

  function buildPrefOptions(){
    prefSelect.innerHTML = '';
    for(const p of PREFS){
      const opt = document.createElement('option');
      opt.value = p.k;
      opt.textContent = p.l;
      prefSelect.appendChild(opt);
    }
    // åˆæœŸå€¤ã‚’é³¥å–çœŒã«ã‚»ãƒƒãƒˆ
    prefSelect.value = 'é³¥å–';
  }

  let COST_DATA = null; 

  function setStatus(msg, ok){
    if(!dataLoadStatus) return;
    dataLoadStatus.textContent = msg || '';
    dataLoadStatus.style.color = ok ? '#0f172a' : '#b91c1c';
  }

  async function fetchJson(url){
    try {
      const bust = (url.includes('?') ? '&' : '?') + 't=' + Date.now();
      const res = await fetch(url + bust, { cache: 'no-store' });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      return await res.json();
    } catch (e) {
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ç­‰ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èµ·å› ã«ã‚ˆã‚Šfetchå¤±æ•—ã—ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      const res2 = await fetch(url, { cache: 'no-store' });
      if(!res2.ok) throw new Error('HTTP ' + res2.status);
      return await res2.json();
    }
  }

  function normalizePrefKey(k){
    if(!k) return '';
    let s = String(k).trim();
    s = s.replace(/[éƒ½é“åºœçœŒ]$/,'');
    if(s==="æ±äº¬éƒ½") s="æ±äº¬";
    if(s==="å¤§é˜ªåºœ") s="å¤§é˜ª";
    if(s==="äº¬éƒ½åºœ") s="äº¬éƒ½";
    if(s==="åŒ—æµ·é“") s="åŒ—æµ·é“";
    return s;
  }

  function getPrefData(prefKey){
    if(!COST_DATA || !COST_DATA.prefs) return null;
    const direct = COST_DATA.prefs[prefKey];
    if(direct) return direct;
    for(const key in COST_DATA.prefs){
      if(normalizePrefKey(key) === prefKey) return COST_DATA.prefs[key];
    }
    return null;
  }

  function setLocal(key, val){ try{ localStorage.setItem(key, val); }catch(e){} }
  function getLocal(key){ try{ return localStorage.getItem(key) || ''; }catch(e){ return ''; } }

  async function loadCostData(url, silent){
    const u = (url && url.trim()) ? url.trim() : './pref_cost_data.json';
    if(!silent) setStatus('èª­ã¿è¾¼ã¿ä¸­â€¦', true);
    try{
      const json = await fetchJson(u);
      COST_DATA = json;
      setStatus('èª­ã¿è¾¼ã¿OKï¼ˆ' + u + 'ï¼‰', true);
      setLocal('mk_cost_data_url', u);
    }catch(e){
      COST_DATA = null;
      if(silent){
        setStatus('ï¼ˆå¤–éƒ¨ãƒ‡ãƒ¼ã‚¿æœªèª­è¾¼ï¼‰', true);
      }else{
        setStatus('èª­ã¿è¾¼ã¿å¤±æ•—ï¼š' + e.message, false);
      }
    }

    try {
      renderAllByPref();
      generate();
    } catch(err) {
      console.error('UIåæ˜ æ™‚ã‚¨ãƒ©ãƒ¼', err);
    }
  }

  function clearCostData(){
    COST_DATA = null;
    setStatus('èª­è¾¼è§£é™¤ã—ã¾ã—ãŸ', true);
    renderAllByPref();
    generate();
  }

  function getMinWageFromJson(prefKey){
    const pd = getPrefData(prefKey);
    if(!pd || !pd.min_wage) return null;
    const w = pd.min_wage;
    const n = toNum(w.new ?? w.n ?? w.N);
    const o = toNum(w.old ?? w.o ?? w.O);
    const inc = toNum(w.inc ?? w.diff ?? w.delta);
    let inc2 = isFinite(inc) ? inc : (isFinite(n) && isFinite(o) ? (n - o) : NaN);
    const eff = w.eff ?? w.effective ?? w.effective_date ?? null;
    if(!isFinite(n) || !isFinite(o) || n<=0 || o<=0) return null;
    const pct = (o > 0) ? (inc2 / o * 100) : NaN;
    return { n, o, inc: isFinite(inc2) ? inc2 : null, eff: eff ? String(eff) : null, pct, source: 'json' };
  }

  function getMinWageFromBuiltin(prefKey){
    const w = MIN_WAGE[prefKey];
    if(!w || !isFinite(w.n) || !isFinite(w.o) || w.n<=0 || w.o<=0) return null;
    const pct = (w.o>0) ? (w.inc / w.o * 100) : NaN;
    return { n:w.n, o:w.o, inc:w.inc, eff:w.eff, pct, source:'builtin' };
  }

  function minWageInfo(prefKey){
    const fromJson = getMinWageFromJson(prefKey);
    const w = fromJson || getMinWageFromBuiltin(prefKey);
    if(!w) return null;
    return { ...w, label: PREF_LABEL[prefKey] || prefKey };
  }

  function renderMinWagePanel(){
    const key = prefSelect.value || 'é³¥å–';
    const w = minWageInfo(key);

    if(w){
      const incStr = (w.inc!==null && w.inc!==undefined) ? `+${Math.round(w.inc)}å††` : 'â€”';
      minWageView.textContent =
        `${Math.round(w.o).toLocaleString('ja-JP')}å†† â†’ ${Math.round(w.n).toLocaleString('ja-JP')}å††ï¼ˆ${incStr}ã€å‰å¹´åº¦æ¯” +${pct1(w.pct)}%ï¼‰ï¼ç™ºåŠ¹äºˆå®šï¼š${fmtYMD(w.eff)}`;

      if(w.source === 'json'){
        minWageBadge.textContent = 'JSON';
        minWageBadge.className = 'badge ok';
      }else{
        minWageBadge.textContent = 'å†…è”µ';
        minWageBadge.className = 'badge';
      }
    }else{
      minWageView.textContent = 'â€”';
      minWageBadge.textContent = 'æœªå–å¾—';
      minWageBadge.className = 'badge err';
    }
  }

  function resolveRate(prefKey, kind){
    const pd = getPrefData(prefKey);
    const nat = COST_DATA && COST_DATA.national ? COST_DATA.national : null;

    const keyYoy = (kind==='cpi') ? 'cpi_yoy' : 'wage_yoy';
    const keyAsof = (kind==='cpi') ? 'cpi_asof' : 'wage_asof';

    if(pd && isFinite(toNum(pd[keyYoy]))){
      return { v: toNum(pd[keyYoy]), asof: pd[keyAsof] || '', scope:'pref' };
    }
    if(nat && isFinite(toNum(nat[keyYoy]))){
      return { v: toNum(nat[keyYoy]), asof: nat[keyAsof] || '', scope:'national' };
    }
    return { v: NaN, asof:'', scope:'none' };
  }

  function setScopeBadge(el, scope){
    if(scope==='pref'){
      el.textContent = 'éƒ½é“åºœçœŒåˆ¥';
      el.className = 'badge ok';
    }else if(scope==='national'){
      el.textContent = 'å…¨å›½å€¤';
      el.className = 'badge warn';
    }else if(scope==='manual'){
      el.textContent = 'æ‰‹å…¥åŠ›';
      el.className = 'badge';
    }else{
      el.textContent = 'æœªè¨­å®š';
      el.className = 'badge err';
    }
  }

  function applyLinkedRates(){
    const key = prefSelect.value || 'é³¥å–';
    const cpi = resolveRate(key,'cpi');
    const wage = resolveRate(key,'wage');

    if(linkRates.checked){
      if(isFinite(cpi.v)){
        cpiRate.value = pct1(cpi.v);
        cpiAsOf.value = cpi.asof || '';
        cpiRate.readOnly = true; cpiAsOf.readOnly = true;
        cpiRate.dataset.origin = cpi.scope; cpiAsOf.dataset.origin = cpi.scope;
        setScopeBadge(cpiScopeBadge, cpi.scope);
      }else{
        cpiRate.readOnly = false; cpiAsOf.readOnly = false;
        cpiRate.dataset.origin = 'manual'; cpiAsOf.dataset.origin = 'manual';
        setScopeBadge(cpiScopeBadge, 'none');
      }

      if(isFinite(wage.v)){
        wageRate.value = pct1(wage.v);
        wageAsOf.value = wage.asof || '';
        wageRate.readOnly = true; wageAsOf.readOnly = true;
        wageRate.dataset.origin = wage.scope; wageAsOf.dataset.origin = wage.scope;
        setScopeBadge(wageScopeBadge, wage.scope);
      }else{
        wageRate.readOnly = false; wageAsOf.readOnly = false;
        wageRate.dataset.origin = 'manual'; wageAsOf.dataset.origin = 'manual';
        setScopeBadge(wageScopeBadge, 'none');
      }
    }else{
      cpiRate.readOnly = false; cpiAsOf.readOnly = false;
      wageRate.readOnly = false wageAsOf.readOnly = false;
      setScopeBadge(cpiScopeBadge, 'manual');
      setScopeBadge(wageScopeBadge, 'manual');
    }
  }

  /* =========================
     6-1) å®Ÿéš›ã®CPIæ¨ç§»ã«åŸºã¥ãç´¯ç©æ¦‚ç®—ï¼ˆ1970å¹´ã€œï¼‰
     ========================= */
  function getHistoricalCpi(year) {
    const CPI = {
      1970: 31.4, 1971: 33.3, 1972: 34.8, 1973: 38.9, 1974: 47.9,
      1975: 53.6, 1976: 58.6, 1977: 63.3, 1978: 65.7, 1979: 68.1,
      1980: 73.4, 1981: 77.0, 1982: 79.1, 1983: 80.6, 1984: 82.4,
      1985: 84.1, 1986: 84.6, 1987: 84.7, 1988: 85.3, 1989: 87.2,
      1990: 89.9, 1991: 92.8, 1992: 94.4, 1993: 95.6, 1994: 96.2,
      1995: 96.1, 1996: 96.3, 1997: 98.0, 1998: 98.6, 1999: 98.3,
      2000: 97.6, 2001: 96.8, 2002: 95.9, 2003: 95.6, 2004: 95.6,
      2005: 95.3, 2006: 95.6, 2007: 95.6, 2008: 96.9, 2009: 95.6,
      2010: 94.9, 2011: 94.6, 2012: 94.6, 2013: 95.0, 2014: 97.6,
      2015: 98.4, 2016: 98.3, 2017: 98.8, 2018: 99.8, 2019: 100.3,
      2020: 100.0, 2021: 99.8, 2022: 102.3, 2023: 105.6, 2024: 108.5,
      2025: 111.9
    };
    if (year < 1970) return CPI[1970];
    if (CPI[year]) return CPI[year];
    
    const maxYear = 2025;
    const baseCpi = CPI[maxYear];
    const diffYears = year - maxYear;
    const rate = toNum(cpiRate.value);
    const r = isFinite(rate) ? rate : 2.0; 
    return baseCpi * Math.pow(1 + r / 100, diffYears);
  }

  function calcCpiSince(){
    const base = (currentPriceAsOf.value||'').trim(); 
    if(!base) return null;

    const m = base.match(/^(\d{4})-(\d{2})$/);
    if(!m) return null;

    const by = parseInt(m[1],10);
    const bm = parseInt(m[2],10) - 1; 
    const now = new Date();
    const ny = now.getFullYear();
    const nm = now.getMonth();

    const months = (ny - by)*12 + (nm - bm);
    if(months <= 0) return { months: 0, cum: 0, baseCpi: 0, nowCpi: 0, by, bm, ny, nm };

    const getCpiMonthly = (y, mo) => {
      const cpi_y = getHistoricalCpi(y);
      const cpi_next_y = getHistoricalCpi(y + 1);
      return cpi_y + (cpi_next_y - cpi_y) * (mo / 12);
    };

    const baseCpi = getCpiMonthly(by, bm);
    const nowCpi = getCpiMonthly(ny, nm);

    const cum = (nowCpi / baseCpi - 1) * 100;
    return { months, cum, baseCpi, nowCpi, by, bm, ny, nm };
  }

  /* =========================
     6-2) ã‚¨ãƒªã‚¢åˆ¥ æœ€ä½è³ƒé‡‘ã®æ¨ç§»ã«åŸºã¥ãç´¯ç©æ¦‚ç®—
     ========================= */
  function getHistoricalMinWageForPref(prefKey, year) {
    const hist = MW_HISTORY[prefKey];
    if (hist && hist[year]) return hist[year];
    if (hist && year < 2002) {
      const baseMw = hist[2002];
      return baseMw * Math.pow(0.985, 2002 - year);
    }
    if (hist && year > 2025) {
      return hist[2025]; 
    }
    return null;
  }

  function calcMwSince() {
    const base = (currentPriceAsOf.value||'').trim(); 
    const prefKey = prefSelect.value || 'é³¥å–';
    if(!base) return null;

    const m = base.match(/^(\d{4})-(\d{2})$/);
    if(!m) return null;

    const by = parseInt(m[1],10);
    const ny = new Date().getFullYear();

    const baseMw = getHistoricalMinWageForPref(prefKey, by);
    
    const currentMwInfo = minWageInfo(prefKey);
    const nowMw = currentMwInfo ? currentMwInfo.n : getHistoricalMinWageForPref(prefKey, ny);

    if(!baseMw || !nowMw) return { cum: 0, baseMw: 0, nowMw: 0, by, ny, prefKey };

    const cum = (nowMw / baseMw - 1) * 100;
    return { cum: cum > 0 ? cum : 0, baseMw, nowMw, by, ny, prefKey };
  }

  function updateCpiSinceView(){
    const x = calcCpiSince();
    const mwX = calcMwSince();
    const calcDetailBox = $('#calcDetailBox');

    if(!x || !mwX){
      cpiSinceView.textContent = 'ç‰©ä¾¡ï¼šâ€” ï¼ æœ€ä½è³ƒé‡‘ï¼šâ€”';
      cpiSinceBadge.textContent = 'ä»»æ„';
      cpiSinceBadge.className = 'badge warn';
      if(calcDetailBox) calcDetailBox.innerHTML = 'ï¼ˆå¹´æœˆã‚’å…¥åŠ›ã™ã‚‹ã¨è¨ˆç®—éç¨‹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰';
      return;
    }
    
    cpiSinceView.textContent = `ç‰©ä¾¡ï¼šç´„${pct1(x.cum)}% ï¼ æœ€ä½è³ƒé‡‘ï¼šç´„${pct1(mwX.cum)}%ï¼ˆ${x.months}ãƒ¶æœˆï¼‰`;
    cpiSinceBadge.textContent = 'æ¦‚ç®—';
    cpiSinceBadge.className = 'badge warn';

    if(calcDetailBox) {
      let detailHtml = `<b>ã€ç´¯ç©ç‰©ä¾¡ä¸Šæ˜‡ç‡ï¼ˆCPIï¼‰ã®è¨ˆç®—å¼ã€‘</b><br>`;
      detailHtml += `åŸºæº–æ™‚ï¼ˆ${x.by}å¹´${x.bm+1}æœˆï¼‰ã®æ¨å®šCPIï¼š${x.baseCpi.toFixed(2)}<br>`;
      detailHtml += `ç¾åœ¨ï¼ˆ${x.ny}å¹´${x.nm+1}æœˆï¼‰ã®æ¨å®šCPIï¼š${x.nowCpi.toFixed(2)}<br>`;
      detailHtml += `â‡’ (${x.nowCpi.toFixed(2)} Ã· ${x.baseCpi.toFixed(2)} - 1) Ã— 100 = <b>${x.cum.toFixed(2)}%</b><br><br>`;
      
      detailHtml += `<b>ã€ç´¯ç©æœ€ä½è³ƒé‡‘ä¸Šæ˜‡ç‡ã®è¨ˆç®—å¼ã€‘</b><br>`;
      detailHtml += `å¯¾è±¡ã‚¨ãƒªã‚¢ï¼š${mwX.prefKey}<br>`;
      detailHtml += `åŸºæº–å¹´ï¼ˆ${mwX.by}å¹´ï¼‰ã®æœ€ä½è³ƒé‡‘ï¼š${Math.round(mwX.baseMw)}å††<br>`;
      detailHtml += `ç¾åœ¨ï¼ˆ${mwX.ny}å¹´ï¼‰ã®æœ€ä½è³ƒé‡‘ï¼š${Math.round(mwX.nowMw)}å††<br>`;
      detailHtml += `â‡’ (${Math.round(mwX.nowMw)} Ã· ${Math.round(mwX.baseMw)} - 1) Ã— 100 = <b>${mwX.cum.toFixed(2)}%</b>`;
      
      calcDetailBox.innerHTML = detailHtml;
    }
  }

  /* =========================
     å€¤ä¸Šã’å¹…ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
     ========================= */
  function updateRateHint(){
    const cp = toNum(currentPrice.value);
    const np = toNum(newPrice.value);
    if(isFinite(cp) && cp>0 && isFinite(np) && np>=0){
      const rate = ((np/cp)-1)*100;
      const diff = np - cp;
      rateHint.textContent = `æ”¹å®šç‡ï¼šç´„${pct1(rate)}% ï¼ å·®é¡ï¼š${diff>=0?'+':''}${yen(diff)}`;
    }else{
      rateHint.textContent = 'æ”¹å®šç‡ï¼šâ€” ï¼ å·®é¡ï¼šâ€”';
    }
  }

  function validateBasic(){
    const prod = productName.value.trim();
    const cp = toNum(currentPrice.value);
    const np = toNum(newPrice.value);

    let msg = '';
    if(!prod) msg = 'ã€Œå¯¾è±¡å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹åã€ãŒæœªå…¥åŠ›ã§ã™ï¼ˆé€ä»˜å‰ã«å¿…ãšåŸ‹ã‚ã¦ãã ã•ã„ï¼‰ã€‚';
    if(isFinite(cp) && isFinite(np) && cp>0 && np<0) msg = 'ã€Œæ”¹å®šå¾Œå˜ä¾¡ã€ã«è² ã®å€¤ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚';
    if(isFinite(cp) && isFinite(np) && cp>0 && np===0) msg = 'ã€Œæ”¹å®šå¾Œå˜ä¾¡ã€ãŒ0å††ã§ã™ã€‚æ„å›³ã—ãŸå…¥åŠ›ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';

    if(msg){
      validateMsg.style.display = 'block';
      validateMsg.textContent = msg;
    }else{
      validateMsg.style.display = 'none';
      validateMsg.textContent = '';
    }
  }

  function validatePriceIncrease() {
    const cp = toNum(currentPrice.value);
    const np = toNum(newPrice.value);
    
    validationWarning.style.display = 'none';
    validationWarning.textContent = '';
    
    if (!isFinite(cp) || !isFinite(np) || cp <= 0) return;
    
    const increaseRate = ((np / cp) - 1) * 100;
    if (increaseRate <= 0) return;

    const x = calcCpiSince();
    const cpiCum = x ? x.cum : 0;
    
    let warning = '';
    
    if (cpiCum > 0 && increaseRate > cpiCum * 2) {
      warning += `âš ï¸ å€¤ä¸Šã’ç‡ï¼ˆ${pct1(increaseRate)}%ï¼‰ãŒç´¯ç©ç‰©ä¾¡ä¸Šæ˜‡ï¼ˆç´„${pct1(cpiCum)}%ï¼‰ã®2å€ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚é¡§å®¢ã¸ã®ä¸å¯§ãªèª¬æ˜ã‚„åŸä¾¡ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚\n`;
    }
    
    if (increaseRate > 15) {
      warning += `ğŸ’¡ 15%è¶…ã®å¤§å¹…ãªå€¤ä¸Šã’ã¯æŠµæŠ—ãŒå¤§ãã„å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚ã€Œæ®µéšçš„æ”¹å®šï¼ˆä¾‹ï¼šä»Šå›7% â†’ æ¬¡å›æ›´æ–°æ™‚8%ï¼‰ã€ã‚„ã€Œã‚µãƒ¼ãƒ“ã‚¹æ¡ä»¶ã®èª¿æ•´ã€ã®ä½µæ¡ˆæç¤ºã‚‚æœ‰åŠ¹ã§ã™ã€‚`;
    }
    
    if (warning) {
      validationWarning.textContent = warning.trim();
      validationWarning.style.display = 'block';
    }
  }

  function renderAllByPref(){
    renderMinWagePanel();
    applyLinkedRates();
  }

  /* =========================
     8) æœ¬æ–‡ã«è‡ªç„¶ã«ç¹”ã‚Šè¾¼ã‚€çŸ­æ–‡
     ========================= */
  function buildNaturalEvidencePhrase(){
    if(!embedNumbersInLetter.checked) return '';
    const key = prefSelect.value || 'é³¥å–';

    const w = minWageInfo(key);
    const mw = w ? `æœ€ä½è³ƒé‡‘ï¼ˆå‰å¹´åº¦æ¯” +${pct1(w.pct)}%ï¼‰` : '';

    const p = toNum(cpiRate.value);
    const price = isFinite(p) ? `ç‰©ä¾¡ï¼ˆå‰å¹´åŒæœˆæ¯” +${pct1(p)}%ï¼‰` : '';

    const h = toNum(wageRate.value);
    const labor = isFinite(h) ? `äººä»¶è²»ï¼ˆå‰å¹´æ¯” +${pct1(h)}%ï¼‰` : '';

    const bits = [mw, price, labor].filter(Boolean);
    if(bits.length===0) return '';
    return `èƒŒæ™¯ã¨ã—ã¦ã€${bits.join('ã€')}ã®ä¸Šæ˜‡ã¨ã„ã£ãŸå¤–éƒ¨ç’°å¢ƒã®å¤‰åŒ–ãŒé‡ãªã£ã¦ãŠã‚Šã¾ã™ã€‚`;
  }

  function buildReferenceBlock(decidedYM){
    const key = prefSelect.value || 'é³¥å–';
    const prefLabel = PREF_LABEL[key] || key;
    
    const lines = [];

    if(embedNumbersInLetter.checked) {
      const w = minWageInfo(key);
      if (w) lines.push(`ãƒ»æœ€ä½è³ƒé‡‘ï¼ˆ${prefLabel}ï¼‰ï¼š${Math.round(w.o)}å†† â†’ ${Math.round(w.n)}å††ï¼ˆå‰å¹´åº¦æ¯” +${pct1(w.pct)}%ã€ç™ºåŠ¹ï¼š${fmtYMD(w.eff)}ï¼‰`);

      const p = toNum(cpiRate.value);
      const pAsOf = (cpiAsOf.value||'').trim();
      if (isFinite(p)) lines.push(`ãƒ»æ¶ˆè²»è€…ç‰©ä¾¡æŒ‡æ•°ï¼šå‰å¹´åŒæœˆæ¯” +${pct1(p)}%ï¼ˆå¯¾è±¡ï¼š${pAsOf || 'æœªå…¥åŠ›'}ã€å‡ºå…¸ï¼šç·å‹™çœçµ±è¨ˆå±€ / JILPTï¼‰`);

      const h = toNum(wageRate.value);
      const hAsOf = (wageAsOf.value||'').trim();
      if (isFinite(h)) lines.push(`ãƒ»äººä»¶è²»ä¸Šæ˜‡ç‡ï¼ˆå‚è€ƒï¼‰ï¼šå‰å¹´æ¯” +${pct1(h)}%ï¼ˆå¯¾è±¡ï¼š${hAsOf || 'æœªå…¥åŠ›'}ï¼‰`);
    }

    const x = calcCpiSince();
    if (decidedYM && x && x.cum > 0) {
      lines.push(`ãƒ»ç´¯ç©ç‰©ä¾¡ä¸Šæ˜‡ç‡ï¼šç´„${pct1(x.cum)}%ï¼ˆç¾è¡Œä¾¡æ ¼æ±ºå®šã®${decidedYM}ã‹ã‚‰ç¾åœ¨ã¾ã§ï¼‰`);
    }

    const mwX = calcMwSince();
    if (decidedYM && mwX && mwX.cum > 0) {
      lines.push(`ãƒ»ç´¯ç©æœ€ä½è³ƒé‡‘ä¸Šæ˜‡ç‡ï¼šç´„${pct1(mwX.cum)}%ï¼ˆç¾è¡Œä¾¡æ ¼æ±ºå®šã®${decidedYM}ã‹ã‚‰ç¾åœ¨ã¾ã§ã€${prefLabel}ï¼‰`);
    }

    if(lines.length === 0) return '';
    return `\n\n--------------------------------------------------\nâ€»å‚è€ƒãƒ‡ãƒ¼ã‚¿\n${lines.join('\n')}`;
  }

  /* =========================
     9) æ ¹æ‹ ãƒ¡ãƒ¢ï¼ˆç¤¾å†…ç”¨ï¼‰ç”Ÿæˆ
     ========================= */
  function buildMemoText(){
    const key = prefSelect.value || 'é³¥å–';
    const prefLabel = PREF_LABEL[key] || key;

    const prod = productName.value.trim() || 'ï¼¿ï¼¿ï¼¿ï¼¿ï¼ˆå¯¾è±¡å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ï¼‰';
    const cp = toNum(currentPrice.value);
    const np = toNum(newPrice.value);
    const cpStr = isFinite(cp) ? yen(cp) : 'ï¼¿ï¼¿ï¼¿å††';
    const npStr = isFinite(np) ? yen(np) : 'ï¼¿ï¼¿ï¼¿å††';
    const dateStr = effectiveDate.value.trim() || 'ï¼¿ï¼¿å¹´ï¼¿ï¼¿æœˆï¼¿ï¼¿æ—¥';

    let rateStr = `${cpStr} â†’ ${npStr}`;
    if(isFinite(cp) && isFinite(np) && cp>0){
      const r = ((np/cp)-1)*100;
      const sign = r >= 0 ? 'å¢—' : 'æ¸›';
      rateStr = `${cpStr} â†’ ${npStr}ï¼ˆç´„${pct1(Math.abs(r))}%${sign}ï¼‰`;
    }

    const decidedYM = fmtYM(currentPriceAsOf.value);

    const clauseArr = getSelectedValues('#clauseGroup');
    const clauseType = clauseArr[0] || 'clause_unknown';
    const clauseStr = clauseType === 'clause_yes' ? 'ã‚ã‚Šï¼ˆé€šçŸ¥ã®ã¿ã§å¯ã®å¯èƒ½æ€§ï¼‰' : clauseType === 'clause_no' ? 'ãªã—ï¼ˆåˆæ„ãƒ»å”è­°ãŒå¿…é ˆï¼‰' : 'æœªç¢ºèªï¼ˆè¦ç¢ºèªï¼‰';

    const w = minWageInfo(key);
    const mwLine = w
      ? `æœ€ä½è³ƒé‡‘ï¼ˆ${prefLabel}ï¼‰ï¼š${Math.round(w.o)}å†† â†’ ${Math.round(w.n)}å††ï¼ˆ+${Math.round(w.inc)}å††ã€å‰å¹´åº¦æ¯” +${pct1(w.pct)}%ï¼‰ï¼ç™ºåŠ¹äºˆå®šï¼š${fmtYMD(w.eff)}ï¼ˆ${w.source==='json'?'JSON':'å†…è”µ'}ï¼‰`
      : `æœ€ä½è³ƒé‡‘ï¼ˆ${prefLabel}ï¼‰ï¼šæœªè¨­å®šï¼ˆJSONæ›´æ–°å¾Œã«åæ˜ ï¼‰`;

    const p = toNum(cpiRate.value);
    const pAsOf = (cpiAsOf.value||'').trim();
    const pScope = (cpiRate.dataset.origin==='pref') ? 'éƒ½é“åºœçœŒåˆ¥' : (cpiRate.dataset.origin==='national') ? 'å…¨å›½å€¤' : (cpiRate.dataset.origin==='manual') ? 'æ‰‹å…¥åŠ›' : 'æœªè¨­å®š';
    const cpiLine = isFinite(p)
      ? `CPIï¼ˆæ¶ˆè²»è€…ç‰©ä¾¡æŒ‡æ•°ï¼‰å‚è€ƒï¼šå‰å¹´åŒæœˆæ¯” +${pct1(p)}%ï¼ˆ${pAsOf||'å¯¾è±¡æœªå…¥åŠ›'}ï¼‰ï¼ã‚¹ã‚³ãƒ¼ãƒ—ï¼š${pScope}`
      : `CPIï¼ˆæ¶ˆè²»è€…ç‰©ä¾¡æŒ‡æ•°ï¼‰å‚è€ƒï¼šæœªè¨­å®š`;

    const h = toNum(wageRate.value);
    const hAsOf = (wageAsOf.value||'').trim();
    const hScope = (wageRate.dataset.origin==='pref') ? 'éƒ½é“åºœçœŒåˆ¥' : (wageRate.dataset.origin==='national') ? 'å…¨å›½å€¤' : (wageRate.dataset.origin==='manual') ? 'æ‰‹å…¥åŠ›' : 'æœªè¨­å®š';
    const wageLine = isFinite(h)
      ? `äººä»¶è²»ä¸Šæ˜‡ç‡ï¼ˆå‚è€ƒï¼‰ï¼šå‰å¹´æ¯” +${pct1(h)}%ï¼ˆ${hAsOf||'å¯¾è±¡æœªå…¥åŠ›'}ï¼‰ï¼ã‚¹ã‚³ãƒ¼ãƒ—ï¼š${hScope}`
      : `äººä»¶è²»ä¸Šæ˜‡ç‡ï¼ˆå‚è€ƒï¼‰ï¼šæœªè¨­å®š`;

    const x = calcCpiSince();
    const cpiSinceLine = (decidedYM && x)
      ? `ç´¯ç©CPIï¼ˆæ¦‚ç®—ï¼‰ï¼šç¾è¡Œä¾¡æ ¼=${decidedYM}æ±ºå®š â†’ ç¾åœ¨ã¾ã§ ç´„${pct1(x.cum)}%ï¼ˆ${x.months}ãƒ¶æœˆï¼‰`
      : `ç´¯ç©CPIï¼ˆæ¦‚ç®—ï¼‰ï¼šç®—å‡ºä¸å¯`;

    const mwX = calcMwSince();
    const mwSinceLine = (decidedYM && mwX)
      ? `ç´¯ç©æœ€ä½è³ƒé‡‘ï¼ˆæ¦‚ç®—ï¼‰ï¼šç¾è¡Œä¾¡æ ¼=${decidedYM}æ±ºå®š â†’ ç¾åœ¨ã¾ã§ ç´„${pct1(mwX.cum)}%ï¼ˆ${prefLabel}ï¼‰`
      : `ç´¯ç©æœ€ä½è³ƒé‡‘ï¼ˆæ¦‚ç®—ï¼‰ï¼šç®—å‡ºä¸å¯`;

    const cpiSinceHow = (decidedYM && x)
      ? `ç®—å‡ºå¼ï¼ˆæ¦‚ç®—ï¼‰ï¼šæ¶ˆè²»è€…ç‰©ä¾¡æŒ‡æ•°ãŠã‚ˆã³ã‚¨ãƒªã‚¢åˆ¥æœ€ä½è³ƒé‡‘ã®éå»å¹´æ¬¡æ¨ç§»ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãå¤‰å‹•ç‡`
      : `ç®—å‡ºå¼ï¼šâ€”`;

    const srcLine = `å‡ºå…¸ãƒªãƒ³ã‚¯ï¼ˆç‰©ä¾¡çµ±è¨ˆãƒ»æœ€ä½è³ƒé‡‘ï¼‰ï¼š\n  ãƒ»https://www.stat.go.jp/data/cpi/sokuhou/tsuki/pdf/doukou.pdf (ç·å‹™çœçµ±è¨ˆå±€)\n  ãƒ»https://www.jil.go.jp/kokunai/statistics/timeseries/html/g0601.html (JILPT)\n  ãƒ»https://www.mhlw.go.jp/content/11200000/001571219.xlsx (åšåŠ´çœ)`;

    const factors = getSelectedValues('#factorGroup');
    const extra = (extraFactors.value||'').trim();
    const factorText = factors.length>0 ? joinJa(factors) : 'ï¼ˆæœªé¸æŠï¼‰';
    const extraText = extra ? `è£œè¶³ï¼š${extra}` : 'è£œè¶³ï¼šâ€”';

    const efforts = getSelectedValues('#effortGroup');
    const effortText = efforts.length>0 ? joinJa(efforts) : 'ï¼ˆæœªé¸æŠï¼‰';

    // é¡§å®¢ã‚¿ã‚¤ãƒ—ã®æ—¥æœ¬èªåŒ–
    const customerTypes = getSelectedValues('#customerGroup');
    const customerLabels = {
      'strategic': 'æˆ¦ç•¥é¡§å®¢ï¼ˆæœ€é‡è¦ï¼‰',
      'profitable': 'å„ªè‰¯é¡§å®¢',
      'marginal': 'æ¡ç®—ã‚®ãƒªã‚®ãƒª',
      'loss': 'èµ¤å­—é¡§å®¢'
    };
    const customerTypeStr = customerTypes.length > 0 ? customerLabels[customerTypes[0]] : 'æŒ‡å®šãªã—';

    const dataFreshnessNote = `\nã€ãƒ‡ãƒ¼ã‚¿é®®åº¦ã€‘${DATA_FRESHNESS.last_verified}æ™‚ç‚¹\n- CPI: ${DATA_FRESHNESS.cpi_base}\n- æœ€ä½è³ƒé‡‘: ${DATA_FRESHNESS.min_wage}\nâ€»æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã¯åšç”ŸåŠ´åƒçœãƒ»ç·å‹™çœã®å…¬å¼ç™ºè¡¨ã‚’å¿…ãšç¢ºèªã—ã¦ãã ã•ã„ã€‚`;

    return [
      `ã€å¯¾è±¡ã€‘${prod}`,
      `ã€æ”¹å®šã€‘${rateStr} ï¼ é©ç”¨ï¼š${dateStr}`,
      decidedYM ? `ã€ç¾è¡Œä¾¡æ ¼ã®æ±ºå®šæ™‚æœŸã€‘${decidedYM}` : `ã€ç¾è¡Œä¾¡æ ¼ã®æ±ºå®šæ™‚æœŸã€‘æœªå…¥åŠ›`,
      `ã€å¥‘ç´„ã«ãŠã‘ã‚‹æ”¹å®šæ¡é …ã€‘${clauseStr}`,
      `ã€é¡§å®¢ã‚¿ã‚¤ãƒ—ï¼ˆæˆ¦ç•¥ï¼‰ã€‘${customerTypeStr}`,
      ``,
      `â–  æ ¹æ‹ ï¼ˆèª¬æ˜ç”¨ãƒ¡ãƒ¢ï¼‰`,
      `- ${mwLine}`,
      `- ${cpiLine}`,
      `- ${wageLine}`,
      `- ${cpiSinceLine}`,
      `- ${mwSinceLine}`,
      `  ${cpiSinceHow}`,
      `- ${srcLine}`,
      ``,
      `â–  å¤–éƒ¨è¦å› ï¼ˆé¸æŠï¼‰`,
      `- ${factorText}`,
      `- ${extraText}`,
      ``,
      `â–  è‡ªåŠ©åŠªåŠ›ï¼ˆé¸æŠï¼‰`,
      `- ${effortText}`,
      dataFreshnessNote
    ].join('\n');
  }

  /* =========================
     10) æœ¬æ–‡ãƒ»ãƒˆãƒ¼ã‚¯ç”Ÿæˆ
     ========================= */
  function buildLetterAndTalk(){
    const prod = productName.value.trim() || 'ï¼¿ï¼¿ï¼¿ï¼¿ï¼ˆå¯¾è±¡å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹ï¼‰';
    const cp = toNum(currentPrice.value);
    const np = toNum(newPrice.value);
    const dateStr = effectiveDate.value.trim() || 'ï¼¿ï¼¿å¹´ï¼¿ï¼¿æœˆï¼¿ï¼¿æ—¥';
    const decidedYM = fmtYM(currentPriceAsOf.value);

    const cpStr = isFinite(cp) ? yen(cp) : 'ï¼¿ï¼¿ï¼¿å††';
    const npStr = isFinite(np) ? yen(np) : 'ï¼¿ï¼¿ï¼¿å††';

    let rateStr = `${cpStr} â†’ ${npStr}`;
    if(isFinite(cp) && isFinite(np) && cp > 0) {
      const rate = ((np / cp) - 1) * 100;
      const sign = rate >= 0 ? 'å¢—' : 'æ¸›';
      rateStr = `${cpStr} â†’ ${npStr}ï¼ˆç´„${pct1(Math.abs(rate))}%${sign}ï¼‰`;
    }

    const factors = getSelectedValues('#factorGroup');
    const extra = (extraFactors.value||'').trim();
    const factorText = factors.length > 0 ? joinJa(factors) : 'åŸææ–™è²»ãƒ»ç‰©æµè²»ãƒ»äººä»¶è²»ç­‰ã®ä¸Šæ˜‡';
    
    // è£œè¶³ãŒã‚ã‚‹å ´åˆã¯ã€Œï½ã«åŠ ãˆã€ã€‡ã€‡ã€ã¨çµåˆ
    const combinedFactors = extra ? `${factorText}ã«åŠ ãˆã€${extra}` : factorText;

    const efforts = getSelectedValues('#effortGroup');
    const effortText = efforts.length > 0 ? joinJa(efforts) : 'å¾¹åº•ã—ãŸã‚³ã‚¹ãƒˆå‰Šæ¸›';

    const relation = getSelectedValues('#relationGroup')[0] || 'B';

    const naturalEvidence = buildNaturalEvidencePhrase();      
    const referenceBlock = buildReferenceBlock(decidedYM);

    let decidedLine = '';
    if (decidedYM) {
      const x = calcCpiSince();
      const mwX = calcMwSince();
      if (x && x.cum > 0 && mwX && mwX.cum > 0) {
        decidedLine = `ç¾è¡Œä¾¡æ ¼ã¯${decidedYM}ã«æ±ºå®šä»¥æ¥ã€å¯èƒ½ãªé™ã‚Šæ®ãˆç½®ã„ã¦ã¾ã„ã‚Šã¾ã—ãŸãŒã€ãã‚Œä»¥æ¥ã€ç¾åœ¨ã¾ã§ã®ç´¯ç©ç‰©ä¾¡ä¸Šæ˜‡ç‡ã¯${pct1(x.cum)}%ã‚’è¶…ãˆã¦ãŠã‚Šã¾ã™ã€‚ã¾ãŸã€ãã®é–“ã®æœ€ä½è³ƒé‡‘ä¸Šæ˜‡ç‡ã¯${pct1(mwX.cum)}ï¼…ã‚’è¶…ãˆã¦ãŠã‚Šã¾ã™ã€‚`;
      } else if (x && x.cum > 0) {
        decidedLine = `ç¾è¡Œä¾¡æ ¼ã¯${decidedYM}ã«æ±ºå®šä»¥æ¥ã€å¯èƒ½ãªé™ã‚Šæ®ãˆç½®ã„ã¦ã¾ã„ã‚Šã¾ã—ãŸãŒã€ãã‚Œä»¥æ¥ã€ç¾åœ¨ã¾ã§ã®ç´¯ç©ç‰©ä¾¡ä¸Šæ˜‡ç‡ã¯${pct1(x.cum)}%ã‚’è¶…ãˆã¦ãŠã‚Šã¾ã™ã€‚`;
      } else {
        decidedLine = `ç¾è¡Œä¾¡æ ¼ã¯${decidedYM}ã«æ±ºå®šä»¥æ¥ã€å¯èƒ½ãªé™ã‚Šæ®ãˆç½®ã„ã¦ã¾ã„ã‚Šã¾ã—ãŸã€‚`;
      }
    }

    let letter = '';
    if(relation === 'A') {
      letter =
`ä»¶åï¼šã€é‡è¦ã€‘ä¾¡æ ¼æ”¹å®šã®ãŠé¡˜ã„ï¼ˆ${prod}ï¼‰

ã€‡ã€‡æ ªå¼ä¼šç¤¾
ã€‡ã€‡æ§˜

ã„ã¤ã‚‚å¤§å¤‰ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
[è‡ªç¤¾å]ã®[æ°å]ã§ã”ã–ã„ã¾ã™ã€‚

å¹³ç´ ã‚ˆã‚Šæ ¼åˆ¥ã®ã”é«˜é…ã‚’è³œã‚Šã€å¿ƒã‚ˆã‚Šå¾¡ç¤¼ç”³ã—ä¸Šã’ã¾ã™ã€‚

æœ¬æ—¥ã¯ã€èª ã«å¿ƒè‹¦ã—ã„ãŠé¡˜ã„ãŒã‚ã‚Šã”é€£çµ¡ã„ãŸã—ã¾ã—ãŸã€‚
æ˜¨ä»Šã®${combinedFactors}ã«ã‚ˆã‚Šã€å½“ç¤¾ã‚’å–ã‚Šå·»ãã‚³ã‚¹ãƒˆç’°å¢ƒãŒç¶™ç¶šçš„ã«å³ã—ããªã£ã¦ãŠã‚Šã¾ã™ã€‚
${naturalEvidence ? naturalEvidence : ''}

${decidedLine}
å½“ç¤¾ã¨ã—ã¦ã‚‚ã€${effortText}ã‚’é‡ã­ã€å“è³ªãƒ»æä¾›ä½“åˆ¶ã‚’ç¶­æŒã™ã‚‹åŠªåŠ›ã‚’ç¶šã‘ã¦ã¾ã„ã‚Šã¾ã—ãŸãŒã€ç¾è¡Œä¾¡æ ¼ã®ã¾ã¾ã§ã¯å®‰å®šçš„ãªæä¾›ã®ç¶™ç¶šãŒå›°é›£ãªå±€é¢ã¨ãªã‚Šã¾ã—ãŸã€‚

ã¤ãã¾ã—ã¦ã¯ã€èª ã«æç¸®ã§ã¯ã”ã–ã„ã¾ã™ãŒã€ä»¥ä¸‹ã®ã¨ãŠã‚Šä¾¡æ ¼æ”¹å®šã‚’ãŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚

ã€æ”¹å®šå†…å®¹ã€‘
ãƒ»å¯¾è±¡ï¼š${prod}
ãƒ»æ”¹å®šä¾¡æ ¼ï¼š${rateStr}
ãƒ»é©ç”¨æ™‚æœŸï¼š${dateStr}

ã”è² æ‹…ã‚’ãŠã‹ã‘ã—å¤§å¤‰ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚
é ‚æˆ´ã™ã‚‹ã”è² æ‹…ã«è¦‹åˆã†å“è³ªãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç¶­æŒã—ã€ä»Šå¾Œã‚‚ç¶™ç¶šçš„ã«è²¢çŒ®ã§ãã‚‹ã‚ˆã†å°½åŠ›ã„ãŸã—ã¾ã™ã€‚

ã”ä¸æ˜ç‚¹ã‚„ã”ç›¸è«‡ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€é æ…®ãªããŠç”³ã—ä»˜ã‘ãã ã•ã„ã€‚
ä½•å’ã€è«¸äº‹æƒ…ã‚’ã”è³¢å¯Ÿã„ãŸã ãã€ã”ç†è§£ã‚’è³œã‚Šã¾ã™ã‚ˆã†ãŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚${referenceBlock}`;
    } else if(relation === 'B') {
      letter =
`ä»¶åï¼šã€é‡è¦ã€‘${prod} ä¾¡æ ¼æ”¹å®šã®ãŠé¡˜ã„

ã€‡ã€‡æ ªå¼ä¼šç¤¾
ã€‡ã€‡æ§˜

ã„ã¤ã‚‚å¤§å¤‰ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
[è‡ªç¤¾å]ã®[æ°å]ã§ã”ã–ã„ã¾ã™ã€‚

å¹³ç´ ã¯å¼Šç¤¾ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã”åˆ©ç”¨ã„ãŸã ãèª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
ã•ã¦ã€æ˜¨ä»Šã®${combinedFactors}ã«ã‚ˆã‚Šã€å„ç¨®ã‚³ã‚¹ãƒˆãŒä¸Šæ˜‡ã—ã¦ãŠã‚Šã¾ã™ã€‚
${naturalEvidence ? naturalEvidence : ''}

${decidedLine}
å¼Šç¤¾ã¨ã—ã¦ã‚‚ã€${effortText}ãªã©å¯èƒ½ãªå¯¾ç­–ã‚’è¬›ã˜ã¦ã¾ã„ã‚Šã¾ã—ãŸãŒã€ç¾è¡Œä¾¡æ ¼ã®ã¾ã¾ã§ã¯å¾“æ¥ã®å“è³ªãŠã‚ˆã³å®‰å®šä¾›çµ¦ã®ç¶­æŒãŒå›°é›£ã¨ãªã‚Šã¾ã—ãŸã€‚

ã¤ãã¾ã—ã¦ã¯ã€èª ã«ä¸æœ¬æ„ã§ã¯ã”ã–ã„ã¾ã™ãŒã€ä¸‹è¨˜ã®é€šã‚Šä¾¡æ ¼æ”¹å®šã‚’å®Ÿæ–½ã•ã›ã¦ã„ãŸã ããŸãå­˜ã˜ã¾ã™ã€‚

ã€æ”¹å®šå†…å®¹ã€‘
ãƒ»å¯¾è±¡ï¼š${prod}
ãƒ»æ”¹å®šä¾¡æ ¼ï¼š${rateStr}
ãƒ»é©ç”¨æ™‚æœŸï¼š${dateStr}

ãŠå®¢æ§˜ã«ã¯ã”è² æ‹…ã‚’ãŠã‹ã‘ã„ãŸã—ã¾ã™åˆ†ã€ã‚ˆã‚Šä¸€å±¤ã®ã‚µãƒ¼ãƒ“ã‚¹å‘ä¸Šã«åŠªã‚ã¦ã¾ã„ã‚Šã¾ã™ã€‚
ä½•å’ã”ç†è§£è³œã‚Šã¾ã™ã‚ˆã†ãŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚${referenceBlock}`;
    } else {
      letter =
`ä»¶åï¼šã€ã”ç›¸è«‡ã€‘${prod}ã®é©æ­£ä¾¡æ ¼åŒ–ï¼ˆä¾¡æ ¼æ”¹å®šï¼‰ã«ã¤ã„ã¦

ã€‡ã€‡æ ªå¼ä¼šç¤¾
ã€‡ã€‡æ§˜

ã„ã¤ã‚‚å¤§å¤‰ãŠä¸–è©±ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚
[è‡ªç¤¾å]ã®[æ°å]ã§ã”ã–ã„ã¾ã™ã€‚

æœ¬æ—¥ã¯ã€ä»Šå¾Œã®ç¶™ç¶šæä¾›ã®å‰æã¨ãªã‚‹ã€Œé©æ­£ä¾¡æ ¼åŒ–ã€ã«ã¤ã„ã¦ã€ã”ç›¸è«‡ç”³ã—ä¸Šã’ã¾ã™ã€‚
æ˜¨ä»Šã®${combinedFactors}ãŒå¸¸æ…‹åŒ–ã—ã¦ãŠã‚Šã€å½“ç¤¾ã®ã‚³ã‚¹ãƒˆæ§‹é€ ã«ã‚‚ç¶™ç¶šçš„ãªå½±éŸ¿ãŒå‡ºã¦ãŠã‚Šã¾ã™ã€‚
${naturalEvidence ? naturalEvidence : ''}

${decidedLine}
å½“ç¤¾ã¨ã—ã¦ã‚‚ã€${effortText}ã‚’ç¶™ç¶šã—ã¦ã¾ã„ã‚Šã¾ã—ãŸãŒã€ä¼æ¥­åŠªåŠ›ã®ã¿ã§ã‚³ã‚¹ãƒˆå¢—ã‚’å¸åã—ç¶šã‘ã‚‹ã“ã¨ãŒå›°é›£ã¨ãªã‚Šã¾ã—ãŸã€‚
ã“ã®ã¾ã¾ã§ã¯ã€${prod}ã€ã®å“è³ªãƒ»æä¾›ä½“åˆ¶ã«æ”¯éšœãŒå‡ºã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ãŸã‚ã€é¿ã‘ã‚‹ã¹ãã¨åˆ¤æ–­ã—ã¦ãŠã‚Šã¾ã™ã€‚

ã¤ãã¾ã—ã¦ã¯ã€ä»¥ä¸‹ã®ç›®å®‰ã§ä¾¡æ ¼æ”¹å®šã®å”è­°ã‚’ãŠé¡˜ã„ã—ãŸãå­˜ã˜ã¾ã™ã€‚

ã€ãŠé¡˜ã„ã—ãŸã„æ”¹å®šå†…å®¹ï¼ˆç›®å®‰ï¼‰ã€‘
ãƒ»å¯¾è±¡ï¼š${prod}
ãƒ»æ”¹å®šä¾¡æ ¼ï¼ˆç›®å®‰ï¼‰ï¼š${rateStr}
ãƒ»é©ç”¨æ™‚æœŸï¼š${dateStr}

ã‚‚ã—ä¸Šè¨˜ã§ã®å…¨é¢çš„ãªã”æ‰¿èªãŒé›£ã—ã„å ´åˆã§ã‚‚ã€
æ®µéšçš„æ”¹å®šï¼æ¡ä»¶èª¿æ•´ï¼ˆãƒ­ãƒƒãƒˆãƒ»å¥‘ç´„æœŸé–“ãƒ»ä¸€éƒ¨ä»•æ§˜ç­‰ï¼‰ã‚’å«ã‚ã€åŒæ–¹ãŒç´å¾—ã§ãã‚‹ç€åœ°ç‚¹ã‚’æ¨¡ç´¢ã—ãŸãå­˜ã˜ã¾ã™ã€‚

è¿‘æ—¥ä¸­ã«ãŠæ‰“ã¡åˆã‚ã›ã®æ©Ÿä¼šã‚’é ‚æˆ´ã§ãã¾ã™ã¨å¹¸ã„ã§ã™ã€‚
ä½•å’ã‚ˆã‚ã—ããŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™ã€‚${referenceBlock}`;
    }

    const ttl = (relation==='A') ? 'ä¿¡é ¼é–¢ä¿‚ãŒã‚ã‚‹é¡§å®¢å‘ã‘' : (relation==='B') ? 'æ¨™æº–ã®å–å¼•å…ˆå‘ã‘' : 'ä¾¡æ ¼ã«å³ã—ã„é¡§å®¢å‘ã‘';
    
    const objectionHandling = `
â–  5. æƒ³å®šåè«–ã¸ã®åˆ‡ã‚Šè¿”ã—ï¼ˆè¿½åŠ ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰

ã€åè«–1ã€‘ã€Œä»–ç¤¾ã¯ã¾ã ä¸Šã’ã¦ã„ãªã„ã€
å›ç­”ä¾‹: ã€Œä»–ç¤¾æ§˜ã®çŠ¶æ³ã¯å­˜ã˜ä¸Šã’ã¾ã›ã‚“ãŒã€å½“ç¤¾ã®åŸä¾¡æ§‹é€ ã§ã¯ç¾è¡Œä¾¡æ ¼ã®ç¶­æŒãŒé™ç•Œã§ã™ã€‚å“è³ªã‚’è½ã¨ã•ãšæä¾›ã‚’ç¶šã‘ã‚‹ã«ã¯ã€é©æ­£ä¾¡æ ¼ã¸ã®è¦‹ç›´ã—ãŒä¸å¯æ¬ ã¨ã”ç†è§£ãã ã•ã„ã€‚ã€

ã€åè«–2ã€‘ã€Œãã¡ã‚‰ã®éƒ½åˆã§ã—ã‚‡ã†ã€
å›ç­”ä¾‹: ã€Œæœ€ä½è³ƒé‡‘æ”¹å®šãƒ»ç‰©ä¾¡ä¸Šæ˜‡ã¯å…¬çš„çµ±è¨ˆã§ã‚‚æ˜ã‚‰ã‹ãªå¤–éƒ¨è¦å› ã§ã™ï¼ˆè³‡æ–™æç¤ºï¼‰ã€‚å½“ç¤¾ã ã‘ã®éƒ½åˆã§ã¯ãªãã€æ¥­ç•Œå…¨ä½“ãŒç›´é¢ã—ã¦ã„ã‚‹æ§‹é€ çš„ãªèª²é¡Œã§ã™ã€‚ã€

ã€åè«–3ã€‘ã€Œå¥‘ç´„æœŸé–“ä¸­ã®å¤‰æ›´ã¯èªã‚ã‚‰ã‚Œãªã„ã€
å›ç­”ä¾‹: ã€Œç¾å¥‘ç´„ã¯â—‹å¹´â—‹æœˆã¾ã§ã¨æ‰¿çŸ¥ã—ã¦ãŠã‚Šã¾ã™ã€‚æœ¬æ—¥ã¯æ¬¡å›æ›´æ–°æ™‚ã®ä¾¡æ ¼ã«ã¤ã„ã¦ã”ç›¸è«‡ã§ã™ã€‚ï¼ˆã¾ãŸã¯ï¼šäº‹æƒ…å¤‰æ›´ã®åŸå‰‡ã«åŸºã¥ãã€å¥‘ç´„æœŸé–“ä¸­ã§ã‚‚å”è­°ã‚’ãŠé¡˜ã„ã§ãã‚Œã°ã¨å­˜ã˜ã¾ã™ï¼‰ã€

ã€åè«–4ã€‘ã€Œå€¤ä¸Šã’ãªã‚‰å–å¼•åœæ­¢ã‚‚æ¤œè¨ã™ã‚‹ã€
å›ç­”ä¾‹: ã€Œãã‚Œã¯å¤§å¤‰æ®‹å¿µã§ã™ã€‚ãŸã ã€ç¾è¡Œä¾¡æ ¼ã§ã¯èµ¤å­—ãŒç¶šãã€ã„ãšã‚Œæä¾›ä½“åˆ¶ã®ç¶­æŒãŒå›°é›£ã§ã™ã€‚å–å¼•ç¶™ç¶šã‚’å‰æã«ã€æ®µéšæ”¹å®šã‚„æ¡ä»¶èª¿æ•´ãªã©ã€ä½•ã‹æŠ˜è¡·æ¡ˆã‚’æ¢ã‚Œã¾ã›ã‚“ã§ã—ã‚‡ã†ã‹ã€‚ã€`;

    let decidedTalk = decidedYM ? `ã€Œã¾ãŸã€ç¾è¡Œä¾¡æ ¼ã¯${decidedYM}ã«æ±ºå®šä»¥æ¥ã€å¯èƒ½ãªé™ã‚Šæ®ãˆç½®ã„ã¦ãã¾ã—ãŸã€‚ã€` : '';
    const xTalk = calcCpiSince();
    const mwXTalk = calcMwSince();
    if(decidedYM && xTalk && xTalk.cum > 0 && mwXTalk && mwXTalk.cum > 0){
       decidedTalk = `ã€Œã¾ãŸã€ç¾è¡Œä¾¡æ ¼ã¯${decidedYM}ã«æ±ºå®šä»¥æ¥ã€å¯èƒ½ãªé™ã‚Šæ®ãˆç½®ã„ã¦ãã¾ã—ãŸãŒã€ãã‚Œä»¥æ¥ã®ç´¯ç©ç‰©ä¾¡ä¸Šæ˜‡ç‡ã¯${pct1(xTalk.cum)}%ã‚’è¶…ãˆã€æœ€ä½è³ƒé‡‘ä¸Šæ˜‡ç‡ã‚‚${pct1(mwXTalk.cum)}ï¼…ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ã€`;
    } else if(decidedYM && xTalk && xTalk.cum > 0){
       decidedTalk = `ã€Œã¾ãŸã€ç¾è¡Œä¾¡æ ¼ã¯${decidedYM}ã«æ±ºå®šä»¥æ¥ã€å¯èƒ½ãªé™ã‚Šæ®ãˆç½®ã„ã¦ãã¾ã—ãŸãŒã€ãã‚Œä»¥æ¥ã®ç´¯ç©ç‰©ä¾¡ä¸Šæ˜‡ç‡ã¯${pct1(xTalk.cum)}%ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚ã€`;
    }

    const talk =
`ã€${ttl} é¢è«‡ãƒˆãƒ¼ã‚¯ã€‘

â–  1. å†’é ­ï¼ˆçŠ¶æ³å…±æœ‰ï¼‰
ã€Œæœ¬æ—¥ã¯ãŠæ™‚é–“ã‚’ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚å®Ÿã¯æœ¬æ—¥ã€å°‘ã—å¿ƒè‹¦ã—ã„ã”ç›¸è«‡ãŒã”ã–ã„ã¾ã™ã€‚
æ˜¨ä»Šã®${combinedFactors}ã®å½±éŸ¿ãŒå¼Šç¤¾ã«ã‚‚åŠã³ã€ã‚³ã‚¹ãƒˆç’°å¢ƒãŒå³ã—ã„çŠ¶æ³ã§ã™ã€‚ã€

â–  2. æ ¹æ‹ ã®æç¤ºï¼ˆçŸ­ããƒ»è‡ªç„¶ã«ï¼‰
${naturalEvidence ? `ã€Œ${naturalEvidence}ã€` : 'ã€Œå¤–éƒ¨ç’°å¢ƒã®å¤‰åŒ–ãŒç¶šã„ã¦ã„ã¾ã™ã€‚ã€'}
${decidedTalk}

â–  3. è‡ªåŠ©åŠªåŠ›ã®æç¤ºã¨é™ç•Œ
ã€Œã‚‚ã¡ã‚ã‚“å¾¡ç¤¾ã«ã”è¿·æƒ‘ã‚’ãŠã‹ã‘ã§ããªã„ã¨ã€${effortText}ã‚’ç¶šã‘ã¦ãã¾ã—ãŸãŒã€
ç¤¾å†…åŠªåŠ›ã ã‘ã§ã¯å¸åã§ããªã„æ°´æº–ã«ãªã‚Šã¾ã—ãŸã€‚ã€

â–  4. çµè«–ï¼ˆæ”¹å®šã®æ‰“è¨ºï¼‰
ã€Œã“ã®ã¾ã¾ã§ã™ã¨ã€${prod}ã€ã®å“è³ªç¶­æŒã‚„æä¾›ä½“åˆ¶ã«æ”¯éšœãŒå‡ºã‚‹æã‚ŒãŒã‚ã‚Šã¾ã™ã€‚
ã¤ãã¾ã—ã¦ã¯ã€${dateStr}ã‚ˆã‚Šã€ã€ ${rateStr} ã€‘ã¸ã®è¦‹ç›´ã—ã‚’ã”ç›¸è«‡ã§ããªã„ã§ã—ã‚‡ã†ã‹ã€‚ã€
${objectionHandling}

â–  6. ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆæ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
ã€Œæœ¬æ—¥ã„ãŸã ã„ãŸã”æ„è¦‹ã‚’è¸ã¾ãˆã€ç€åœ°ç‚¹æ¡ˆï¼ˆæ®µéšæ”¹å®šï¼æ¡ä»¶èª¿æ•´ç­‰ï¼‰ã‚’æ•´ç†ã—ã¦æ”¹ã‚ã¦ã”ææ¡ˆã—ã¾ã™ã€‚ã€`;

    return { letter, talk };
  }

  let CACHE = { letter:'', talk:'', memo:'' };

  function renderOutput(){
    if(currentOutputMode === 'letter') outputArea.value = CACHE.letter || '';
    else if(currentOutputMode === 'talk') outputArea.value = CACHE.talk || '';
    else outputArea.value = CACHE.memo || '';
  }

  function generate(){
    try {
      updateRateHint();
      validateBasic();
      validatePriceIncrease();
      updateCpiSinceView();

      const lt = buildLetterAndTalk();
      const memo = buildMemoText();

      CACHE.letter = lt.letter;
      CACHE.talk = lt.talk;
      CACHE.memo = memo;

      renderOutput();

      if(printLetter) printLetter.textContent = CACHE.letter || '';
      if(printMemo) printMemo.textContent = CACHE.memo || '';
    } catch (err) {
      console.error(err);
      if(outputArea) outputArea.value = 'â€»æ–‡é¢ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n' + err.message;
    }
  }

  function showCopied(){
    copyStatus.classList.add('show');
    clearTimeout(showCopied._t);
    showCopied._t = setTimeout(() => copyStatus.classList.remove('show'), 2000);
  }

  async function copyText(text){
    if(navigator.clipboard && window.isSecureContext){
      try{ await navigator.clipboard.writeText(text); return true; }catch(e){}
    }
    try{
      outputArea.removeAttribute('readonly');
      outputArea.select();
      outputArea.setSelectionRange(0, outputArea.value.length);
      const ok = document.execCommand('copy');
      outputArea.setAttribute('readonly','');
      window.getSelection().removeAllRanges();
      return !!ok;
    }catch(e){
      try{ outputArea.setAttribute('readonly',''); }catch(_){}
      return false;
    }
  }

  copyBtn.addEventListener('click', async () => {
    const ok = await copyText(outputArea.value || '');
    if(ok) showCopied();
  });

  printBtn.addEventListener('click', () => { try{ window.print(); }catch(e){} });

  [productName, currentPriceAsOf, effectiveDate, extraFactors,
   embedNumbersInLetter, linkRates, cpiRate, wageRate, cpiAsOf, wageAsOf]
    .forEach(el => el.addEventListener('input', generate));

  linkRates.addEventListener('change', ()=>{
    renderAllByPref();
    generate();
  });

  prefSelect.addEventListener('change', () => {
    setLocal('mk_pref_key', prefSelect.value);
    renderAllByPref();
    generate();
  });

  if(loadDataBtn) loadDataBtn.addEventListener('click', () => loadCostData(dataUrl.value, false));
  if(clearDataBtn) clearDataBtn.addEventListener('click', () => clearCostData());

  function getUrlParams(){
    const params = new URLSearchParams(window.location.search);
    let hasParam = false;

    const p = params.get('price') || params.get('P');
    if(p && isFinite(toNum(p))){
      currentPrice.value = Math.round(toNum(p)).toLocaleString('ja-JP');
      markImported(currentPrice);
      hasParam = true;
    }
    const p2 = params.get('P2') || params.get('chgAbs');
    if(p2 && isFinite(toNum(p2))){
      newPrice.value = Math.round(toNum(p2)).toLocaleString('ja-JP');
      markImported(newPrice);
      hasParam = true;
    }

    const prod = params.get('product') || params.get('prod');
    if(prod){
      productName.value = String(prod);
      markImported(productName);
      hasParam = true;
    }
    const dt = params.get('date') || params.get('effectiveDate');
    if(dt){
      effectiveDate.value = String(dt);
      markImported(effectiveDate);
      hasParam = true;
    }

    const pref = params.get('pref');
    if(pref){
      const k = normalizePrefKey(pref);
      if(PREF_LABEL[k]){
        prefSelect.value = k;
        markImported(prefSelect);
        hasParam = true;
      }
    }

    if(hasParam){
      showImportStatus('âœ… è»¢è¨˜ï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å€¤ã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸã€‚');
    }
    return hasParam;
  }

  function resetChips(groupId){
    const g = $(groupId);
    if(!g) return;
    const chips = Array.from(g.querySelectorAll('.chip'));
    chips.forEach(c=>c.classList.remove('active'));
    if(groupId==='#clauseGroup'){
      const c = chips.find(x=>x.getAttribute('data-val')==='clause_unknown');
      if(c) c.classList.add('active');
      return;
    }
    if(groupId==='#relationGroup'){
      const b = chips.find(x=>x.getAttribute('data-val')==='B');
      if(b) b.classList.add('active');
      return;
    }
    if(groupId==='#effortGroup'){
      chips.filter(x=>['å¾¹åº•ã—ãŸçµŒè²»å‰Šæ¸›','æ•°å¹´é–“ã«ã‚ãŸã‚‹ä¾¡æ ¼æ®ãˆç½®ã'].includes(x.getAttribute('data-val'))).forEach(x=>x.classList.add('active'));
      return;
    }
    if(groupId==='#factorGroup'){
      chips.filter(x=>['åŸææ–™ãƒ»ä»•å…¥ã‚³ã‚¹ãƒˆã®ä¸Šæ˜‡','äººä»¶è²»ï¼ˆè³ƒä¸Šã’ãƒ»æ¡ç”¨é›£ï¼‰ã«ã‚ˆã‚‹è² æ‹…å¢—'].includes(x.getAttribute('data-val'))).forEach(x=>x.classList.add('active'));
      return;
    }
  }

  resetBtn.addEventListener('click', () => {
    [productName,currentPrice,newPrice,currentPriceAsOf,effectiveDate,extraFactors].forEach(el=>{
      el.value='';
      el.classList.remove('imported-value');
    });

    embedNumbersInLetter.checked = true;
    linkRates.checked = true;
    
    validationWarning.style.display = 'none';

    resetChips('#clauseGroup');
    resetChips('#factorGroup');
    resetChips('#effortGroup');
    resetChips('#relationGroup');
    resetChips('#customerGroup');

    prefSelect.value = 'é³¥å–';
    setLocal('mk_pref_key','é³¥å–');

    renderAllByPref();
    generate();
  });

  try{
    $('#cpy-year').textContent = String(new Date().getFullYear());
    const ld = new Date(document.lastModified);
    const ymd = isNaN(ld.getTime()) ? '' : `${ld.getFullYear()}-${z2(ld.getMonth()+1)}-${z2(ld.getDate())}`;
    $('#last-updated-date').textContent = ymd;
  }catch(e){}

  try{
    if(jsonSample) jsonSample.textContent = JSON.stringify(SAMPLE_JSON, null, 2);
  }catch(e){}

  function setHelp(txt){ helpBox.textContent = txt || ''; }
  if(helpCpi) helpCpi.addEventListener('click', ()=>{
    setHelp('ç‰©ä¾¡ä¸Šæ˜‡ç‡ã¯ã€å…¬çš„çµ±è¨ˆï¼ˆCPI=æ¶ˆè²»è€…ç‰©ä¾¡æŒ‡æ•°ãªã©ï¼‰ã‚’å‚è€ƒã«ã€Œç‰©ä¾¡ãŒã©ã®ç¨‹åº¦ä¸ŠãŒã£ã¦ã„ã‚‹ã‹ã€ã‚’ç¤ºã™ç›®çš„ã§ç½®ã„ã¦ã„ã¾ã™ã€‚æœ¬æ–‡ã§ã¯å°‚é–€ç”¨èªã‚’é¿ã‘ã€ã€Œå…¬çš„çµ±è¨ˆã§ã¯ç‰©ä¾¡ãŒâ€¦ã€ã®è¡¨ç¾ã«ç½®æ›ã—ã¦ã„ã¾ã™ã€‚');
  });
  if(helpWage) helpWage.addEventListener('click', ()=>{
    setHelp('äººä»¶è²»ä¸Šæ˜‡ç‡ã¯ã€è³ƒä¸Šã’ç‡ã ã‘ã§ãªãæ¡ç”¨é›£ï¼ˆæ±‚äººæ¡ä»¶ã®ä¸ŠæŒ¯ã‚Œï¼‰ãƒ»å¤–æ³¨å˜ä¾¡ä¸Šæ˜‡ãªã©ã‚‚å«ã‚€ã€Œå®Ÿå‹™ã®è² æ‹…å¢—ã€ã‚’èª¬æ˜ã™ã‚‹ãŸã‚ã®å‚è€ƒå€¤ã§ã™ã€‚å¯èƒ½ãªã‚‰è‡ªç¤¾ã®æ¡ç”¨å˜ä¾¡ã‚„æ±‚äººæ¡ä»¶ã®å¤‰åŒ–ã‚’è£œè¶³æ¬„ã«ä¸€æ–‡å…¥ã‚Œã‚‹ã¨å¼·ã„ã§ã™ã€‚');
  });
  if(helpScope) helpScope.addEventListener('click', ()=>{
    setHelp('ç‰©ä¾¡/è³ƒé‡‘ã®éƒ½é“åºœçœŒåˆ¥ãƒ‡ãƒ¼ã‚¿ãŒå¸¸ã«æƒã†ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚æœ¬ãƒ„ãƒ¼ãƒ«ã¯ã€Œéƒ½é“åºœçœŒåˆ¥ãŒJSONã«ã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ç„¡ã‘ã‚Œã°å…¨å›½å€¤ï¼ˆå‚è€ƒï¼‰ã€ã®è¨­è¨ˆã§ã™ã€‚ç”»é¢ã®ãƒãƒƒã‚¸ã§ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æ˜ç¤ºã—ã¾ã™ã€‚');
  });

  buildPrefOptions();

  const savedPref = getLocal('mk_pref_key');
  if(savedPref && PREF_LABEL[savedPref]) prefSelect.value = savedPref;
  else prefSelect.value = 'é³¥å–';

  const savedUrl = getLocal('mk_cost_data_url');
  if(dataUrl && savedUrl) dataUrl.value = savedUrl;

  loadCostData(savedUrl || './pref_cost_data.json', true);

  renderAllByPref();
  getUrlParams();

  generate();

})();
</script>

<script src="https://takatrp.github.io/tool-portal/mk-nav.js" defer></script>
</body>
</html>
