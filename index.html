<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>値上げ交渉ナビゲーター（全国版）</title>

  <link rel="icon" type="image/png" sizes="192x192" href="favicon192192.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="favicon192192.png" />
  <link rel="shortcut icon" href="favicon192192.png" />

  <style>
    :root{
      --brand:#578899;--ink:#1f2937;--muted:#6b7280;--bg:#f7fafc;--ok:#10b981;--warn:#ef4444;
      --card:#fff;--grid:#e5e7eb;--soft:rgba(87,136,153,.10);
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Meiryo",sans-serif;}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    .header{display:flex;align-items:center;gap:12px;margin:6px 0 8px}
    .logo{height:56px;width:auto;object-fit:contain;border-radius:8px}
    .title{font-weight:900;font-size:1.22rem;color:#0f172a;display:flex;align-items:center;gap:8px}
    .headRight{margin-left:auto;display:flex;gap:6px;align-items:center}
    .sub{font-size:.86rem;color:var(--muted);margin:0 0 12px}

    .card{background:var(--card);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px;margin-bottom:12px}
    .pill{display:inline-block;background:var(--soft);color:var(--brand);font-weight:900;border-radius:999px;padding:5px 9px;font-size:.82rem;margin-bottom:10px}
    label{display:block;font-size:.86rem;color:#374151;margin:12px 0 6px;font-weight:800}
    input[type="text"],input[type="month"],textarea,select{
      width:100%;box-sizing:border-box;border:1px solid #e5e7eb;border-radius:10px;padding:10px;font-size:1rem;background:#fff;outline:none;
      transition: background-color .2s,border-color .2s,color .2s;
    }
    input:focus,textarea:focus,select:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(87,136,153,.15)}
    input::placeholder,textarea::placeholder{color:#c7ccd3}
    .hint{font-size:.78rem;color:var(--muted);margin-top:4px}
    .danger{color:var(--warn);font-weight:900;margin-top:8px}
    .warningBox{background:#fffbeb;border:1px solid #fde68a;color:#92400e;padding:10px;border-radius:8px;font-size:.82rem;margin-top:8px;white-space:pre-wrap;}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 12px;font-weight:900;font-size:.92rem;cursor:pointer;transition: opacity .2s;}
    .btn:hover{opacity:.9}
    .btn.alt{background:#e5e7eb;color:#111827}
    .btn.ghost{background:transparent;color:#374151;border:1px solid #d1d5db}
    .btn.sm{padding:6px 8px;font-size:.82rem;border-radius:8px}
    .miniActions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}

    .inputGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:520px){.inputGrid{grid-template-columns:1fr}}

    .dashboard{display:block}
    .colL,.colR{display:flex;flex-direction:column;gap:10px}
    @media (min-width:1024px){.dashboard{display:grid;grid-template-columns:420px 1fr;gap:12px;align-items:start}}

    .tabs{display:flex;border-bottom:2px solid #e5e7eb;margin-bottom:12px}
    .tab{padding:8px 16px;font-size:.9rem;font-weight:900;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px}
    .tab.active{color:var(--brand);border-bottom-color:var(--brand)}
    .docArea{min-height:550px;line-height:1.65;font-family:inherit;resize:vertical;background:#f8fafc}
    .statusMsg{font-size:0.85rem;color:var(--ok);font-weight:900;margin-left:auto;opacity:0;transition:opacity .25s;}
    .statusMsg.show{opacity:1;}

    .mk-mini{margin:16px auto 10px;max-width:1100px;color:#374151;font-size:.84rem;text-align:center}
    .mk-mini a{color:inherit;text-decoration:underline}
    .note{font-size:.8rem;color:#6b7280;text-align:center;margin-bottom:24px}

    /* チップ */
    .chipGroup{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;margin-bottom:4px}
    .chip{border:1px solid #d1d5db;background:#fff;border-radius:999px;padding:8px 12px;font-size:.85rem;font-weight:900;color:#374151;cursor:pointer;transition:all .2s;line-height:1.1}
    .chip:hover{background:#f3f4f6}
    .chip.active{border-color:var(--brand);background:#eef6fa;color:#0f172a}

    /* 参考データパネル */
    .dataPanel{border:1px solid #e5e7eb;border-radius:12px;background:#fafafa;padding:10px 12px;margin-top:10px}
    .dataRow{display:flex;gap:10px;flex-wrap:wrap;font-size:.88rem;color:#111827;align-items:center}
    .dataKey{color:#475569;font-weight:900}
    .badge{display:inline-block;border:1px solid #d1d5db;border-radius:999px;padding:2px 8px;font-size:.72rem;color:#334155;background:#fff}
    .badge.ok{border-color:#94a3b8;color:#0f172a}
    .badge.warn{border-color:#f59e0b;color:#92400e;background:#fff7ed}
    .badge.err{border-color:#ef4444;color:#991b1b;background:#fff5f5}
    .small{font-size:.78rem;color:#64748b}
    .divider{height:1px;background:#e5e7eb;margin:12px 0}

    .btn.emphasis{background:#f59e0b;color:#111827;border:1px solid #d97706;}
    .btn.emphasis:hover{opacity:1;background:#fbbf24;}

    .modalOverlay{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;z-index:999}
    .modalOverlay.show{display:flex}
    .modalDialog{width:min(980px,92vw);max-height:88vh;overflow:auto;background:#fff;border-radius:14px;box-shadow:0 20px 40px rgba(0,0,0,.22);padding:14px}
    .modalHeader{display:flex;align-items:center;justify-content:space-between;gap:8px;position:sticky;top:0;background:#fff;padding-bottom:10px}
    .iconBtn{border:1px solid #d1d5db;background:#fff;border-radius:8px;padding:4px 10px;font-weight:900;cursor:pointer}

    .quietLaw summary{font-size:.82rem;color:#64748b;font-weight:700}
    .quietLaw .mutedBox{background:#f9fafb;border-color:#e5e7eb;color:#6b7280;font-size:.78rem}
    .cumValue{display:inline-block;font-size:1.35rem;font-weight:900;color:#0f172a;letter-spacing:.01em}

    /* インポートハイライト */
    input.imported-value, select.imported-value, textarea.imported-value{
      background-color:#fff9e6 !important;border-color:#f2c94c !important;color:var(--warn);font-weight:900;
    }
    .importStatus{margin:8px 0 0;font-size:.82rem;color:#0f172a;background:#eef6fa;border:1px solid #d6eaf3;border-radius:10px;padding:8px 10px;display:none}
    .importStatus.show{display:block}

    /* details */
    details{border:1px solid #e5e7eb;border-radius:12px;background:#ffffff;padding:10px 12px;margin-top:10px}
    summary{cursor:pointer;font-weight:900;color:#0f172a}
    details[open]{background:#fcfeff}
    .mutedBox{margin-top:8px;border:1px dashed #cbd5e1;background:#f8fafc;border-radius:12px;padding:10px}
    pre.sample{white-space:pre-wrap;margin:0;font-size:.78rem;color:#334155}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:.78rem;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:8px;padding:2px 6px}

    /* 管理モード：adminOnly を表示 */
    .adminOnly{display:none !important;}
    .isAdmin .adminOnly{display:block !important;}

    /* STEP1：累積物価上昇（概算）リンク */
    .sourceLink{display:inline-flex;gap:6px;align-items:center;font-size:.78rem;margin-top:6px;flex-wrap:wrap;}
    .sourceLink a{color:#0f172a;text-decoration:underline}
    .sourceLink .badge{padding:2px 6px}

    /* =========================
       印刷：本文と根拠メモを完全分離
       ========================= */
    #printPack{display:none}
    .printSection{background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:14px;margin:0 0 12px}
    .printH1{font-weight:900;font-size:1.05rem;margin:0 0 8px;color:#0f172a}
    .printSub{font-size:.82rem;color:#475569;margin:0 0 10px}
    .printText{white-space:pre-wrap;line-height:1.65;font-size:.92rem}

    @media print{
      body{background:#fff}
      .wrap, footer, .note{display:none !important;}
      #printPack{display:block !important; padding:0; margin:0;}
      .printSection{border:none;border-radius:0;padding:0;margin:0}
      .printDivider{page-break-before:always;}
      .printH1{font-size:1.1rem}
      a{color:#000;text-decoration:underline}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <a href="https://takatrp.github.io/tool-portal/" target="_blank" rel="noopener noreferrer">
        <img src="ロゴ.jpg" alt="ロゴ" class="logo" width="112" height="56" />
      </a>
      <div class="title">値上げ交渉ナビゲーター（全国版） <span class="badge ok">r30</span></div>
      <div class="headRight">
        <button class="btn ghost sm" id="resetBtn" type="button">リセット</button>
      </div>
    </div>
    <div class="sub">背景要因（外部データ＋事情）を整理し、本文（顧客向け）と根拠メモ（社内用）を生成します。</div>

    <div id="importStatus" class="importStatus" role="status" aria-live="polite"></div>

    <div class="dashboard">
      <div class="colL">

        <div class="card">
          <div class="pill">STEP 0：契約確認（必須）</div>

          <label>既存契約における価格改定条項</label>
          <div class="chipGroup" id="clauseGroup">
            <button class="chip" type="button" data-val="clause_yes">改定条項あり</button>
            <button class="chip" type="button" data-val="clause_no">条項なし（要協議）</button>
            <button class="chip active" type="button" data-val="clause_unknown">未確認</button>
          </div>

          <div class="hint" style="color:#ef4444; font-weight:bold;">
            ⚠️ 価格改定条項がない場合、一方的な値上げは原則不可（民法上は相手の同意が必要）。本ツールで生成する文面は「協議の申し入れ」として使用してください。
          </div>

          <details class="quietLaw">
            <summary>独占禁止法の注意点（優越的地位）</summary>
            <div class="mutedBox">
              <div class="small">
                自社が取引上優位な立場にある場合、以下の行為は独禁法違反リスクがあります：
                <ul style="margin:4px 0 8px; padding-left:20px;">
                  <li>短期間での一方的な価格変更通知</li>
                  <li>受け入れない場合の取引停止示唆</li>
                  <li>協議を経ずに既存注文への適用</li>
                </ul>
                <b>対策:</b> 十分な予告期間（60-90日）、丁寧な協議姿勢、段階的改定の提示など
              </div>
            </div>
          </details>
        </div>

        <div class="card">
          <div class="pill">STEP 1：改定内容</div>

          <label for="prefSelect">主な提供エリア（都道府県）</label>
          <select id="prefSelect" aria-label="都道府県選択"></select>

          <div class="inputGrid" style="margin-top:8px;">
            <div>
              <label for="currentPriceAsOf">現行価格の決定時期（年月）</label>
              <input type="month" id="currentPriceAsOf" />
              <div class="hint">STEP2の「外部環境」セクションで根拠データを確認できます。</div>
            </div>
            <div style="display:flex;align-items:flex-end;">
              <button class="btn emphasis" id="openExternalFactorsBtn" type="button">外部環境を確認</button>
            </div>
          </div>

          <label for="productName">対象商品・サービス名</label>
          <input type="text" id="productName" placeholder="例）保守費用、〇〇部品" />

          <div class="inputGrid">
            <div>
              <label for="currentPrice">現在の単価（税抜）</label>
              <input type="text" id="currentPrice" inputmode="decimal" placeholder="例）1,200" />
            </div>
            <div>
              <label for="newPrice">改定後単価（税抜）</label>
              <input type="text" id="newPrice" inputmode="decimal" placeholder="例）1,320" />
            </div>
          </div>

          <div class="hint" id="rateHint">改定率：— ／ 差額：—</div>
          <div id="validationWarning" class="warningBox" style="display:none;"></div>

          <div class="inputGrid" style="margin-top:8px;">
            <div>
              <label for="effectiveDate">適用開始時期</label>
              <input type="text" id="effectiveDate" placeholder="例）2026年4月1日 ご注文分より" />
            </div>
          </div>

          <div id="validateMsg" class="danger" style="display:none;"></div>
        </div>

        <div class="card" id="externalEnvSection">
          <div class="pill">STEP 2：背景（外部環境＋根拠データ）</div>
          <div class="hint">「外部環境を確認」ボタンで、確認項目をフローティング表示します。</div>
          <button class="btn emphasis" id="openExternalFactorsBtn2" type="button">外部環境を確認</button>

          <div class="divider"></div>

          <div class="hint">入力項目：該当するものを選択（複数可）</div>
          <div class="chipGroup" id="factorGroup">
            <button class="chip active" type="button" data-val="原材料・仕入コストの上昇">原材料・仕入</button>
            <button class="chip" type="button" data-val="物流費・運賃の上昇">物流</button>
            <button class="chip" type="button" data-val="エネルギー（電気・ガス・燃料）価格の上昇">エネルギー</button>
            <button class="chip active" type="button" data-val="人件費（賃上げ・採用難）による負担増">人件費</button>
            <button class="chip" type="button" data-val="最低賃金の改定">最低賃金</button>
            <button class="chip" type="button" data-val="IT/サブスク費用の増加">IT/サブスク</button>
            <button class="chip" type="button" data-val="金利上昇・資金調達コスト増">金利</button>
          </div>

          <label for="extraFactors">補足（任意）</label>
          <textarea id="extraFactors" rows="2" placeholder="例）主要仕入先からの値上げ通知（+8%）、採用単価の上昇 等"></textarea>
          <div class="hint">※入力すると「〜に加え、〇〇」と自然に文章へ組み込まれます。</div>
        </div>

        <div id="externalFactorsModal" class="modalOverlay" aria-hidden="true">
          <div class="modalDialog" role="dialog" aria-modal="true" aria-label="外部環境（確認項目）">
            <div class="modalHeader">
              <div class="pill" style="margin:0;">外部環境（確認項目）</div>
              <div style="display:flex;gap:8px;">
                <button class="iconBtn" id="closeExternalFactorsX" type="button">×</button>
                <button class="btn alt sm" id="closeExternalFactorsBtn" type="button">閉じる</button>
              </div>
            </div>

            <div class="dataPanel" style="margin-top:0;">
              <div class="dataRow">
                <span class="dataKey">現行価格決定時からの累積上昇（概算）</span>
                <span id="cpiSinceView"><b>物価：— ／ 最低賃金：—</b></span>
                <span class="badge warn" id="cpiSinceBadge">任意</span>
              </div>
              <div class="small">※実際の消費者物価指数および最低賃金（対象都道府県）の過去推移データを用いた概算です。</div>

              <details style="border:none; padding:0; background:transparent !important; margin-top:6px;">
                <summary style="font-size:0.8rem; font-weight:normal; color:#578899; cursor:pointer; text-decoration:underline;">計算過程を確認する</summary>
                <div id="calcDetailBox" class="mutedBox" style="font-size:0.75rem; margin-top:4px; line-height:1.5;">
                  （年月を入力すると計算過程が表示されます）
                </div>
              </details>

              <div class="sourceLink">
                <span class="badge">根拠</span>
                <a href="https://www.stat.go.jp/data/cpi/sokuhou/tsuki/pdf/doukou.pdf" target="_blank" rel="noopener">総務省統計局</a> /
                <a href="https://www.mhlw.go.jp/content/11200000/001571219.xlsx" target="_blank" rel="noopener">厚労省 最低賃金推移</a>
              </div>
            </div>

            <div class="dataPanel" aria-label="参考データ（最低賃金など）">
              <div class="dataRow">
                <span class="dataKey">最低賃金（参考）</span>
                <span id="minWageView">—</span>
                <span class="badge" id="minWageBadge">未取得</span>
              </div>
              <div class="small" id="minWageNote">※最低賃金はJSON優先（未読込時は内蔵値：厚労省Excel（H14〜R7）より転記）。</div>
            </div>

            <div class="divider"></div>

            <div class="inputGrid">
              <div>
                <label for="cpiRate">物価上昇率（%） <span class="badge" id="cpiScopeBadge">—</span></label>
                <input type="text" id="cpiRate" inputmode="decimal" placeholder="例）2.0" />
              </div>
              <div>
                <label for="wageRate">人件費上昇率（%） <span class="badge" id="wageScopeBadge">—</span></label>
                <input type="text" id="wageRate" inputmode="decimal" placeholder="例）4.6" />
              </div>
            </div>

            <div class="inputGrid" style="margin-top:12px;">
              <div>
                <label for="cpiAsOf" style="margin-top:0;">物価データの対象</label>
                <input type="text" id="cpiAsOf" placeholder="例）2026年1月（前年同月比）" />
              </div>
              <div>
                <label for="wageAsOf" style="margin-top:0;">人件費データの対象</label>
                <input type="text" id="wageAsOf" placeholder="例）2025年春闘（中小）" />
              </div>
            </div>

            <details>
              <summary>詳細設定（連動/説明/JSON読込）</summary>

              <div class="mutedBox">
                <div class="dataRow">
                  <span class="dataKey">都道府県変更に連動</span>
                  <label style="display:flex;gap:10px;align-items:center;margin:0;font-weight:900;">
                    <input type="checkbox" id="linkRates" checked style="width:auto;"> 連動する（推奨）
                  </label>
                  <span class="badge warn" id="linkNoteBadge">全国値が多い</span>
                </div>
                <div class="small" id="linkNoteText" style="margin-top:6px;">
                  ※都道府県別の物価/賃金がJSONに無い場合は「全国値」を表示します（バッジで明記）。
                  都道府県別で運用したい場合は pref_cost_data.json の prefs.[都道府県キー].cpi_yoy / wage_yoy を設定してください。
                </div>

                <div class="divider"></div>

                <label style="display:flex;gap:10px;align-items:center;margin:0;font-weight:900;">
                  <input type="checkbox" id="embedNumbersInLetter" checked style="width:auto;"> 本文に根拠数値（%・最低賃金等）を自然に織り込み、末尾に参考データを付与する
                </label>

                <div class="divider"></div>

                <div class="small" style="font-weight:900;color:#0f172a;">説明（社内向け）</div>
                <div class="chipGroup" style="margin-top:6px;">
                  <button class="chip" type="button" id="helpCpi">物価上昇率とは？</button>
                  <button class="chip" type="button" id="helpWage">人件費上昇率とは？</button>
                  <button class="chip" type="button" id="helpScope">都道府県別でない理由</button>
                </div>
                <div class="small" id="helpBox" style="margin-top:8px;line-height:1.6;color:#334155;"></div>
              </div>

              <details id="dataLoader" class="adminOnly">
                <summary>都道府県データを読み込み（JSON）</summary>
                <div class="hint">同階層の <span class="kbd">pref_cost_data.json</span> またはURLから読み込みます（物価/賃金/最低賃金など）。</div>

                <label for="dataUrl">JSONのURL（空欄なら ./pref_cost_data.json を試行）</label>
                <input type="text" id="dataUrl" placeholder="例）https://.../pref_cost_data.json" />

                <div class="miniActions">
                  <button class="btn" id="loadDataBtn" type="button">読み込み</button>
                  <button class="btn alt" id="clearDataBtn" type="button">読込解除</button>
                  <span id="dataLoadStatus" class="small" aria-live="polite"></span>
                </div>

                <div class="mutedBox">
                  <div class="small" style="margin-bottom:6px;"><b>JSONキー例（最小）</b></div>
                  <pre class="sample" id="jsonSample"></pre>
                </div>
                <div class="small">※キーは「兵庫 / 鳥取 / 和歌山」等、都道府県名（都・道・府・県を除いた形）で入れてください。最低賃金は <span class="kbd">prefs.[都道府県].min_wage</span> または <span class="kbd">national.min_wage_by_pref.[都道府県]</span> で全国管理できます。</div>
              </details>
            </details>
          </div>
        </div>

        <div class="card">
          <div class="pill">STEP 3：文面のトーン・顧客戦略</div>
          <div class="hint">相手に合わせて調整（1つ選択）</div>
          <div class="chipGroup" id="relationGroup">
            <button class="chip" type="button" data-val="A">信頼あり（共感・誠実）</button>
            <button class="chip active" type="button" data-val="B">標準（論理）</button>
            <button class="chip" type="button" data-val="C">価格に厳しい（データ・代替案）</button>
          </div>

          <details style="margin-top:10px;" open>
            <summary>高度な戦略オプション（顧客タイプ）</summary>
            <label>顧客タイプ</label>
            <div class="chipGroup" id="customerGroup">
              <button class="chip" type="button" data-val="strategic">戦略顧客（最重要）</button>
              <button class="chip" type="button" data-val="profitable">優良顧客</button>
              <button class="chip" type="button" data-val="marginal">採算ギリギリ</button>
              <button class="chip" type="button" data-val="loss">赤字顧客</button>
            </div>
            <div class="hint">
              <b>戦略顧客:</b> 段階改定・条件調整を最優先提示<br>
              <b>赤字顧客:</b> 改定受入れなければ取引見直しを示唆する協議アプローチ
            </div>
          </details>

          <details style="margin-top:10px;" open>
            <summary>自助努力</summary>
            <div class="hint">これまでの努力（複数可）</div>
            <div class="chipGroup" id="effortGroup">
              <button class="chip active" type="button" data-val="徹底した経費削減">経費削減</button>
              <button class="chip" type="button" data-val="業務のDX化・効率化">DX・効率化</button>
              <button class="chip" type="button" data-val="仕入先の見直し・統合">仕入先見直し</button>
              <button class="chip" type="button" data-val="在庫・発注精度の改善">在庫最適化</button>
              <button class="chip" type="button" data-val="歩留まり改善・廃棄ロス削減">歩留まり改善</button>
              <button class="chip" type="button" data-val="設備更新による省人化・省エネ化">設備更新</button>
              <button class="chip" type="button" data-val="共同配送・配送頻度最適化">共同配送</button>
              <button class="chip active" type="button" data-val="数年間にわたる価格据え置き">価格据え置き</button>
            </div>
            <label for="effortFreeText">自助努力（自由入力）</label>
            <textarea id="effortFreeText" rows="2" placeholder="例）配送ルートの見直し、作業工程の標準化による残業削減 等"></textarea>
          </details>
        </div>

      </div>

      <div class="colR">
        <div class="card">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:0;">
            <div class="pill">生成出力</div>
            <span id="copyStatus" class="statusMsg">コピーしました</span>
          </div>

          <div class="inputGrid" style="margin-top:8px;">
            <div>
              <label for="partnerCompany" style="margin-top:0;">相手社名</label>
              <input type="text" id="partnerCompany" placeholder="例）〇〇株式会社" />
            </div>
            <div>
              <label for="partnerPerson" style="margin-top:0;">相手担当者</label>
              <input type="text" id="partnerPerson" placeholder="例）山田" />
              <div class="inputGrid" style="margin-top:6px;gap:8px;grid-template-columns:1fr 1fr;">
                <select id="partnerHonorific" aria-label="敬称選択">
                  <option value="様">様</option>
                  <option value="御中">御中</option>
                  <option value="各位">各位</option>
                  <option value="先生">先生</option>
                  <option value="custom">任意入力</option>
                </select>
                <input type="text" id="partnerHonorificCustom" placeholder="任意の敬称（例：殿）" />
              </div>
            </div>
          </div>
          <div class="inputGrid" style="margin-top:8px;">
            <div>
              <label for="ownCompany" style="margin-top:0;">自社社名</label>
              <input type="text" id="ownCompany" placeholder="例）株式会社サンプル商会" />
            </div>
            <div>
              <label for="ownPerson" style="margin-top:0;">自社担当者</label>
              <input type="text" id="ownPerson" placeholder="例）山田 太郎" />
            </div>
          </div>

          <div class="tabs" id="outputTabs" role="tablist" aria-label="出力切替">
            <div class="tab active" role="tab" aria-selected="true" tabindex="0" data-target="letter">案内文（顧客に渡す）</div>
            <div class="tab" role="tab" aria-selected="false" tabindex="-1" data-target="talk">面談トーク</div>
            <div class="tab" role="tab" aria-selected="false" tabindex="-1" data-target="memo">根拠メモ（社内用）</div>
          </div>

          <textarea id="outputArea" class="docArea" readonly></textarea>

          <div class="miniActions">
            <button class="btn" id="copyBtn" type="button">現在の表示をコピー</button>
            <button class="btn alt" id="printBtn" type="button">印刷（案内文＋面談トーク+根拠メモ）</button>
          </div>
          <div class="hint" style="margin-top:8px;">※印刷は「案内文」と「面談トーク+根拠メモ（社内用）」を出力します。</div>
        </div>
      </div>
    </div>
  </div>

  <div id="printPack">
    <div class="printSection">
      <div class="printH1">【案内文】</div>
      <div class="printSub">※お客さまにお渡しする文面</div>
      <div class="printText" id="printLetter"></div>
    </div>

    <div class="printDivider"></div>

    <div class="printSection">
      <div class="printH1">【面談トーク+根拠メモ】</div>
      <div class="printSub">※社内用。面談時の説明台本と根拠整理。</div>
      <div class="printText" id="printTalkMemo"></div>
    </div>
  </div>

  <footer class="mk-mini">
    © <span id="cpy-year">2026</span>
    <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener license">税理士法人松本会計事務所</a> ｜ 
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="license noopener">CC BY-NC-SA 4.0</a> ｜ 
    <a href="/tool-portal/terms.html" target="_blank" rel="noopener">利用条件</a> ｜ 
    <span id="build-rev">r30</span>（<span id="last-updated-date"></span>）
  </footer>
  <div class="note">本ツールは文面生成の補助です。最終判断は、取引実態・競合・需給・契約条項等も踏まえて行ってください。</div>

  <script>
  (function(){
    /* =========================
       0) 定数・設定
       ========================= */
    const qs = new URLSearchParams(window.location.search);
    const IS_ADMIN = (qs.get('admin') === '1');
    try{ document.documentElement.classList.toggle('isAdmin', !!IS_ADMIN); }catch(e){}

    const DATA_FRESHNESS = {
      cpi_base: "2024年12月確定値（2025年以降は推計）",
      min_wage: "令和7年度（2025年度）改定値（厚労省『最低賃金推移』H14～R7）",
      last_verified: "2026-03-01"
    };

    // JSONサンプル（管理モード表示用）
    const SAMPLE_JSON = {
      national: {
        cpi_yoy: 2.0,
        cpi_asof: "2026年1月（前年同月比）",
        wage_yoy: 4.6,
        wage_asof: "2025年春闘（中小）",
        min_wage_by_pref: {
          "東京": { new: 1226, old: 1163, inc: 63, eff: "2025-10-03" },
          "兵庫": { new: 1116, old: 1052, inc: 64, eff: "2025-10-04" }
        }
      },
      prefs: {
        "兵庫": {
          cpi_yoy: 2.0,
          cpi_asof: "2026年1月（前年同月比）",
          wage_yoy: 4.6,
          wage_asof: "2025年春闘（中小）",
          min_wage: { new: 1116, old: 1052, inc: 64, eff: "2025-10-04" }
        }
      }
    };

    /* =========================
       1) 対象都道府県（全国）
       ========================= */
    const PREFS = [
      {k:'北海道', l:'北海道'},
      {k:'青森', l:'青森県'}, {k:'岩手', l:'岩手県'}, {k:'宮城', l:'宮城県'}, {k:'秋田', l:'秋田県'}, {k:'山形', l:'山形県'}, {k:'福島', l:'福島県'},
      {k:'茨城', l:'茨城県'}, {k:'栃木', l:'栃木県'}, {k:'群馬', l:'群馬県'}, {k:'埼玉', l:'埼玉県'}, {k:'千葉', l:'千葉県'}, {k:'東京', l:'東京都'}, {k:'神奈川', l:'神奈川県'},
      {k:'新潟', l:'新潟県'}, {k:'富山', l:'富山県'}, {k:'石川', l:'石川県'}, {k:'福井', l:'福井県'}, {k:'山梨', l:'山梨県'}, {k:'長野', l:'長野県'},
      {k:'岐阜', l:'岐阜県'}, {k:'静岡', l:'静岡県'}, {k:'愛知', l:'愛知県'}, {k:'三重', l:'三重県'},
      {k:'滋賀', l:'滋賀県'}, {k:'京都', l:'京都府'}, {k:'大阪', l:'大阪府'}, {k:'兵庫', l:'兵庫県'}, {k:'奈良', l:'奈良県'}, {k:'和歌山', l:'和歌山県'},
      {k:'鳥取', l:'鳥取県'}, {k:'島根', l:'島根県'}, {k:'岡山', l:'岡山県'}, {k:'広島', l:'広島県'}, {k:'山口', l:'山口県'},
      {k:'徳島', l:'徳島県'}, {k:'香川', l:'香川県'}, {k:'愛媛', l:'愛媛県'}, {k:'高知', l:'高知県'},
      {k:'福岡', l:'福岡県'}, {k:'佐賀', l:'佐賀県'}, {k:'長崎', l:'長崎県'}, {k:'熊本', l:'熊本県'}, {k:'大分', l:'大分県'}, {k:'宮崎', l:'宮崎県'}, {k:'鹿児島', l:'鹿児島県'},
      {k:'沖縄', l:'沖縄県'}
    ];
    const PREF_LABEL = Object.fromEntries(PREFS.map(x=>[x.k,x.l]));

    /* 最低賃金：年度上の「直近（2025）と前年度（2024）」 */
    /* Source: 添付Excel 001571219.xlsx（厚労省 最低賃金推移 / シート H14～R7）より転記 */
    const MIN_WAGE = {"北海道":{"n":1075,"o":1010,"inc":65,"eff":"2025-10-04"},"青森":{"n":1029,"o":953,"inc":76,"eff":"2025-11-21"},"岩手":{"n":1031,"o":952,"inc":79,"eff":"2025-12-01"},"宮城":{"n":1038,"o":973,"inc":65,"eff":"2025-10-04"},"秋田":{"n":1031,"o":951,"inc":80,"eff":"2026-03-31"},"山形":{"n":1032,"o":955,"inc":77,"eff":"2025-12-23"},"福島":{"n":1033,"o":955,"inc":78,"eff":"2026-01-01"},"茨城":{"n":1074,"o":1005,"inc":69,"eff":"2025-10-12"},"栃木":{"n":1074,"o":1004,"inc":70,"eff":"2025-10-01"},"群馬":{"n":1074,"o":985,"inc":89,"eff":"2026-03-01"},"埼玉":{"n":1138,"o":1078,"inc":60,"eff":"2025-10-01"},"千葉":{"n":1126,"o":1076,"inc":50,"eff":"2025-10-01"},"東京":{"n":1226,"o":1163,"inc":63,"eff":"2025-10-03"},"神奈川":{"n":1180,"o":1120,"inc":60,"eff":"2025-10-01"},"新潟":{"n":1065,"o":985,"inc":80,"eff":"2025-10-01"},"富山":{"n":1060,"o":948,"inc":112,"eff":"2025-10-01"},"石川":{"n":1060,"o":933,"inc":127,"eff":"2025-10-01"},"福井":{"n":1036,"o":931,"inc":105,"eff":"2025-10-01"},"山梨":{"n":1054,"o":988,"inc":66,"eff":"2025-10-01"},"長野":{"n":1040,"o":948,"inc":92,"eff":"2025-10-01"},"岐阜":{"n":1030,"o":950,"inc":80,"eff":"2025-10-01"},"静岡":{"n":1095,"o":984,"inc":111,"eff":"2025-10-01"},"愛知":{"n":1105,"o":1027,"inc":78,"eff":"2025-10-01"},"三重":{"n":1025,"o":973,"inc":52,"eff":"2025-10-01"},"滋賀":{"n":1080,"o":1017,"inc":63,"eff":"2025-10-05"},"京都":{"n":1122,"o":1058,"inc":64,"eff":"2025-11-21"},"大阪":{"n":1177,"o":1114,"inc":63,"eff":"2025-10-16"},"兵庫":{"n":1116,"o":1052,"inc":64,"eff":"2025-10-04"},"奈良":{"n":1051,"o":986,"inc":65,"eff":"2025-11-16"},"和歌山":{"n":1040,"o":980,"inc":60,"eff":"2025-10-01"},"鳥取":{"n":1030,"o":957,"inc":73,"eff":"2025-10-04"},"島根":{"n":1033,"o":962,"inc":71,"eff":"2025-11-17"},"岡山":{"n":1047,"o":982,"inc":65,"eff":"2025-12-01"},"広島":{"n":1085,"o":1020,"inc":65,"eff":"2025-11-01"},"山口":{"n":1043,"o":979,"inc":64,"eff":"2025-10-16"},"徳島":{"n":1010,"o":980,"inc":30,"eff":"2026-01-01"},"香川":{"n":1020,"o":970,"inc":50,"eff":"2025-10-01"},"愛媛":{"n":1000,"o":956,"inc":44,"eff":"2025-10-01"},"高知":{"n":990,"o":952,"inc":38,"eff":"2025-10-01"},"福岡":{"n":1041,"o":992,"inc":49,"eff":"2025-10-05"},"佐賀":{"n":1000,"o":956,"inc":44,"eff":"2025-10-17"},"長崎":{"n":1000,"o":953,"inc":47,"eff":"2025-10-25"},"熊本":{"n":1010,"o":952,"inc":58,"eff":"2026-01-01"},"大分":{"n":1000,"o":954,"inc":46,"eff":"2026-01-01"},"宮崎":{"n":1000,"o":952,"inc":48,"eff":"2025-10-11"},"鹿児島":{"n":1005,"o":953,"inc":52,"eff":"2025-10-01"},"沖縄":{"n":1010,"o":952,"inc":58,"eff":"2025-10-09"}};

    /* 都道府県別 最低賃金の履歴データ（2002〜2025年 / H14〜R7） */
    /* Source: 添付Excel 001571219.xlsx（厚労省 最低賃金推移 / シート H14～R7）より転記 */
    const MW_HISTORY = {"北海道":{"2002":637,"2003":637,"2004":638,"2005":641,"2006":644,"2007":654,"2008":667,"2009":678,"2010":691,"2011":705,"2012":719,"2013":734,"2014":748,"2015":764,"2016":786,"2017":810,"2018":835,"2019":861,"2020":861,"2021":889,"2022":920,"2023":960,"2024":1010,"2025":1075},"青森":{"2002":605,"2003":605,"2004":606,"2005":608,"2006":610,"2007":619,"2008":630,"2009":632,"2010":645,"2011":645,"2012":647,"2013":665,"2014":678,"2015":695,"2016":716,"2017":738,"2018":762,"2019":790,"2020":792,"2021":822,"2022":853,"2023":898,"2024":953,"2025":1029},"岩手":{"2002":605,"2003":605,"2004":606,"2005":608,"2006":610,"2007":618,"2008":629,"2009":631,"2010":643,"2011":644,"2012":645,"2013":662,"2014":675,"2015":694,"2016":716,"2017":738,"2018":762,"2019":790,"2020":792,"2021":821,"2022":854,"2023":893,"2024":952,"2025":1031},"宮城":{"2002":617,"2003":617,"2004":619,"2005":623,"2006":628,"2007":637,"2008":649,"2009":650,"2010":662,"2011":663,"2012":673,"2013":685,"2014":696,"2015":716,"2016":724,"2017":748,"2018":772,"2019":797,"2020":825,"2021":853,"2022":883,"2023":923,"2024":973,"2025":1038},"秋田":{"2002":605,"2003":605,"2004":606,"2005":608,"2006":610,"2007":618,"2008":629,"2009":630,"2010":646,"2011":646,"2012":654,"2013":666,"2014":679,"2015":694,"2016":718,"2017":740,"2018":764,"2019":790,"2020":792,"2021":824,"2022":857,"2023":904,"2024":951,"2025":1031},"山形":{"2002":605,"2003":606,"2004":607,"2005":610,"2006":613,"2007":620,"2008":629,"2009":630,"2010":646,"2011":646,"2012":654,"2013":668,"2014":684,"2015":702,"2016":717,"2017":739,"2018":763,"2019":790,"2020":792,"2021":822,"2022":854,"2023":900,"2024":955,"2025":1032},"福島":{"2002":610,"2003":610,"2004":611,"2005":614,"2006":618,"2007":626,"2008":636,"2009":636,"2010":655,"2011":657,"2012":664,"2013":675,"2014":689,"2015":706,"2016":726,"2017":748,"2018":772,"2019":798,"2020":800,"2021":828,"2022":858,"2023":900,"2024":955,"2025":1033},"茨城":{"2002":647,"2003":647,"2004":648,"2005":651,"2006":655,"2007":665,"2008":677,"2009":678,"2010":692,"2011":700,"2012":718,"2013":729,"2014":746,"2015":771,"2016":796,"2017":822,"2018":849,"2019":874,"2020":876,"2021":879,"2022":911,"2023":953,"2024":1005,"2025":1074},"栃木":{"2002":650,"2003":650,"2004":651,"2005":654,"2006":658,"2007":668,"2008":681,"2009":682,"2010":696,"2011":698,"2012":705,"2013":718,"2014":732,"2015":751,"2016":775,"2017":800,"2018":826,"2019":853,"2020":854,"2021":882,"2022":913,"2023":954,"2024":1004,"2025":1074},"群馬":{"2002":655,"2003":655,"2004":656,"2005":659,"2006":662,"2007":671,"2008":683,"2009":684,"2010":696,"2011":698,"2012":705,"2013":718,"2014":732,"2015":751,"2016":773,"2017":798,"2018":823,"2019":850,"2020":851,"2021":865,"2022":895,"2023":935,"2024":985,"2025":1074},"埼玉":{"2002":669,"2003":669,"2004":670,"2005":673,"2006":676,"2007":686,"2008":700,"2009":702,"2010":719,"2011":722,"2012":740,"2013":760,"2014":777,"2015":820,"2016":845,"2017":871,"2018":898,"2019":926,"2020":928,"2021":956,"2022":987,"2023":1028,"2024":1078,"2025":1138},"千葉":{"2002":663,"2003":663,"2004":664,"2005":667,"2006":670,"2007":681,"2008":698,"2009":700,"2010":719,"2011":722,"2012":740,"2013":761,"2014":776,"2015":798,"2016":842,"2017":868,"2018":895,"2019":923,"2020":925,"2021":953,"2022":984,"2023":1026,"2024":1076,"2025":1126},"東京":{"2002":708,"2003":708,"2004":710,"2005":714,"2006":719,"2007":729,"2008":766,"2009":791,"2010":821,"2011":837,"2012":850,"2013":869,"2014":888,"2015":907,"2016":932,"2017":958,"2018":985,"2019":1013,"2020":1013,"2021":1041,"2022":1072,"2023":1113,"2024":1163,"2025":1226},"神奈川":{"2002":703,"2003":703,"2004":704,"2005":708,"2006":712,"2007":721,"2008":766,"2009":789,"2010":818,"2011":836,"2012":849,"2013":868,"2014":887,"2015":905,"2016":930,"2017":956,"2018":983,"2019":1011,"2020":1012,"2021":1040,"2022":1071,"2023":1112,"2024":1120,"2025":1180},"新潟":{"2002":639,"2003":639,"2004":641,"2005":645,"2006":650,"2007":659,"2008":669,"2009":670,"2010":682,"2011":684,"2012":689,"2013":701,"2014":716,"2015":731,"2016":753,"2017":772,"2018":803,"2019":829,"2020":831,"2021":859,"2022":890,"2023":931,"2024":985,"2025":1065},"富山":{"2002":641,"2003":641,"2004":642,"2005":645,"2006":648,"2007":659,"2008":669,"2009":670,"2010":684,"2011":686,"2012":696,"2013":705,"2014":725,"2015":742,"2016":753,"2017":770,"2018":795,"2019":821,"2020":827,"2021":848,"2022":877,"2023":908,"2024":948,"2025":1060},"石川":{"2002":642,"2003":642,"2004":643,"2005":646,"2006":649,"2007":659,"2008":669,"2009":670,"2010":684,"2011":686,"2012":697,"2013":706,"2014":718,"2015":735,"2016":757,"2017":781,"2018":806,"2019":832,"2020":833,"2021":861,"2022":891,"2023":933,"2024":933,"2025":1060},"福井":{"2002":641,"2003":641,"2004":642,"2005":645,"2006":648,"2007":659,"2008":669,"2009":670,"2010":684,"2011":686,"2012":697,"2013":701,"2014":716,"2015":732,"2016":757,"2017":781,"2018":804,"2019":829,"2020":830,"2021":858,"2022":888,"2023":931,"2024":931,"2025":1036},"山梨":{"2002":642,"2003":642,"2004":643,"2005":646,"2006":649,"2007":659,"2008":669,"2009":670,"2010":684,"2011":686,"2012":696,"2013":703,"2014":717,"2015":737,"2016":759,"2017":781,"2018":810,"2019":837,"2020":838,"2021":866,"2022":898,"2023":938,"2024":988,"2025":1054},"長野":{"2002":646,"2003":646,"2004":647,"2005":650,"2006":653,"2007":662,"2008":668,"2009":670,"2010":679,"2011":680,"2012":688,"2013":700,"2014":710,"2015":732,"2016":759,"2017":777,"2018":805,"2019":821,"2020":827,"2021":849,"2022":878,"2023":908,"2024":948,"2025":1040},"岐阜":{"2002":645,"2003":645,"2004":646,"2005":649,"2006":652,"2007":662,"2008":673,"2009":674,"2010":690,"2011":692,"2012":699,"2013":711,"2014":724,"2015":754,"2016":776,"2017":800,"2018":826,"2019":851,"2020":852,"2021":880,"2022":910,"2023":950,"2024":950,"2025":1030},"静岡":{"2002":662,"2003":662,"2004":663,"2005":666,"2006":669,"2007":680,"2008":713,"2009":713,"2010":727,"2011":735,"2012":750,"2013":765,"2014":781,"2015":807,"2016":832,"2017":858,"2018":885,"2019":913,"2020":913,"2021":944,"2022":984,"2023":984,"2024":984,"2025":1095},"愛知":{"2002":681,"2003":681,"2004":682,"2005":685,"2006":688,"2007":697,"2008":713,"2009":718,"2010":729,"2011":737,"2012":750,"2013":765,"2014":781,"2015":820,"2016":845,"2017":871,"2018":898,"2019":926,"2020":927,"2021":955,"2022":986,"2023":1027,"2024":1027,"2025":1105},"三重":{"2002":645,"2003":645,"2004":646,"2005":649,"2006":652,"2007":662,"2008":673,"2009":674,"2010":690,"2011":692,"2012":699,"2013":711,"2014":727,"2015":753,"2016":775,"2017":800,"2018":823,"2019":848,"2020":848,"2021":873,"2022":902,"2023":933,"2024":973,"2025":1025},"滋賀":{"2002":651,"2003":651,"2004":651,"2005":657,"2006":662,"2007":677,"2008":691,"2009":693,"2010":697,"2011":701,"2012":714,"2013":727,"2014":746,"2015":764,"2016":788,"2017":813,"2018":839,"2019":866,"2020":868,"2021":896,"2022":927,"2023":967,"2024":1017,"2025":1080},"京都":{"2002":677,"2003":677,"2004":677,"2005":682,"2006":686,"2007":700,"2008":717,"2009":729,"2010":735,"2011":737,"2012":749,"2013":759,"2014":779,"2015":808,"2016":831,"2017":856,"2018":882,"2019":909,"2020":909,"2021":937,"2022":968,"2023":1008,"2024":1058,"2025":1122},"大阪":{"2002":703,"2003":703,"2004":703,"2005":708,"2006":712,"2007":731,"2008":748,"2009":762,"2010":779,"2011":786,"2012":800,"2013":819,"2014":838,"2015":858,"2016":883,"2017":909,"2018":936,"2019":964,"2020":964,"2021":992,"2022":1023,"2023":1064,"2024":1114,"2025":1177},"兵庫":{"2002":675,"2003":675,"2004":675,"2005":679,"2006":683,"2007":697,"2008":712,"2009":721,"2010":731,"2011":735,"2012":749,"2013":761,"2014":776,"2015":810,"2016":819,"2017":844,"2018":871,"2019":899,"2020":900,"2021":928,"2022":960,"2023":1001,"2024":1052,"2025":1116},"奈良":{"2002":647,"2003":647,"2004":647,"2005":652,"2006":656,"2007":667,"2008":678,"2009":679,"2010":692,"2011":695,"2012":708,"2013":724,"2014":745,"2015":762,"2016":786,"2017":811,"2018":837,"2019":838,"2020":838,"2021":866,"2022":896,"2023":936,"2024":986,"2025":1051},"和歌山":{"2002":645,"2003":645,"2004":645,"2005":649,"2006":652,"2007":662,"2008":673,"2009":674,"2010":693,"2011":695,"2012":708,"2013":719,"2014":731,"2015":753,"2016":777,"2017":803,"2018":830,"2019":831,"2020":831,"2021":859,"2022":889,"2023":929,"2024":980,"2025":1040},"鳥取":{"2002":610,"2003":610,"2004":610,"2005":612,"2006":614,"2007":621,"2008":629,"2009":630,"2010":645,"2011":645,"2012":652,"2013":664,"2014":677,"2015":693,"2016":715,"2017":738,"2018":762,"2019":790,"2020":792,"2021":821,"2022":854,"2023":900,"2024":957,"2025":1030},"島根":{"2002":609,"2003":609,"2004":609,"2005":612,"2006":614,"2007":621,"2008":629,"2009":630,"2010":646,"2011":646,"2012":654,"2013":666,"2014":679,"2015":694,"2016":718,"2017":740,"2018":764,"2019":790,"2020":792,"2021":824,"2022":857,"2023":904,"2024":962,"2025":1033},"岡山":{"2002":640,"2003":640,"2004":640,"2005":644,"2006":648,"2007":669,"2008":669,"2009":670,"2010":684,"2011":686,"2012":699,"2013":711,"2014":731,"2015":748,"2016":757,"2017":781,"2018":807,"2019":833,"2020":833,"2021":862,"2022":892,"2023":932,"2024":982,"2025":1047},"広島":{"2002":644,"2003":644,"2004":644,"2005":649,"2006":654,"2007":669,"2008":683,"2009":692,"2010":696,"2011":703,"2012":718,"2013":731,"2014":750,"2015":769,"2016":793,"2017":818,"2018":844,"2019":871,"2020":871,"2021":899,"2022":930,"2023":970,"2024":1020,"2025":1085},"山口":{"2002":637,"2003":637,"2004":637,"2005":642,"2006":646,"2007":655,"2008":668,"2009":669,"2010":682,"2011":685,"2012":696,"2013":708,"2014":729,"2015":746,"2016":771,"2017":794,"2018":802,"2019":829,"2020":829,"2021":857,"2022":888,"2023":928,"2024":979,"2025":1043},"徳島":{"2002":608,"2003":608,"2004":609,"2005":612,"2006":614,"2007":621,"2008":629,"2009":630,"2010":641,"2011":645,"2012":652,"2013":664,"2014":677,"2015":693,"2016":715,"2017":738,"2018":762,"2019":790,"2020":792,"2021":821,"2022":854,"2023":896,"2024":980,"2025":1010},"香川":{"2002":610,"2003":610,"2004":611,"2005":614,"2006":618,"2007":626,"2008":636,"2009":636,"2010":645,"2011":647,"2012":652,"2013":664,"2014":677,"2015":693,"2016":715,"2017":738,"2018":762,"2019":792,"2020":792,"2021":820,"2022":853,"2023":893,"2024":970,"2025":1020},"愛媛":{"2002":608,"2003":608,"2004":609,"2005":612,"2006":614,"2007":621,"2008":629,"2009":630,"2010":641,"2011":645,"2012":652,"2013":664,"2014":677,"2015":693,"2016":715,"2017":738,"2018":762,"2019":790,"2020":792,"2021":820,"2022":853,"2023":897,"2024":956,"2025":1000},"高知":{"2002":608,"2003":608,"2004":609,"2005":612,"2006":614,"2007":621,"2008":629,"2009":630,"2010":641,"2011":645,"2012":652,"2013":664,"2014":677,"2015":693,"2016":715,"2017":738,"2018":762,"2019":790,"2020":792,"2021":820,"2022":853,"2023":897,"2024":952,"2025":990},"福岡":{"2002":642,"2003":642,"2004":644,"2005":648,"2006":653,"2007":662,"2008":675,"2009":676,"2010":691,"2011":695,"2012":701,"2013":712,"2014":731,"2015":766,"2016":784,"2017":802,"2018":814,"2019":841,"2020":842,"2021":870,"2022":900,"2023":941,"2024":992,"2025":1041},"佐賀":{"2002":610,"2003":610,"2004":611,"2005":614,"2006":616,"2007":621,"2008":629,"2009":630,"2010":642,"2011":645,"2012":652,"2013":664,"2014":677,"2015":694,"2016":715,"2017":737,"2018":762,"2019":790,"2020":792,"2021":821,"2022":853,"2023":900,"2024":956,"2025":1000},"長崎":{"2002":609,"2003":609,"2004":610,"2005":612,"2006":614,"2007":621,"2008":629,"2009":630,"2010":642,"2011":645,"2012":652,"2013":664,"2014":677,"2015":694,"2016":715,"2017":737,"2018":762,"2019":790,"2020":792,"2021":821,"2022":853,"2023":898,"2024":953,"2025":1000},"熊本":{"2002":610,"2003":610,"2004":611,"2005":614,"2006":616,"2007":621,"2008":629,"2009":630,"2010":642,"2011":645,"2012":652,"2013":664,"2014":677,"2015":694,"2016":715,"2017":737,"2018":762,"2019":790,"2020":792,"2021":821,"2022":853,"2023":898,"2024":952,"2025":1010},"大分":{"2002":610,"2003":610,"2004":611,"2005":614,"2006":616,"2007":621,"2008":629,"2009":630,"2010":642,"2011":645,"2012":652,"2013":664,"2014":677,"2015":694,"2016":715,"2017":737,"2018":762,"2019":790,"2020":792,"2021":821,"2022":853,"2023":898,"2024":954,"2025":1000},"宮崎":{"2002":610,"2003":610,"2004":611,"2005":614,"2006":616,"2007":621,"2008":629,"2009":630,"2010":642,"2011":645,"2012":652,"2013":664,"2014":677,"2015":694,"2016":715,"2017":737,"2018":762,"2019":790,"2020":792,"2021":821,"2022":853,"2023":897,"2024":952,"2025":1000},"鹿児島":{"2002":610,"2003":610,"2004":611,"2005":614,"2006":616,"2007":621,"2008":629,"2009":630,"2010":642,"2011":645,"2012":652,"2013":664,"2014":677,"2015":694,"2016":715,"2017":737,"2018":762,"2019":790,"2020":792,"2021":821,"2022":853,"2023":900,"2024":953,"2025":1005},"沖縄":{"2002":602,"2003":602,"2004":605,"2005":607,"2006":610,"2007":612,"2008":627,"2009":628,"2010":629,"2011":629,"2012":633,"2013":642,"2014":644,"2015":672,"2016":714,"2017":737,"2018":762,"2019":790,"2020":792,"2021":821,"2022":853,"2023":896,"2024":952,"2025":1010}};

    const MW_MIN_YEAR = 2002;
    const MW_MAX_YEAR = 2025;

    /* --- ユーティリティ --- */
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const toNum = v => { const s = String(v||'').replace(/,/g,'').replace(/[^\d.-]/g,''); const n = parseFloat(s); return isFinite(n) ? n : NaN; };
    const yen = n => isFinite(n) ? new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY', maximumFractionDigits: 0 }).format(n) : '—';
    const pct1 = n => isFinite(n) ? (Math.round(n*10)/10).toFixed(1) : '';
    const z2 = n => String(n).padStart(2,'0');
    const fmtYMD = s => {
      if(!s) return '';
      const d = new Date(s);
      if(isNaN(d.getTime())) return String(s);
      return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;
    };
    const fmtYM = s => {
      if(!s) return '';
      const m = String(s).trim().match(/^(\d{4})-(\d{2})$/);
      if(!m) return String(s);
      return `${m[1]}年${parseInt(m[2],10)}月`;
    };
    const joinJa = (arr) => {
      const a = (arr||[]).filter(Boolean);
      if(a.length===0) return '';
      return a.join("、");
    };

    // 「約◯年」算出（年月から現在までの経過を年換算）
    function approxYearsFromYM(ym /* 'YYYY-MM' */){
      const m = String(ym||'').trim().match(/^(\d{4})-(\d{2})$/);
      if(!m) return null;
      const by = parseInt(m[1],10);
      const bm = parseInt(m[2],10) - 1;
      const now = new Date();
      const ny = now.getFullYear();
      const nm = now.getMonth();
      const months = (ny - by) * 12 + (nm - bm);
      if(months <= 0) return null;

      const years = months / 12;
      const y1 = Math.round(years * 10) / 10;
      const yStr = (Math.abs(y1 - Math.round(y1)) < 1e-9) ? String(Math.round(y1)) : String(y1);
      return { months, years: y1, yearsStr: yStr };
    }

    /* --- DOM --- */
    const productName = $('#productName');
    const currentPrice = $('#currentPrice');
    const newPrice = $('#newPrice');
    const currentPriceAsOf = $('#currentPriceAsOf');
    const effectiveDate = $('#effectiveDate');
    const outputArea = $('#outputArea');
    const partnerCompany = $('#partnerCompany');
    const partnerPerson = $('#partnerPerson');
    const partnerHonorific = $('#partnerHonorific');
    const partnerHonorificCustom = $('#partnerHonorificCustom');
    const ownCompany = $('#ownCompany');
    const ownPerson = $('#ownPerson');
    const copyBtn = $('#copyBtn');
    const printBtn = $('#printBtn');
    const copyStatus = $('#copyStatus');
    const resetBtn = $('#resetBtn');
    const rateHint = $('#rateHint');
    const validateMsg = $('#validateMsg');
    const importStatusEl = $('#importStatus');
    const validationWarning = $('#validationWarning');

    const prefSelect = $('#prefSelect');
    const minWageView = $('#minWageView');
    const minWageBadge = $('#minWageBadge');
    const minWageNote = $('#minWageNote');

    const cpiRate = $('#cpiRate');
    const wageRate = $('#wageRate');
    const cpiAsOf = $('#cpiAsOf');
    const wageAsOf = $('#wageAsOf');

    const linkRates = $('#linkRates');
    const cpiScopeBadge = $('#cpiScopeBadge');
    const wageScopeBadge = $('#wageScopeBadge');

    const embedNumbersInLetter = $('#embedNumbersInLetter');

    const cpiSinceView = $('#cpiSinceView');
    const cpiSinceBadge = $('#cpiSinceBadge');
    const cpiSinceViewModal = $('#cpiSinceViewModal');
    const cpiSinceBadgeModal = $('#cpiSinceBadgeModal');

    const helpCpi = $('#helpCpi');
    const helpWage = $('#helpWage');
    const helpScope = $('#helpScope');
    const helpBox = $('#helpBox');

    const dataUrl = $('#dataUrl');
    const loadDataBtn = $('#loadDataBtn');
    const clearDataBtn = $('#clearDataBtn');
    const dataLoadStatus = $('#dataLoadStatus');
    const jsonSample = $('#jsonSample');

    const extraFactors = $('#extraFactors');
    const effortFreeText = $('#effortFreeText');
    const openExternalFactorsBtn = $('#openExternalFactorsBtn');
    const openExternalFactorsBtn2 = $('#openExternalFactorsBtn2');
    const externalFactorsModal = $('#externalFactorsModal');
    const closeExternalFactorsBtn = $('#closeExternalFactorsBtn');
    const closeExternalFactorsX = $('#closeExternalFactorsX');

    const printLetter = $('#printLetter');
    const printTalkMemo = $('#printTalkMemo');

    let currentOutputMode = 'letter';

    document.addEventListener('input', (e) => {
      if(e.target && e.target.classList && e.target.classList.contains('imported-value')){
        e.target.classList.remove('imported-value');
      }
    });

    function showImportStatus(msg){
      if(!importStatusEl) return;
      importStatusEl.textContent = msg;
      importStatusEl.classList.add('show');
      clearTimeout(showImportStatus._t);
      showImportStatus._t = setTimeout(()=>importStatusEl.classList.remove('show'), 4200);
    }
    function markImported(el){ if(el) el.classList.add('imported-value'); }

    /* リアルタイムカンマ整形関数 */
    const formatYenRealtime = (e) => {
      const el = e.target;
      let raw = el.value.replace(/[^\d.-]/g, '');
      if(!raw) { el.value = ''; return; }

      let pos = el.selectionStart;
      let oldLen = el.value.length;

      let parts = raw.split('.');
      let intPart = parts[0];
      let decPart = parts.length > 1 ? '.' + parts[1] : '';

      if (intPart === '' || intPart === '-') {
        el.value = raw;
        return;
      }

      let num = parseInt(intPart, 10);
      if(isNaN(num)) return;

      let formatted = num.toLocaleString('ja-JP') + decPart;
      el.value = formatted;

      let newLen = el.value.length;
      let diff = newLen - oldLen;
      try { el.setSelectionRange(pos + diff, pos + diff); } catch(err){}
    };

    /* 金額入力時のリアルタイム反映用バインド */
    currentPrice.addEventListener('input', (e) => {
      formatYenRealtime(e);
      generate();
    });
    newPrice.addEventListener('input', (e) => {
      formatYenRealtime(e);
      generate();
    });

    const formatPctInput = (el) => {
      const v = toNum(el.value);
      if(isFinite(v)) el.value = pct1(v);
    };
    cpiRate.addEventListener('blur', () => formatPctInput(cpiRate));
    wageRate.addEventListener('blur', () => formatPctInput(wageRate));

    function setupChips(groupId, multiple) {
      const group = $(groupId);
      if(!group) return;
      group.addEventListener('click', (e) => {
        if(e.target.classList.contains('chip')) {
          if(!multiple) {
            group.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            e.target.classList.add('active');
          } else {
            e.target.classList.toggle('active');
          }
          generate();
        }
      });
    }
    setupChips('#clauseGroup', false);
    setupChips('#factorGroup', true);
    setupChips('#effortGroup', true);
    setupChips('#relationGroup', false);
    setupChips('#customerGroup', false);

    $('#outputTabs').addEventListener('click', (e) => {
      if(e.target.classList.contains('tab')) {
        $$('#outputTabs .tab').forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected','false'); t.tabIndex = -1; });
        e.target.classList.add('active');
        e.target.setAttribute('aria-selected','true');
        e.target.tabIndex = 0;
        currentOutputMode = e.target.getAttribute('data-target');
        renderOutput();
      }
    });

    function getSelectedValues(groupId) {
      const g = $(groupId);
      if(!g) return [];
      return Array.from(g.querySelectorAll('.chip.active')).map(c => c.getAttribute('data-val'));
    }

    function buildPrefOptions(){
      prefSelect.innerHTML = '';
      for(const p of PREFS){
        const opt = document.createElement('option');
        opt.value = p.k;
        opt.textContent = p.l;
        prefSelect.appendChild(opt);
      }
      // 初期値を東京都にセット
      prefSelect.value = '東京';
    }

    let COST_DATA = null;

    function setStatus(msg, ok){
      if(!dataLoadStatus) return;
      dataLoadStatus.textContent = msg || '';
      dataLoadStatus.style.color = ok ? '#0f172a' : '#b91c1c';
    }

    async function fetchJson(url){
      try {
        const bust = (url.includes('?') ? '&' : '?') + 't=' + Date.now();
        const res = await fetch(url + bust, { cache: 'no-store' });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        return await res.json();
      } catch (e) {
        const res2 = await fetch(url, { cache: 'no-store' });
        if(!res2.ok) throw new Error('HTTP ' + res2.status);
        return await res2.json();
      }
    }

    function normalizePrefKey(k){
      if(!k) return '';
      let s = String(k).trim();
      s = s.replace(/[都道府県]$/,'');
      if(s==="東京都") s="東京";
      if(s==="大阪府") s="大阪";
      if(s==="京都府") s="京都";
      if(s==="北海道") s="北海道";
      return s;
    }

    function getPrefData(prefKey){
      if(!COST_DATA || !COST_DATA.prefs) return null;
      const direct = COST_DATA.prefs[prefKey];
      if(direct) return direct;
      for(const key in COST_DATA.prefs){
        if(normalizePrefKey(key) === prefKey) return COST_DATA.prefs[key];
      }
      return null;
    }

    function setLocal(key, val){ try{ localStorage.setItem(key, val); }catch(e){} }
    function getLocal(key){ try{ return localStorage.getItem(key) || ''; }catch(e){ return ''; } }

    async function loadCostData(url, silent){
      const u = (url && url.trim()) ? url.trim() : './pref_cost_data.json';
      if(!silent) setStatus('読み込み中…', true);
      try{
        const json = await fetchJson(u);
        COST_DATA = json;
        setStatus('読み込みOK（' + u + '）', true);
        setLocal('mk_cost_data_url', u);
      }catch(e){
        COST_DATA = null;
        if(silent){
          setStatus('（外部データ未読込）', true);
        }else{
          setStatus('読み込み失敗：' + e.message, false);
        }
      }

      try {
        renderAllByPref();
        generate();
      } catch(err) {
        console.error('UI反映時エラー', err);
      }
    }

    function clearCostData(){
      COST_DATA = null;
      setStatus('読込解除しました', true);
      renderAllByPref();
      generate();
    }

    function parseMinWageRecord(w){
      if(!w) return null;
      const n = toNum(w.new ?? w.n ?? w.N);
      const o = toNum(w.old ?? w.o ?? w.O);
      const inc = toNum(w.inc ?? w.diff ?? w.delta);
      let inc2 = isFinite(inc) ? inc : (isFinite(n) && isFinite(o) ? (n - o) : NaN);
      const eff = w.eff ?? w.effective ?? w.effective_date ?? null;
      if(!isFinite(n) || !isFinite(o) || n<=0 || o<=0) return null;
      const pct = (o > 0) ? (inc2 / o * 100) : NaN;
      return { n, o, inc: isFinite(inc2) ? inc2 : null, eff: eff ? String(eff) : null, pct, source: 'json' };
    }

    function getMinWageFromJson(prefKey){
      const pd = getPrefData(prefKey);
      const fromPref = parseMinWageRecord(pd && pd.min_wage ? pd.min_wage : null);
      if(fromPref) return fromPref;

      const natMap = COST_DATA && COST_DATA.national && COST_DATA.national.min_wage_by_pref
        ? COST_DATA.national.min_wage_by_pref
        : null;
      if(!natMap) return null;
      const direct = parseMinWageRecord(natMap[prefKey]);
      if(direct) return direct;
      for(const key in natMap){
        if(normalizePrefKey(key) === prefKey){
          const normalized = parseMinWageRecord(natMap[key]);
          if(normalized) return normalized;
        }
      }
      return null;
    }

    function getMinWageFromBuiltin(prefKey){
      const w = MIN_WAGE[prefKey];
      if(!w || !isFinite(w.n) || !isFinite(w.o) || w.n<=0 || w.o<=0) return null;
      const pct = (w.o>0) ? (w.inc / w.o * 100) : NaN;
      return { n:w.n, o:w.o, inc:w.inc, eff:w.eff, pct, source:'builtin' };
    }

    function minWageInfo(prefKey){
      const fromJson = getMinWageFromJson(prefKey);
      const w = fromJson || getMinWageFromBuiltin(prefKey);
      if(!w) return null;
      return { ...w, label: PREF_LABEL[prefKey] || prefKey };
    }

    function renderMinWagePanel(){
      const key = prefSelect.value || '東京';
      const w = minWageInfo(key);

      if(w){
        const incStr = (w.inc!==null && w.inc!==undefined) ? `+${Math.round(w.inc)}円` : '—';
        minWageView.textContent =
          `${w.label}：${Math.round(w.o).toLocaleString('ja-JP')}円 → ${Math.round(w.n).toLocaleString('ja-JP')}円（${incStr}、前年度比 +${pct1(w.pct)}%）／発効予定：${fmtYMD(w.eff)}`;

        if(w.source === 'json'){
          minWageBadge.textContent = 'JSON';
          minWageBadge.className = 'badge ok';
        }else{
          minWageBadge.textContent = '内蔵';
          minWageBadge.className = 'badge';
        }
      }else{
        minWageView.textContent = '—';
        minWageBadge.textContent = '未取得';
        minWageBadge.className = 'badge err';
      }
    }

    function resolveRate(prefKey, kind){
      const pd = getPrefData(prefKey);
      const nat = COST_DATA && COST_DATA.national ? COST_DATA.national : null;

      const keyYoy = (kind==='cpi') ? 'cpi_yoy' : 'wage_yoy';
      const keyAsof = (kind==='cpi') ? 'cpi_asof' : 'wage_asof';

      if(pd && isFinite(toNum(pd[keyYoy]))){
        return { v: toNum(pd[keyYoy]), asof: pd[keyAsof] || '', scope:'pref' };
      }
      if(nat && isFinite(toNum(nat[keyYoy]))){
        return { v: toNum(nat[keyYoy]), asof: nat[keyAsof] || '', scope:'national' };
      }
      return { v: NaN, asof:'', scope:'none' };
    }

    function setScopeBadge(el, scope){
      if(scope==='pref'){
        el.textContent = '都道府県別';
        el.className = 'badge ok';
      }else if(scope==='national'){
        el.textContent = '全国値';
        el.className = 'badge warn';
      }else if(scope==='manual'){
        el.textContent = '手入力';
        el.className = 'badge';
      }else{
        el.textContent = '未設定';
        el.className = 'badge err';
      }
    }

    function applyLinkedRates(){
      const key = prefSelect.value || '東京';
      const cpi = resolveRate(key,'cpi');
      const wage = resolveRate(key,'wage');

      if(linkRates.checked){
        if(isFinite(cpi.v)){
          cpiRate.value = pct1(cpi.v);
          cpiAsOf.value = cpi.asof || '';
          cpiRate.readOnly = true; cpiAsOf.readOnly = true;
          cpiRate.dataset.origin = cpi.scope; cpiAsOf.dataset.origin = cpi.scope;
          setScopeBadge(cpiScopeBadge, cpi.scope);
        }else{
          cpiRate.readOnly = false; cpiAsOf.readOnly = false;
          cpiRate.dataset.origin = 'manual'; cpiAsOf.dataset.origin = 'manual';
          setScopeBadge(cpiScopeBadge, 'none');
        }

        if(isFinite(wage.v)){
          wageRate.value = pct1(wage.v);
          wageAsOf.value = wage.asof || '';
          wageRate.readOnly = true; wageAsOf.readOnly = true;
          wageRate.dataset.origin = wage.scope; wageAsOf.dataset.origin = wage.scope;
          setScopeBadge(wageScopeBadge, wage.scope);
        }else{
          wageRate.readOnly = false; wageAsOf.readOnly = false;
          wageRate.dataset.origin = 'manual'; wageAsOf.dataset.origin = 'manual';
          setScopeBadge(wageScopeBadge, 'none');
        }
      }else{
        cpiRate.readOnly = false; cpiAsOf.readOnly = false;
        wageRate.readOnly = false; wageAsOf.readOnly = false;
        setScopeBadge(cpiScopeBadge, 'manual');
        setScopeBadge(wageScopeBadge, 'manual');
      }
    }

    /* =========================
       6-1) 実際のCPI推移に基づく累積概算（1970年〜）
       ========================= */
    function getHistoricalCpi(year) {
      const CPI = {
        1970: 31.4, 1971: 33.3, 1972: 34.8, 1973: 38.9, 1974: 47.9,
        1975: 53.6, 1976: 58.6, 1977: 63.3, 1978: 65.7, 1979: 68.1,
        1980: 73.4, 1981: 77.0, 1982: 79.1, 1983: 80.6, 1984: 82.4,
        1985: 84.1, 1986: 84.6, 1987: 84.7, 1988: 85.3, 1989: 87.2,
        1990: 89.9, 1991: 92.8, 1992: 94.4, 1993: 95.6, 1994: 96.2,
        1995: 96.1, 1996: 96.3, 1997: 98.0, 1998: 98.6, 1999: 98.3,
        2000: 97.6, 2001: 96.8, 2002: 95.9, 2003: 95.6, 2004: 95.6,
        2005: 95.3, 2006: 95.6, 2007: 95.6, 2008: 96.9, 2009: 95.6,
        2010: 94.9, 2011: 94.6, 2012: 94.6, 2013: 95.0, 2014: 97.6,
        2015: 98.4, 2016: 98.3, 2017: 98.8, 2018: 99.8, 2019: 100.3,
        2020: 100.0, 2021: 99.8, 2022: 102.3, 2023: 105.6, 2024: 108.5,
        2025: 111.9
      };
      if (year < 1970) return CPI[1970];
      if (CPI[year]) return CPI[year];

      const maxYear = 2025;
      const baseCpi = CPI[maxYear];
      const diffYears = year - maxYear;
      const rate = toNum(cpiRate.value);
      const r = isFinite(rate) ? rate : 2.0;
      return baseCpi * Math.pow(1 + r / 100, diffYears);
    }

    function calcCpiSince(){
      const base = (currentPriceAsOf.value||'').trim();
      if(!base) return null;

      const m = base.match(/^(\d{4})-(\d{2})$/);
      if(!m) return null;

      const by = parseInt(m[1],10);
      const bm = parseInt(m[2],10) - 1;
      const now = new Date();
      const ny = now.getFullYear();
      const nm = now.getMonth();

      const months = (ny - by)*12 + (nm - bm);
      if(months <= 0) return { months: 0, cum: 0, baseCpi: 0, nowCpi: 0, by, bm, ny, nm };

      const getCpiMonthly = (y, mo) => {
        const cpi_y = getHistoricalCpi(y);
        const cpi_next_y = getHistoricalCpi(y + 1);
        return cpi_y + (cpi_next_y - cpi_y) * (mo / 12);
      };

      const baseCpi = getCpiMonthly(by, bm);
      const nowCpi = getCpiMonthly(ny, nm);

      const cum = (nowCpi / baseCpi - 1) * 100;
      return { months, cum, baseCpi, nowCpi, by, bm, ny, nm };
    }

    /* =========================
       6-2) エリア別 最低賃金の推移に基づく累積概算
       ========================= */
    function getHistoricalMinWageForPref(prefKey, year) {
      const hist = MW_HISTORY[prefKey];
      if (hist && hist[year]) return hist[year];
      if (hist && year < MW_MIN_YEAR) {
        const baseMw = hist[MW_MIN_YEAR];
        return baseMw * Math.pow(0.985, MW_MIN_YEAR - year);
      }
      if (hist && year > MW_MAX_YEAR) {
        return hist[MW_MAX_YEAR];
      }
      return null;
    }

    function calcMwSince() {
      const base = (currentPriceAsOf.value||'').trim();
      const prefKey = prefSelect.value || '東京';
      if(!base) return null;

      const m = base.match(/^(\d{4})-(\d{2})$/);
      if(!m) return null;

      const by = parseInt(m[1],10);
      const dataYear = Math.min(new Date().getFullYear(), MW_MAX_YEAR);

      const baseMw = getHistoricalMinWageForPref(prefKey, by);
      const nowMw = getHistoricalMinWageForPref(prefKey, dataYear);

      if(!baseMw || !nowMw) return { cum: 0, baseMw: 0, nowMw: 0, by, ny: dataYear, prefKey };

      const cum = (nowMw / baseMw - 1) * 100;
      return { cum: cum > 0 ? cum : 0, baseMw, nowMw, by, ny: dataYear, prefKey };
    }

    function updateCpiSinceView(){
      const x = calcCpiSince();
      const mwX = calcMwSince();
      const calcDetailBox = $('#calcDetailBox');
      const calcDetailBoxModal = $('#calcDetailBoxModal');

      if(!x || !mwX){
        cpiSinceView.innerHTML = '<span class="cumValue">物価：— ／ 最低賃金：—</span>';
        cpiSinceBadge.textContent = '任意';
        cpiSinceBadge.className = 'badge warn';
        if(calcDetailBox) calcDetailBox.innerHTML = '（年月を入力すると計算過程が表示されます）';
        return;
      }

      cpiSinceView.innerHTML = `<span class="cumValue">物価：約${pct1(x.cum)}% ／ 最低賃金：約${pct1(mwX.cum)}%</span><b>（${x.months}ヶ月）</b>`;
      cpiSinceBadge.textContent = '概算';
      cpiSinceBadge.className = 'badge warn';

      if(calcDetailBox || calcDetailBoxModal) {
        let detailHtml = `<b>【累積物価上昇率（CPI）の計算式】</b><br>`;
        detailHtml += `基準時（${x.by}年${x.bm+1}月）の推定CPI：${x.baseCpi.toFixed(2)}<br>`;
        detailHtml += `現在（${x.ny}年${x.nm+1}月）の推定CPI：${x.nowCpi.toFixed(2)}<br>`;
        detailHtml += `⇒ (${x.nowCpi.toFixed(2)} ÷ ${x.baseCpi.toFixed(2)} - 1) × 100 = <b>${x.cum.toFixed(2)}%</b><br><br>`;

        detailHtml += `<b>【累積最低賃金上昇率の計算式】</b><br>`;
        detailHtml += `対象エリア：${mwX.prefKey}<br>`;
        detailHtml += `基準年（${mwX.by}年）の最低賃金：${Math.round(mwX.baseMw)}円<br>`;
        detailHtml += `現在（${mwX.ny}年・最新データ上限${MW_MAX_YEAR}年）の最低賃金：${Math.round(mwX.nowMw)}円<br>`;
        detailHtml += `⇒ (${Math.round(mwX.nowMw)} ÷ ${Math.round(mwX.baseMw)} - 1) × 100 = <b>${mwX.cum.toFixed(2)}%</b>`;

        if(calcDetailBox) calcDetailBox.innerHTML = detailHtml;
        if(calcDetailBoxModal) calcDetailBoxModal.innerHTML = detailHtml;
      }
    }

    /* =========================
       値上げ幅の妥当性チェック
       ========================= */
    function updateRateHint(){
      const cp = toNum(currentPrice.value);
      const np = toNum(newPrice.value);
      if(isFinite(cp) && cp>0 && isFinite(np) && np>=0){
        const rate = ((np/cp)-1)*100;
        const diff = np - cp;
        rateHint.textContent = `改定率：約${pct1(rate)}% ／ 差額：${diff>=0?'+':''}${yen(diff)}`;
      }else{
        rateHint.textContent = '改定率：— ／ 差額：—';
      }
    }

    function validateBasic(){
      const prod = productName.value.trim();
      const cp = toNum(currentPrice.value);
      const np = toNum(newPrice.value);
      const customerType = getSelectedValues('#customerGroup')[0] || '';
      const efforts = getSelectedValues('#effortGroup');
      const effortFree = (effortFreeText.value || '').trim();

      let msg = '';
      if(!prod) msg = '「対象商品・サービス名」が未入力です（送付前に必ず埋めてください）。';
      if(!customerType) msg = '「顧客タイプ」は必須です。1つ選択してください。';
      if(isFinite(cp) && isFinite(np) && cp>0 && np<0) msg = '「改定後単価」に負の値が入っています。';
      if(isFinite(cp) && isFinite(np) && cp>0 && np===0) msg = '「改定後単価」が0円です。意図した入力か確認してください。';

      if(msg){
        validateMsg.style.display = 'block';
        validateMsg.textContent = msg;
      }else{
        validateMsg.style.display = 'none';
        validateMsg.textContent = '';
      }
    }

    function validatePriceIncrease() {
      const cp = toNum(currentPrice.value);
      const np = toNum(newPrice.value);

      validationWarning.style.display = 'none';
      validationWarning.textContent = '';

      if (!isFinite(cp) || !isFinite(np) || cp <= 0) return;

      const increaseRate = ((np / cp) - 1) * 100;
      if (increaseRate <= 0) return;

      const x = calcCpiSince();
      const cpiCum = x ? x.cum : 0;

      let warning = '';

      if (cpiCum > 0 && increaseRate > cpiCum * 2) {
        warning += `⚠️ 値上げ率（${pct1(increaseRate)}%）が累積物価上昇（約${pct1(cpiCum)}%）の2倍を超えています。顧客への丁寧な説明や原価データの準備をお勧めします。\n`;
      }

      if (increaseRate > 15) {
        warning += `💡 15%超の大幅な値上げは抵抗が大きい傾向があります。「段階的改定（例：今回7% → 次回更新時8%）」や「サービス条件の調整」の併案提示も有効です。`;
      }

      if (warning) {
        validationWarning.textContent = warning.trim();
        validationWarning.style.display = 'block';
      }
    }

    function renderAllByPref(){
      renderMinWagePanel();
      applyLinkedRates();
    }

    /* =========================
       8) 本文に自然に織り込む短文
       ========================= */
    function buildNaturalEvidencePhrase(){
      if(!embedNumbersInLetter.checked) return '';
      const key = prefSelect.value || '東京';

      const w = minWageInfo(key);
      const mw = w ? `最低賃金（前年度比 +${pct1(w.pct)}%）` : '';

      const p = toNum(cpiRate.value);
      const price = isFinite(p) ? `物価（前年同月比 +${pct1(p)}%）` : '';

      const h = toNum(wageRate.value);
      const labor = isFinite(h) ? `人件費（前年比 +${pct1(h)}%）` : '';

      const bits = [mw, price, labor].filter(Boolean);
      if(bits.length===0) return '';
      return `背景として、${bits.join('、')}の上昇といった外部環境の変化が重なっております。`;
    }

    function buildReferenceBlock(decidedYM){
      const key = prefSelect.value || '東京';
      const prefLabel = PREF_LABEL[key] || key;

      const lines = [];

      if(embedNumbersInLetter.checked) {
        const w = minWageInfo(key);
        if (w) lines.push(`・最低賃金（${prefLabel}）：${Math.round(w.o)}円 → ${Math.round(w.n)}円（前年度比 +${pct1(w.pct)}%、発効：${fmtYMD(w.eff)}）`);

        const p = toNum(cpiRate.value);
        const pAsOf = (cpiAsOf.value||'').trim();
        if (isFinite(p)) lines.push(`・消費者物価指数：前年同月比 +${pct1(p)}%（対象：${pAsOf || '未入力'}、出典：総務省統計局 / JILPT）`);

        const h = toNum(wageRate.value);
        const hAsOf = (wageAsOf.value||'').trim();
        if (isFinite(h)) lines.push(`・人件費上昇率（参考）：前年比 +${pct1(h)}%（対象：${hAsOf || '未入力'}）`);
      }

      const x = calcCpiSince();
      if (decidedYM && x && x.cum > 0) {
        lines.push(`・累積物価上昇率：約${pct1(x.cum)}%（現行価格決定の${decidedYM}から現在まで）`);
      }

      const mwX = calcMwSince();
      if (decidedYM && mwX && mwX.cum > 0) {
        lines.push(`・累積最低賃金上昇率：約${pct1(mwX.cum)}%（現行価格決定の${decidedYM}から現在まで、${prefLabel}）`);
      }

      if(lines.length === 0) return '';
      return `\n\n--------------------------------------------------\n※参考データ\n${lines.join('\n')}`;
    }

    /* =========================
       9) 根拠メモ（社内用）生成
       ========================= */
    function buildMemoText(){
      const key = prefSelect.value || '東京';
      const prefLabel = PREF_LABEL[key] || key;

      const prod = productName.value.trim() || '＿＿＿＿（対象商品・サービス）';
      const cp = toNum(currentPrice.value);
      const np = toNum(newPrice.value);
      const cpStr = isFinite(cp) ? yen(cp) : '＿＿＿円';
      const npStr = isFinite(np) ? yen(np) : '＿＿＿円';
      const dateStr = effectiveDate.value.trim() || '＿＿年＿＿月＿＿日';

      let rateStr = `${cpStr} → ${npStr}`;
      if(isFinite(cp) && isFinite(np) && cp>0){
        const r = ((np/cp)-1)*100;
        const sign = r >= 0 ? '増' : '減';
        rateStr = `${cpStr} → ${npStr}（約${pct1(Math.abs(r))}%${sign}）`;
      }

      const decidedYM = fmtYM(currentPriceAsOf.value);

      const clauseArr = getSelectedValues('#clauseGroup');
      const clauseType = clauseArr[0] || 'clause_unknown';
      const clauseStr = clauseType === 'clause_yes' ? 'あり（通知のみで可の可能性）' : clauseType === 'clause_no' ? 'なし（合意・協議が必須）' : '未確認（要確認）';

      const w = minWageInfo(key);
      const mwLine = w
        ? `最低賃金（${prefLabel}）：${Math.round(w.o)}円 → ${Math.round(w.n)}円（+${Math.round(w.inc)}円、前年度比 +${pct1(w.pct)}%）／発効予定：${fmtYMD(w.eff)}（${w.source==='json'?'JSON':'内蔵'}）`
        : `最低賃金（${prefLabel}）：未設定（JSON更新後に反映）`;

      const p = toNum(cpiRate.value);
      const pAsOf = (cpiAsOf.value||'').trim();
      const pScope = (cpiRate.dataset.origin==='pref') ? '都道府県別' : (cpiRate.dataset.origin==='national') ? '全国値' : (cpiRate.dataset.origin==='manual') ? '手入力' : '未設定';
      const cpiLine = isFinite(p)
        ? `CPI（消費者物価指数）参考：前年同月比 +${pct1(p)}%（${pAsOf||'対象未入力'}）／スコープ：${pScope}`
        : `CPI（消費者物価指数）参考：未設定`;

      const h = toNum(wageRate.value);
      const hAsOf = (wageAsOf.value||'').trim();
      const hScope = (wageRate.dataset.origin==='pref') ? '都道府県別' : (wageRate.dataset.origin==='national') ? '全国値' : (wageRate.dataset.origin==='manual') ? '手入力' : '未設定';
      const wageLine = isFinite(h)
        ? `人件費上昇率（参考）：前年比 +${pct1(h)}%（${hAsOf||'対象未入力'}）／スコープ：${hScope}`
        : `人件費上昇率（参考）：未設定`;

      const x = calcCpiSince();
      const cpiSinceLine = (decidedYM && x)
        ? `累積CPI（概算）：現行価格=${decidedYM}決定 → 現在まで 約${pct1(x.cum)}%（${x.months}ヶ月）`
        : `累積CPI（概算）：算出不可`;

      const mwX = calcMwSince();
      const mwSinceLine = (decidedYM && mwX)
        ? `累積最低賃金（概算）：現行価格=${decidedYM}決定 → 現在まで 約${pct1(mwX.cum)}%（${prefLabel}）`
        : `累積最低賃金（概算）：算出不可`;

      const cpiSinceHow = (decidedYM && x)
        ? `算出式（概算）：消費者物価指数およびエリア別最低賃金の過去年次推移データに基づく変動率`
        : `算出式：—`;

      const srcLine = `出典リンク（物価統計・最低賃金）：\n  ・https://www.stat.go.jp/data/cpi/sokuhou/tsuki/pdf/doukou.pdf (総務省統計局)\n  ・https://www.jil.go.jp/kokunai/statistics/timeseries/html/g0601.html (JILPT)\n  ・https://www.mhlw.go.jp/content/11200000/001571219.xlsx (厚労省)`;

      const factors = getSelectedValues('#factorGroup');
      const extra = (extraFactors.value||'').trim();
      const factorText = factors.length>0 ? joinJa(factors) : '（未選択）';
      const extraText = extra ? `補足：${extra}` : '補足：—';

      // 自助努力：価格据え置きを「約◯年」に置換
      let efforts = getSelectedValues('#effortGroup');
      const ap = approxYearsFromYM(currentPriceAsOf.value);
      if (ap && ap.years >= 0.5) {
        efforts = efforts.map(e => e === '数年間にわたる価格据え置き' ? `約${ap.yearsStr}年の価格据え置き` : e);
      }
      const effortFree = (effortFreeText.value||'').trim();
      const effortJoined = efforts.length>0 ? joinJa(efforts) : '';
      const effortText = [effortJoined, effortFree].filter(Boolean).join('／') || '（未選択）';

      const customerTypes = getSelectedValues('#customerGroup');
      const customerLabels = {
        'strategic': '戦略顧客（最重要）',
        'profitable': '優良顧客',
        'marginal': '採算ギリギリ',
        'loss': '赤字顧客'
      };
      const customerTypeStr = customerTypes.length > 0 ? customerLabels[customerTypes[0]] : '指定なし';

      const dataFreshnessNote = `\n【データ鮮度】${DATA_FRESHNESS.last_verified}時点\n- CPI: ${DATA_FRESHNESS.cpi_base}\n- 最低賃金: ${DATA_FRESHNESS.min_wage}\n※最新データは厚生労働省・総務省の公式発表を必ず確認してください。`;

      return [
        `【対象】${prod}`,
        `【改定】${rateStr} ／ 適用：${dateStr}`,
        decidedYM ? `【現行価格の決定時期】${decidedYM}` : `【現行価格の決定時期】未入力`,
        `【契約における改定条項】${clauseStr}`,
        `【顧客タイプ（戦略）】${customerTypeStr}`,
        ``,
        `■ 根拠（説明用メモ）`,
        `- ${mwLine}`,
        `- ${cpiLine}`,
        `- ${wageLine}`,
        `- ${cpiSinceLine}`,
        `- ${mwSinceLine}`,
        `  ${cpiSinceHow}`,
        `- ${srcLine}`,
        ``,
        `■ 外部環境（選択）`,
        `- ${factorText}`,
        `- ${extraText}`,
        ``,
        `■ 自助努力（選択）`,
        `- ${effortText}`,
        dataFreshnessNote
      ].join('\n');
    }

    /* =========================
       10) 本文・トーク生成
       ========================= */
    function buildLetterAndTalk(){
      const prod = productName.value.trim() || '＿＿＿＿（対象商品・サービス）';
      const cp = toNum(currentPrice.value);
      const np = toNum(newPrice.value);
      const dateStr = effectiveDate.value.trim() || '＿＿年＿＿月＿＿日';
      const decidedYM = fmtYM(currentPriceAsOf.value);
      const partnerCompanyStr = (partnerCompany && partnerCompany.value.trim()) || '〇〇株式会社';
      const partnerPersonName = (partnerPerson && partnerPerson.value.trim()) || '〇〇';
      const selectedHonorific = (partnerHonorific && partnerHonorific.value) || '様';
      const customHonorific = (partnerHonorificCustom && partnerHonorificCustom.value.trim()) || '';
      const partnerHonorificStr = selectedHonorific === 'custom' ? (customHonorific || '様') : selectedHonorific;
      const partnerPersonStr = `${partnerPersonName}${partnerHonorificStr}`;
      const ownCompanyStr = (ownCompany && ownCompany.value.trim()) || '弊社';
      const ownPersonStr = (ownPerson && ownPerson.value.trim()) || '営業担当';

      const cpStr = isFinite(cp) ? yen(cp) : '＿＿＿円';
      const npStr = isFinite(np) ? yen(np) : '＿＿＿円';

      let rateStr = `${cpStr} → ${npStr}`;
      if(isFinite(cp) && isFinite(np) && cp > 0) {
        const rate = ((np / cp) - 1) * 100;
        const sign = rate >= 0 ? '増' : '減';
        rateStr = `${cpStr} → ${npStr}（約${pct1(Math.abs(rate))}%${sign}）`;
      }

      const factors = getSelectedValues('#factorGroup');
      const extra = (extraFactors.value||'').trim();
      const factorText = factors.length > 0 ? joinJa(factors) : '原材料費・物流費・人件費等の上昇';
      const combinedFactors = extra ? `${factorText}に加え、${extra}` : factorText;

      // 自助努力：価格据え置きを「約◯年」に置換
      let efforts = getSelectedValues('#effortGroup');
      const ap = approxYearsFromYM(currentPriceAsOf.value);
      if (ap && ap.years >= 0.5) {
        efforts = efforts.map(e => e === '数年間にわたる価格据え置き' ? `約${ap.yearsStr}年の価格据え置き` : e);
      }
      const effortFree = (effortFreeText.value||'').trim();
      const effortJoined = efforts.length > 0 ? joinJa(efforts) : '';
      const effortText = [effortJoined, effortFree].filter(Boolean).join('／') || '徹底したコスト削減';

      const relation = getSelectedValues('#relationGroup')[0] || 'B';
      const customerType = getSelectedValues('#customerGroup')[0] || '';
      const customerStrategyMap = {
        strategic: '重要なお取引先として、継続供給を最優先にした協議案（段階的改定・条件調整）を前提にご相談いたします。',
        profitable: 'これまでの取引実績を踏まえ、品質維持と安定供給の両立を重視した改定案としてご相談いたします。',
        marginal: '採算の均衡を回復するため、条件見直しを含めた現実的な改定案としてご相談いたします。',
        loss: '継続提供のための最低条件として、価格改定を中心に取引条件全体の見直しをご相談いたします。'
      };
      const customerStrategy = customerStrategyMap[customerType] || '取引継続に向けた現実的な改定案としてご相談いたします。';

      const naturalEvidence = buildNaturalEvidencePhrase();
      const referenceBlock = buildReferenceBlock(decidedYM);

      let decidedLine = '';
      if (decidedYM) {
        const x = calcCpiSince();
        const mwX = calcMwSince();

        if (x && x.cum > 0 && mwX && mwX.cum > 0) {
          decidedLine = `${decidedYM}に現行価格を決定して以来、現在までの累積物価上昇率は${pct1(x.cum)}%を超えております。また、その間の最低賃金上昇率は${pct1(mwX.cum)}%を超えております。`;
        } else if (x && x.cum > 0) {
          decidedLine = `${decidedYM}に現行価格を決定して以来、現在までの累積物価上昇率は${pct1(x.cum)}%を超えております。`;
        } else if (mwX && mwX.cum > 0) {
          decidedLine = `${decidedYM}に現行価格を決定して以来、現在までの最低賃金上昇率は${pct1(mwX.cum)}%を超えております。`;
        } else {
          decidedLine = `${decidedYM}に現行価格を決定して以来、一定期間が経過しております。`;
        }
      }

      let letter = '';
      if(relation === 'A') {
        letter =
`件名：【重要】価格改定のお願い（${prod}）

${partnerCompanyStr}
${partnerPersonStr}

いつも大変お世話になっております。
${ownCompanyStr}の${ownPersonStr}でございます。

平素より格別のご高配を賜り、心より御礼申し上げます。

本日は、誠に心苦しいお願いがありご連絡いたしました。
昨今の${combinedFactors}により、当社を取り巻くコスト環境が継続的に厳しくなっております。
${naturalEvidence ? naturalEvidence : ''}

${decidedLine}
当社としても、${effortText}を重ね、品質・提供体制を維持する努力を続けてまいりましたが、現行価格のままでは安定的な提供の継続が困難な局面となりました。

つきましては、誠に恐縮ではございますが、以下のとおり価格改定をお願い申し上げます。

${customerStrategy}

【改定内容】
・対象：${prod}
・改定価格：${rateStr}
・適用時期：${dateStr}

ご負担をおかけし大変申し訳ございません。
頂戴するご負担に見合う品質・サービスを維持し、今後も継続的に貢献できるよう尽力いたします。

ご不明点やご相談がございましたら、遠慮なくお申し付けください。
何卒、諸事情をご賢察いただき、ご理解を賜りますようお願い申し上げます。${referenceBlock}`;
      } else if(relation === 'B') {
        letter =
`件名：【重要】${prod} 価格改定のお願い

${partnerCompanyStr}
${partnerPersonStr}

いつも大変お世話になっております。
${ownCompanyStr}の${ownPersonStr}でございます。

平素は弊社サービスをご利用いただき誠にありがとうございます。
さて、昨今の${combinedFactors}により、各種コストが上昇しております。
${naturalEvidence ? naturalEvidence : ''}

${decidedLine}
弊社としても、${effortText}など可能な対策を講じてまいりましたが、現行価格のままでは従来の品質および安定供給の維持が困難となりました。

つきましては、誠に不本意ではございますが、下記の通り価格改定を実施させていただきたく存じます。

${customerStrategy}

【改定内容】
・対象：${prod}
・改定価格：${rateStr}
・適用時期：${dateStr}

お客様にはご負担をおかけいたします分、より一層のサービス向上に努めてまいります。
何卒ご理解賜りますようお願い申し上げます。${referenceBlock}`;
      } else {
        letter =
`件名：【ご相談】${prod}の適正価格化（価格改定）について

${partnerCompanyStr}
${partnerPersonStr}

いつも大変お世話になっております。
${ownCompanyStr}の${ownPersonStr}でございます。

本日は、今後の継続提供の前提となる「適正価格化」について、ご相談申し上げます。
昨今の${combinedFactors}が常態化しており、当社のコスト構造にも継続的な影響が出ております。
${naturalEvidence ? naturalEvidence : ''}

${decidedLine}
当社としても、${effortText}を継続してまいりましたが、企業努力のみでコスト増を吸収し続けることが困難となりました。
このままでは『${prod}』の品質・提供体制に支障が出るリスクがあるため、避けるべきと判断しております。

つきましては、以下の目安で価格改定の協議をお願いしたく存じます。

${customerStrategy}

【お願いしたい改定内容（目安）】
・対象：${prod}
・改定価格（目安）：${rateStr}
・適用時期：${dateStr}

もし上記での全面的なご承認が難しい場合でも、
段階的改定／条件調整（ロット・契約期間・一部仕様等）を含め、双方が納得できる着地点を模索したく存じます。

近日中にお打ち合わせの機会を頂戴できますと幸いです。
何卒よろしくお願い申し上げます。${referenceBlock}`;
      }

      const ttl = (relation==='A') ? '信頼関係がある顧客向け' : (relation==='B') ? '標準の取引先向け' : '価格に厳しい顧客向け';

      const objectionHandling = `
■ 6. 想定反論への切り返し（追加パターン）

【反論1】「他社はまだ上げていない」
回答例: 「他社様の状況は存じ上げませんが、当社の原価構造では現行価格の維持が限界です。品質を落とさず提供を続けるには、適正価格への見直しが不可欠とご理解ください。」

【反論2】「そちらの都合でしょう」
回答例: 「最低賃金改定・物価上昇は公的統計でも明らかな外部環境です（資料提示）。当社だけの都合ではなく、業界全体が直面している構造的な課題です。」

【反論3】「契約期間中の変更は認められない」
回答例: 「現契約は○年○月までと承知しております。本日は次回更新時の価格についてご相談です。（または：事情変更の原則に基づき、契約期間中でも協議をお願いできればと存じます）」

【反論4】「値上げなら取引停止も検討する」
回答例: 「それは大変残念です。ただ、現行価格では赤字が続き、いずれ提供体制の維持が困難です。取引継続を前提に、段階改定や条件調整など、何か折衷案を探れませんでしょうか。」`;

      let decidedTalk = '';
      if (decidedYM) {
        const xTalk = calcCpiSince();
        const mwTalk = calcMwSince();
        if (xTalk && xTalk.cum > 0 && mwTalk && mwTalk.cum > 0) {
          decidedTalk = `「${decidedYM}に現行価格を決定して以来、現在までの累積物価上昇率は${pct1(xTalk.cum)}%を超えています。加えて、最低賃金上昇率も${pct1(mwTalk.cum)}%を超えています。」`;
        } else if (xTalk && xTalk.cum > 0) {
          decidedTalk = `「${decidedYM}に現行価格を決定して以来、現在までの累積物価上昇率は${pct1(xTalk.cum)}%を超えています。」`;
        } else if (mwTalk && mwTalk.cum > 0) {
          decidedTalk = `「${decidedYM}に現行価格を決定して以来、現在までの最低賃金上昇率は${pct1(mwTalk.cum)}%を超えています。」`;
        } else {
          decidedTalk = `「${decidedYM}に現行価格を決定して以来、一定期間が経過しています。」`;
        }
      }

      const talk =
`【${ttl} 面談トーク】

■ 1. 冒頭（状況共有）
「本日はお時間をいただきありがとうございます。実は本日、少し心苦しいご相談がございます。
昨今の${combinedFactors}の影響が弊社にも及び、コスト環境が厳しい状況です。」

■ 2. 根拠の提示（短く・自然に）
${naturalEvidence ? `「${naturalEvidence}」` : '「外部環境の変化が続いています。」'}
${decidedTalk}

■ 3. 自助努力の提示と限界
「もちろん御社にご迷惑をおかけできないと、${effortText}を続けてきましたが、
社内努力だけでは吸収できない水準になりました。」

■ 4. 顧客タイプ別の進め方
「${customerStrategy}」

■ 5. 結論（改定の打診）
「このままですと『${prod}』の品質維持や提供体制に支障が出る恐れがあります。
つきましては、${dateStr}より、【 ${rateStr} 】への見直しをご相談できないでしょうか。」
${objectionHandling}

■ 7. クロージング（次アクション）
「本日いただいたご意見を踏まえ、着地点案（段階改定／条件調整等）を整理して改めてご提案します。」`;

      return { letter, talk };
    }

    let CACHE = { letter:'', talk:'', memo:'' };

    function renderOutput(){
      if(currentOutputMode === 'letter') outputArea.value = CACHE.letter || '';
      else if(currentOutputMode === 'talk') outputArea.value = CACHE.talk || '';
      else outputArea.value = CACHE.memo || '';
    }

    function generate(){
      try {
        updateRateHint();
        validateBasic();
        validatePriceIncrease();
        updateCpiSinceView();

        const lt = buildLetterAndTalk();
        const memo = buildMemoText();

        CACHE.letter = lt.letter;
        CACHE.talk = lt.talk;
        CACHE.memo = memo;

        renderOutput();

        if(printLetter) printLetter.textContent = CACHE.letter || '';
        if(printTalkMemo) printTalkMemo.textContent = `${CACHE.talk || ''}\n\n----------------------------------------\n\n${CACHE.memo || ''}`;
      } catch (err) {
        console.error(err);
        if(outputArea) outputArea.value = '※文面生成中にエラーが発生しました。\n' + err.message;
      }
    }

    function openExternalFactorsModal(){
      if(!externalFactorsModal) return;
      externalFactorsModal.classList.add('show');
      externalFactorsModal.setAttribute('aria-hidden','false');
    }

    function closeExternalFactorsModal(){
      if(!externalFactorsModal) return;
      externalFactorsModal.classList.remove('show');
      externalFactorsModal.setAttribute('aria-hidden','true');
    }

    function syncHonorificInput(){
      if(!partnerHonorificCustom || !partnerHonorific) return;
      const useCustom = partnerHonorific.value === 'custom';
      partnerHonorificCustom.style.display = useCustom ? 'block' : 'none';
      if(!useCustom) partnerHonorificCustom.value = '';
    }

    function showCopied(){
      copyStatus.classList.add('show');
      clearTimeout(showCopied._t);
      showCopied._t = setTimeout(() => copyStatus.classList.remove('show'), 2000);
    }

    async function copyText(text){
      if(navigator.clipboard && window.isSecureContext){
        try{ await navigator.clipboard.writeText(text); return true; }catch(e){}
      }
      try{
        outputArea.removeAttribute('readonly');
        outputArea.select();
        outputArea.setSelectionRange(0, outputArea.value.length);
        const ok = document.execCommand('copy');
        outputArea.setAttribute('readonly','');
        window.getSelection().removeAllRanges();
        return !!ok;
      }catch(e){
        try{ outputArea.setAttribute('readonly',''); }catch(_){}
        return false;
      }
    }

    copyBtn.addEventListener('click', async () => {
      const ok = await copyText(outputArea.value || '');
      if(ok) showCopied();
    });

    printBtn.addEventListener('click', () => { try{ window.print(); }catch(e){} });

    [partnerCompany, partnerPerson, partnerHonorific, partnerHonorificCustom, ownCompany, ownPerson,
     productName, currentPriceAsOf, effectiveDate, extraFactors, effortFreeText,
     embedNumbersInLetter, linkRates, cpiRate, wageRate, cpiAsOf, wageAsOf]
      .forEach(el => el.addEventListener('input', generate));

    if(openExternalFactorsBtn) openExternalFactorsBtn.addEventListener('click', openExternalFactorsModal);
    if(openExternalFactorsBtn2) openExternalFactorsBtn2.addEventListener('click', openExternalFactorsModal);
    if(closeExternalFactorsBtn) closeExternalFactorsBtn.addEventListener('click', closeExternalFactorsModal);
    if(closeExternalFactorsX) closeExternalFactorsX.addEventListener('click', closeExternalFactorsModal);
    if(externalFactorsModal) externalFactorsModal.addEventListener('click', (e)=>{
      if(e.target === externalFactorsModal) closeExternalFactorsModal();
    });
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape' && externalFactorsModal && externalFactorsModal.classList.contains('show')) closeExternalFactorsModal();
    });
    if(partnerHonorific) partnerHonorific.addEventListener('change', () => { syncHonorificInput(); generate(); });

    linkRates.addEventListener('change', ()=>{
      renderAllByPref();
      generate();
    });

    prefSelect.addEventListener('change', () => {
      setLocal('mk_pref_key', prefSelect.value);
      renderAllByPref();
      generate();
    });

    if(loadDataBtn) loadDataBtn.addEventListener('click', () => loadCostData(dataUrl.value, false));
    if(clearDataBtn) clearDataBtn.addEventListener('click', () => clearCostData());

    function getUrlParams(){
      const params = new URLSearchParams(window.location.search);
      let hasParam = false;

      const p = params.get('price') || params.get('P');
      if(p && isFinite(toNum(p))){
        currentPrice.value = Math.round(toNum(p)).toLocaleString('ja-JP');
        markImported(currentPrice);
        hasParam = true;
      }
      const p2 = params.get('P2') || params.get('chgAbs');
      if(p2 && isFinite(toNum(p2))){
        newPrice.value = Math.round(toNum(p2)).toLocaleString('ja-JP');
        markImported(newPrice);
        hasParam = true;
      }

      const prod = params.get('product') || params.get('prod');
      if(prod){
        productName.value = String(prod);
        markImported(productName);
        hasParam = true;
      }
      const dt = params.get('date') || params.get('effectiveDate');
      if(dt){
        effectiveDate.value = String(dt);
        markImported(effectiveDate);
        hasParam = true;
      }

      const pref = params.get('pref');
      if(pref){
        const k = normalizePrefKey(pref);
        if(PREF_LABEL[k]){
          prefSelect.value = k;
          markImported(prefSelect);
          hasParam = true;
        }
      }

      if(hasParam){
        showImportStatus('✅ 転記：URLパラメータから値を取り込みました。');
      }
      return hasParam;
    }

    function resetChips(groupId){
      const g = $(groupId);
      if(!g) return;
      const chips = Array.from(g.querySelectorAll('.chip'));
      chips.forEach(c=>c.classList.remove('active'));
      if(groupId==='#clauseGroup'){
        const c = chips.find(x=>x.getAttribute('data-val')==='clause_unknown');
        if(c) c.classList.add('active');
        return;
      }
      if(groupId==='#relationGroup'){
        const b = chips.find(x=>x.getAttribute('data-val')==='B');
        if(b) b.classList.add('active');
        return;
      }
      if(groupId==='#effortGroup'){
        chips.filter(x=>['徹底した経費削減','数年間にわたる価格据え置き'].includes(x.getAttribute('data-val'))).forEach(x=>x.classList.add('active'));
        return;
      }
      if(groupId==='#factorGroup'){
        chips.filter(x=>['原材料・仕入コストの上昇','人件費（賃上げ・採用難）による負担増'].includes(x.getAttribute('data-val'))).forEach(x=>x.classList.add('active'));
        return;
      }
    }

    resetBtn.addEventListener('click', () => {
      [partnerCompany,partnerPerson,partnerHonorificCustom,ownCompany,ownPerson,productName,currentPrice,newPrice,currentPriceAsOf,effectiveDate,extraFactors,effortFreeText].forEach(el=>{
        el.value='';
        el.classList.remove('imported-value');
      });
      closeExternalFactorsModal();

      if(partnerHonorific) partnerHonorific.value = '様';

      if(partnerHonorific) partnerHonorific.value = '様';

      if(partnerHonorific) partnerHonorific.value = '様';

      embedNumbersInLetter.checked = true;
      linkRates.checked = true;

      validationWarning.style.display = 'none';

      resetChips('#clauseGroup');
      resetChips('#factorGroup');
      resetChips('#effortGroup');
      resetChips('#relationGroup');
      resetChips('#customerGroup');

      prefSelect.value = '東京';
      setLocal('mk_pref_key','東京');

      renderAllByPref();
      generate();
    });

    try{
      $('#cpy-year').textContent = String(new Date().getFullYear());
      const ld = new Date(document.lastModified);
      const ymd = isNaN(ld.getTime()) ? '' : `${ld.getFullYear()}-${z2(ld.getMonth()+1)}-${z2(ld.getDate())}`;
      $('#last-updated-date').textContent = ymd;
    }catch(e){}

    try{
      if(jsonSample) jsonSample.textContent = JSON.stringify(SAMPLE_JSON, null, 2);
    }catch(e){}

    function setHelp(txt){ helpBox.textContent = txt || ''; }
    if(helpCpi) helpCpi.addEventListener('click', ()=>{
      setHelp('物価上昇率は、公的統計（CPI=消費者物価指数など）を参考に「物価がどの程度上がっているか」を示す目的で置いています。本文では専門用語を避け、「公的統計では物価が…」の表現に置換しています。');
    });
    if(helpWage) helpWage.addEventListener('click', ()=>{
      setHelp('人件費上昇率は、賃上げ率だけでなく採用難（求人条件の上振れ）・外注単価上昇なども含む「実務の負担増」を説明するための参考値です。可能なら自社の採用単価や求人条件の変化を補足欄に一文入れると強いです。');
    });
    if(helpScope) helpScope.addEventListener('click', ()=>{
      setHelp('物価/賃金の都道府県別データが常に揃うとは限りません。本ツールは「都道府県別がJSONにあればそれを使用、無ければ全国値（参考）」の設計です。画面のバッジでスコープを明示します。');
    });

    buildPrefOptions();

    const savedPref = getLocal('mk_pref_key');
    if(savedPref && PREF_LABEL[savedPref]) prefSelect.value = savedPref;
    else prefSelect.value = '東京';

    const savedUrl = getLocal('mk_cost_data_url');
    if(dataUrl && savedUrl) dataUrl.value = savedUrl;

    loadCostData(savedUrl || './pref_cost_data.json', true);

    renderAllByPref();
    getUrlParams();
    syncHonorificInput();

    generate();

  })();
  </script>

  <script src="https://takatrp.github.io/tool-portal/mk-nav.js" defer></script>
</body>
</html>
